<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Психомост: Забытые Воспоминания</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Основные стили для body и game-container */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e; /* Темный фон */
            color: #e0e0e0; /* Светлый текст */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
        }
        .game-container {
            background-color: #16213e; /* Немного светлее темный фон для контейнера */
            border-radius: 1.5rem; /* Скругленные углы */
            padding: 2rem;
            max-width: 900px;
            width: 100%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            transition: background-color 1s ease-in-out, background-image 1s ease-in-out; /* Плавный переход для фонов */
            overflow: hidden; /* Обрезает содержимое, выходящее за границы, для эффектов */
            position: relative; /* Для позиционирования псевдоэлементов/слоев */
        }

        /* Анимации фонов */
        @keyframes pulse-red {
            0% { box-shadow: 0 0 15px rgba(255, 0, 0, 0.3); }
            50% { box-shadow: 0 0 30px rgba(255, 0, 0, 0.6); }
            100% { box-shadow: 0 0 15px rgba(255, 0, 0, 0.3); }
        }

        @keyframes digital-flow {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 100%; }
        }

        @keyframes subtle-glow {
            0% { filter: brightness(1); }
            50% { filter: brightness(1.1); }
            100% { filter: brightness(1); }
        }

        /* Классы фонов для разных сцен */
        .bg-prologue {
            background-color: #0d0d1a;
            animation: pulse-red 2s infinite alternate;
        }

        .bg-nova-lab {
            background: linear-gradient(135deg, #16213e, #0f3460);
            position: relative;
            z-index: 1;
        }
        .bg-nova-lab::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: linear-gradient(0deg, transparent 50%, rgba(25, 255, 255, 0.05) 50%),
                               linear-gradient(90deg, transparent 50%, rgba(25, 255, 255, 0.05) 50%);
            background-size: 20px 20px;
            z-index: -1;
            opacity: 0.2;
            animation: digital-flow 100s linear infinite;
        }

        .bg-megapolis {
            background: linear-gradient(45deg, #1a1a2e, #0d1226);
            position: relative;
            z-index: 1;
        }
        .bg-megapolis::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: radial-gradient(circle at bottom right, rgba(0, 200, 255, 0.1), transparent 50%),
                               radial-gradient(circle at top left, rgba(255, 100, 0, 0.08), transparent 50%);
            background-size: 100% 100%;
            animation: subtle-glow 8s infinite alternate;
            z-index: -1;
        }

        .bg-psychobridge {
            background: linear-gradient(180deg, #0f3460, #16213e);
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        .bg-psychobridge::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 10 10"><circle cx="5" cy="5" r="1" fill="%23e94560" opacity="0.5"/></svg>'); /* Маленькие пульсирующие точки */
            background-size: 20px 20px;
            animation: digital-flow 30s linear infinite;
            z-index: -1;
            opacity: 0.3;
        }
        .bg-psychobridge::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(233, 69, 96, 0.1) 10%, transparent 80%);
            animation: pulse-red 4s infinite alternate;
            z-index: -1;
        }

        .bg-climax {
            background: linear-gradient(180deg, #2a0000, #0a0a0a);
            animation: pulse-red 1s infinite alternate; /* Более агрессивное пульсирование */
            position: relative;
            z-index: 1;
        }
        .bg-climax::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><line x1="0" y1="0" x2="100" y2="100" stroke="%23ff0000" stroke-width="1" opacity="0.3"/><line x1="100" y1="0" x2="0" y2="100" stroke="%23ff0000" stroke-width="1" opacity="0.3"/></svg>'); /* Сетка из красных линий */
            background-size: 50px 50px;
            z-index: -1;
            animation: digital-flow 5s linear infinite;
        }

        /* Стиль для кнопок характеристик */
        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #b0b0b0;
            flex-grow: 1; /* Позволяет элементам расти и занимать доступное пространство */
            min-width: 120px; /* Минимальная ширина для мобильных */
            justify-content: center; /* Центрирование содержимого */
            position: relative; /* Для позиционирования всплывающих изменений */
        }
        .stat-value {
            font-weight: bold;
            color: #e94560; /* Акцентный цвет */
        }

        /* Стили для прогресс-баров характеристик */
        .progress-bar-container {
            width: 60px; /* Ширина полоски */
            height: 8px; /* Высота полоски */
            background-color: #3b3b4d;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        .progress-bar-fill {
            height: 100%;
            background-color: #e94560; /* Цвет заполнения */
            width: 0%; /* Изначально 0% */
            transition: width 0.5s ease-out; /* Плавное изменение ширины */
            border-radius: 4px;
        }
        /* Дополнительные цвета для репутаций */
        .progress-bar-fill.rep-nova-lab { background-color: #00bcd4; } /* Cyan */
        .progress-bar-fill.rep-ghosts { background-color: #9c27b0; } /* Purple */
        .progress-bar-fill.rep-rafi { background-color: #ff9800; } /* Orange */

        /* Стили для всплывающих изменений характеристик */
        .stat-change-feedback {
            position: absolute;
            top: -15px; /* Выше стата */
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.9rem;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
            pointer-events: none; /* Не блокирует клики */
        }
        .stat-change-feedback.show {
            opacity: 1;
            transform: translateX(-50%) translateY(-10px); /* Анимация вверх */
        }
        .stat-change-feedback.increase {
            color: #4CAF50; /* Зеленый для увеличения */
        }
        .stat-change-feedback.decrease {
            color: #e94560; /* Красный для уменьшения */
        }

        /* Стили для кнопок выбора */
        .choice-button {
            background-color: #0f3460; /* Синевато-серый цвет кнопки */
            color: #ffffff;
            padding: 0.75rem 1.25rem;
            border-radius: 0.75rem;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: pointer;
            font-size: 1rem;
            text-align: left;
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        .choice-button:hover {
            background-color: #1a4f8a;
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
        }
        .choice-button:active {
            background-color: #0c2d54;
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .choice-button:disabled {
            background-color: #3b3b4d;
            cursor: not-allowed;
            opacity: 0.7;
        }
        /* Стили для контейнера мини-игр */
        .mini-game-container {
            background-color: #0f3460;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-top: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: center;
        }
        /* Стили для Canvas */
        canvas {
            background-color: #2e2e4a;
            border-radius: 0.75rem;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.3);
            width: 100%; /* Делаем canvas адаптивным */
            max-width: 600px; /* Максимальная ширина для консистентности */
            height: 400px; /* Фиксированная высота для canvas, соотношение сторон поддерживается JS */
        }
        /* Стили для Memory Hack мини-игры */
        .memory-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }
        .memory-card {
            background-color: #2e2e4a;
            height: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.5rem; /* Больший размер шрифта для эмодзи */
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s;
            color: transparent; /* Изначально скрываем эмодзи */
            user-select: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            perspective: 1000px; /* Для 3D-эффекта переворота */
        }
        .memory-card .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .memory-card.flipped .card-inner {
            transform: rotateY(180deg);
        }
        .memory-card .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 8px;
        }
        .memory-card .card-front {
            background-color: #2e2e4a;
            color: transparent;
        }
        .memory-card .card-back {
            background-color: #3f6fa0;
            color: #ffffff;
            transform: rotateY(180deg);
        }
        .memory-card.matched .card-back {
            background-color: #4CAF50; /* Зеленый для совпадений */
            color: #ffffff;
            cursor: default;
        }
        /* Стили для Decryptor мини-игры */
        .decryptor-input-group {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            flex-wrap: wrap; /* Разрешить перенос для маленьких экранов */
            justify-content: center;
        }
        .decryptor-input {
            width: 40px;
            height: 40px;
            text-align: center;
            font-size: 1.2rem;
            border-radius: 8px;
            border: 1px solid #4a4a66;
            background-color: #1a1a2e;
            color: #ffffff;
            outline: none;
        }
        .decryptor-button {
            background-color: #e94560;
            color: white;
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s;
        }
        .decryptor-button:hover {
            background-color: #ff6f88;
        }
        /* Стили для Energy Flow мини-игры */
        .energy-node {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .energy-input {
            width: 80px;
            padding: 0.5rem;
            font-size: 1.1rem;
            text-align: center;
            border-radius: 0.5rem;
            border: 1px solid #4a4a66;
            background-color: #1a1a2e;
            color: #ffffff;
            outline: none;
        }
        .energy-buttons button {
            background-color: #0f3460;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            border: none;
            margin: 0 0.25rem;
            transition: background-color 0.2s;
        }
        .energy-buttons button:hover {
            background-color: #1a4f8a;
        }
        /* Стили для кнопок сохранения/загрузки */
        .save-load-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap; /* Для адаптации на мобильных */
        }
        .save-load-button {
            background-color: #4CAF50; /* Зеленый для сохранения/загрузки */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        .save-load-button:hover {
            background-color: #6bc071;
            transform: translateY(-2px);
        }

        /* Классы для эффекта перехода */
        .scene-transition-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: black;
            opacity: 0;
            transition: opacity 0.8s ease-in-out; /* Время перехода */
            z-index: 100; /* Поверх всего */
            pointer-events: none; /* Не блокирует клики */
        }
        .scene-transition-overlay.fade-out {
            opacity: 1;
        }
        .scene-transition-overlay.fade-in {
            opacity: 0;
        }

        /* Стили для модального окна журнала */
        .modal { /* Base style for all modals */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            padding: 1rem;
        }
        .modal-content {
            background-color: #16213e;
            border-radius: 1.5rem;
            padding: 2rem;
            max-width: 700px;
            width: 100%;
            height: 80vh;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.6);
            display: flex;
            flex-direction: column;
            gap: 1rem;
            overflow-y: auto;
        }
        .modal-close-button {
            background-color: #e94560;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s ease-in-out;
            align-self: flex-end;
        }
        .modal-close-button:hover {
            background-color: #ff6f88;
        }
        .journal-entry {
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px dashed #3b3b4d;
        }
        .journal-entry:last-child {
            border-bottom: none;
        }
        .journal-entry h4 {
            font-weight: bold;
            color: #00bcd4;
            margin-bottom: 0.5rem;
        }

        /* Specific styles for save/load modal */
        .save-load-slot {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #0f3460;
            padding: 0.75rem 1.25rem;
            border-radius: 0.75rem;
            margin-bottom: 0.5rem;
            flex-wrap: wrap; /* Allow wrapping on small screens */
            gap: 0.5rem;
        }
        .save-load-slot-info {
            flex-grow: 1;
        }
        .save-load-slot-buttons button {
            background-color: #4CAF50;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s ease-in-out;
            margin-left: 0.5rem;
        }
        .save-load-slot-buttons button.load {
            background-color: #00bcd4;
        }
        .save-load-slot-buttons button:hover {
            filter: brightness(1.2);
        }
        .save-load-slot-buttons button:disabled {
            background-color: #3b3b4d;
            cursor: not-allowed;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div id="game-container" class="game-container bg-prologue">
        <h1 class="text-3xl font-bold text-center text-red-400 mb-4">Психомост: Забытые Воспоминания</h1>

        <div class="flex flex-wrap justify-center gap-4 mb-4">
            <div class="stat-item">
                <span class="font-bold">Логика:</span> <span id="logic-stat" class="stat-value">0</span>
                <div class="progress-bar-container"><div id="logic-bar" class="progress-bar-fill"></div></div>
                <div id="logic-feedback" class="stat-change-feedback"></div>
            </div>
            <div class="stat-item">
                <span class="font-bold">Эмпатия:</span> <span id="empathy-stat" class="stat-value">0</span>
                <div class="progress-bar-container"><div id="empathy-bar" class="progress-bar-fill"></div></div>
                <div id="empathy-feedback" class="stat-change-feedback"></div>
            </div>
            <div class="stat-item">
                <span class="font-bold">Синхронизация:</span> <span id="sync-stat" class="stat-value">0</span>
                <div class="progress-bar-container"><div id="sync-bar" class="progress-bar-fill"></div></div>
                <div id="sync-feedback" class="stat-change-feedback"></div>
            </div>
            <div class="stat-item">
                <span class="font-bold">Репутация Нова Лаб:</span> <span id="nova-lab-rep-stat" class="stat-value">0</span>
                <div class="progress-bar-container"><div id="nova-lab-rep-bar" class="progress-bar-fill rep-nova-lab"></div></div>
                <div id="nova-lab-rep-feedback" class="stat-change-feedback"></div>
            </div>
            <div class="stat-item">
                <span class="font-bold">Репутация Призраков:</span> <span id="ghosts-rep-stat" class="stat-value">0</span>
                <div class="progress-bar-container"><div id="ghosts-rep-bar" class="progress-bar-fill rep-ghosts"></div></div>
                <div id="ghosts-rep-feedback" class="stat-change-feedback"></div>
            </div>
            <div class="stat-item">
                <span class="font-bold">Репутация Рафи:</span> <span id="rafi-rep-stat" class="stat-value">0</span>
                <div class="progress-bar-container"><div id="rafi-rep-bar" class="progress-bar-fill rep-rafi"></div></div>
                <div id="rafi-rep-feedback" class="stat-change-feedback"></div>
            </div>
        </div>

        <div class="save-load-buttons">
            <button id="save-game-button" class="save-load-button">Сохранить игру 💾</button>
            <button id="load-game-button" class="save-load-button">Загрузить игру 📂</button>
            <button id="open-journal-button" class="save-load-button">Журнал 📔</button>
        </div>

        <div id="narrative-text" class="text-lg mb-6 leading-relaxed text-gray-300">
        </div>

        <div id="choices-container" class="flex flex-col gap-3">
        </div>

        <div id="mini-game-section" class="mini-game-container hidden">
            <h3 id="mini-game-title" class="text-2xl font-bold text-red-300 mb-3"></h3>
            <div id="mini-game-content" class="w-full">
            </div>
            <button id="mini-game-submit" class="decryptor-button hidden">Завершить</button>
            <p id="mini-game-message" class="text-red-300"></p>
        </div>

        <div id="transition-overlay" class="scene-transition-overlay"></div>

        <div id="journal-modal" class="modal hidden">
            <div class="modal-content">
                <h2 class="text-3xl font-bold text-center text-red-400 mb-4">Журнал Воспоминаний</h2>
                <div id="journal-entries" class="text-left">
                </div>
                <button id="journal-close-button" class="modal-close-button">Закрыть</button>
            </div>
        </div>

        <div id="save-load-modal" class="modal hidden">
            <div class="modal-content">
                <h2 class="text-3xl font-bold text-center text-red-400 mb-4">Сохранение / Загрузка Игры</h2>
                <div id="save-load-slots-container" class="flex flex-col gap-2">
                </div>
                <button id="save-load-close-button" class="modal-close-button">Закрыть</button>
            </div>
        </div>
    </div>
    <script>
        // /////////////// ИГРОВЫЕ ДАННЫЕ (gameData) ///////////////
        // Этот объект содержит всю структуру вашей игры: сцены, текст, выборы, эффекты, мини-игры.
        const gameData = {
            prologue: {
                text: `
                    Скрип, рвущий тишину. Высокочастотный писк, проникающий в самый мозг. И глухой, утробный металлический лязг, эхом разносящийся по бесконечному, стерильному коридору "Нова Лаб". Воздух здесь не просто тяжел, он сгустился от запаха озона – ядовитой чистоты, предвестника шторма – и древнего, первобытного страха, который, казалось, впитался в сам хром стен. Маленькая детская фигурка, едва различимая в мерцающем полумраке, движется медленно, словно во сне, отчаянно цепляясь за реальность, касаясь холодных, полированных поверхностей пальцами. Каждый шаг – это борьба с гравитацией, с нарастающей паникой. За углом вспыхивает не просто алый свет, а пульсирующее, агрессивное багровое зарево, предвещая неминуемую катастрофу. Сигнализация. Ритмичный, нарастающий пульс, заставляющий каждый нерв натягиваться до предела, словно струна перед разрывом, предвещая боль. Красные вспышки озаряют мерцающие потолочные панели, отражаясь в непроницаемых стеклянных поверхностях, за которыми скрывается нечто, не предназначенное для человеческих глаз – тайна, способная изменить не только судьбы, но и само определение человечности. 🚨
                    <br><br>
                    «Стабильность протокола утрачена… Повторяю, стабильность протокола утрачена… Активация протокола “Очистка 01”. Запуск экстренного отключения систем…» – голос, искаженный статикой и паническими обрывками данных, прорезает нарастающий вой сирены, как нож сквозь плоть, оставляя за собой жгучий след. Ребенок спотыкается, его легкие горят от панического, бессмысленного бега. Он падает, ударяясь о холодный пол. 💥 Темнота. Не просто отсутствие света, а оглушительная, поглощающая всё, всепоглощающая пустота, оставляющая лишь фантомную боль в висках и вопросы без ответов, которые будут преследовать его долгие годы. Воспоминание, или его критический фрагмент, исчезает, словно вырванная страница из книги жизни, оставив после себя лишь холодное, необъяснимое чувство потери. 💔
                `,
                choices: [
                    { text: "Проснуться... 😴", nextScene: 'identification' }
                ],
                background: 'bg-prologue'
            },
            identification: {
                text: `
                    Системный голос, лишенный всякой интонации, но с холодной, неумолимой настойчивостью, раздается в пустоте, проникая прямо в сознание, минуя любые барьеры. "Обнаружен неидентифицированный агент. Пожалуйста, подтвердите ваше имя для синхронизации с протоколом." Это пробуждение было не мягким, а резким, словно удар по натянутой струне, что внезапно обрывается. Ощущение дежавю, мимолетное воспоминание о холоде, страхе и ощущении полета в бездну, промелькнуло, прежде чем его поглотила пустота небытия. Кто я? Зачем я здесь? Что со мной произошло? ❓ Эти вопросы роились в голове, требуя немедленного, жизненно важного ответа. Система ждет, ее молчание давит.
                    <br><br>
                    "Мое имя... оно кажется чужим, словно навязанным. Будто я выбираю его из тысяч возможных вариантов, но ни один из них не ощущается моим до конца. Или это просто обрывок воспоминаний, который отказывается всплывать? Йона. Почему это имя? Оно кажется... подходящим. Или это просто иллюзия, созданная системой?" 🤔
                `,
                choices: [
                    { text: "Назвать имя: Йона 👤", nextScene: 'meeting-yona' }
                ],
                background: 'bg-nova-lab',
                unlockJournal: ['initial_entry']
            },
            'meeting-yona': {
                text: `
                    Йона, программист-анализатор воспоминаний в "Нова Лаб", смотрел на голографический вид мегаполиса, раскинувшегося под ним. Это был не просто город, а живой организм, бесконечные башни из стекла и стали пронзали загрязненное, но мерцающее неоновыми огнями небо, символизируя как неограниченный прогресс человечества, так и скрытую гниль его амбиций. 🏙️ Ему было двадцать восемь, и каждый день казался продолжением одной и той же серой, бесконечной ленты, унылой и предсказуемой. Темные волосы, всегда немного растрепанные, падали на уставшие глаза, в которых давно угас блеск надежды, сменившись лишь холодным, расчетливым взглядом аналитика. ired Работа была единственным смыслом его существования после того, как три года назад он потерял близкого человека в аварии, которую никто не смог объяснить, не смог осмыслить – и это необъяснимость, эта пустота в памяти, преследовала его больше всего. Воспоминания о том дне были как битое стекло в его собственном сознании — острые, беспорядочные и причиняющие невыносимую, фантомную боль, которую не могли заглушить даже самые мощные нейро-стабилизаторы. 💔 Он пришел в «Нова Лаб» не просто за кодом или рутинными задачами. Он искал ответы, одержимый идеей, возможно, даже способ исправить то, что было сломано в его жизни и в его душе.
                    <br><br>
                    Сегодня был его первый день в "Нова Лаб" — монументальной цитадели технологического прогресса и скрытых секретов, парящей над городом, словно хищный птица. Здание казалось нереальным, словно вырезанным из платины и вставленным в самое сердце города, неприступным и величественным. 🏢 Внутри было так же стерильно и футуристично, как и снаружи, каждый уголок отполирован до блеска, отражая холодный, голубоватый свет, который, казалось, вытягивал все живые цвета. Его встретил Йер – искусственный интеллект-ассистент, чья голограмма проецировалась в центре вестибюля, мерцая, словно пульсирующая звезда. ✨ Изящная, андрогинная фигура, светящаяся мягким голубым светом, с мягким, но абсолютно безэмоциональным голосом, который, несмотря на свою "человечность", казался пугающе чужим. "Добро пожаловать, Йона," – произнес Йер, его голос был совершенен, но лишен тепла. – "Я ваш персональный ассистент. Мое имя Йер. Я буду сопровождать вас на протяжении всего ознакомительного тура."
                `,
                choices: [
                    { text: "Начать ознакомительный тур 🚶‍♂️", nextScene: 'tour-with-yer' }
                ],
                background: 'bg-nova-lab',
                unlockJournal: ['nova_lab_intro']
            },
            'tour-with-yer': {
                text: `
                    Тур был впечатляющим, но оставил в душе Йоны странное, гнетущее чувство, словно он присутствовал на чьих-то похоронах. 😔 Йер провел его через футуристические лаборатории, где мерцали приборы, словно живые сущности, через «Библиотеку Сознания» – огромное хранилище, где на полках из синего света хранились терабайты человеческих воспоминаний, целые жизни, оцифрованные и каталогизированные, лишенные тепла и плоти. 🧠 Наконец, они пришли в «Капсулу Грез» – помещение, где располагались основные блоки «Психомоста». Именно здесь люди подключались к чужим сознаниям, погружаясь в их прошлое, словно в чужие, навязанные сны. Йона чувствовал легкое головокружение, представляя себе этот процесс – вторжение в самые сокровенные уголки чужого "я". 🤯
                    <br><br>
                    "Это доктор Ния Хардан," – объявил Йер, когда они вошли в основной операционный зал, где воздух был пропитан напряжением и озоном, а тонкий запах медикаментов смешивался с запахом раскаленного металла. – "Руководитель нейрофизиологической группы." Ния Хардан, женщина лет сорока пяти с резкими, умными чертами лица и проницательным взглядом, который, казалось, видел насквозь, кивнула Йоне. Ее глаза, оттенка стали, казалось, читали его мысли. 👀 "Рада познакомиться, Йона. Надеюсь, Йер не утомил вас своими бесконечными данными. Я доктор Хардан. Моя команда отвечает за безопасность протокола. И за то, чтобы «Психомост» не сжег вам мозги," – она слабо, почти незаметно улыбнулась, и эта улыбка не дошла до ее глаз. В ее глазах Йона уловил что-то большее, чем просто научный интерес или профессионализм – некое сомнение, едва уловимое беспокойство, тень тайны, которая могла бы привести к катастрофе, и которая, возможно, уже началась. 🤫
                `,
                choices: [
                    { text: "Приступить к первой сессии ➡️", nextScene: 'first-session' }
                ],
                background: 'bg-psychobridge'
            },
            'first-session': {
                text: `
                    Йона занял свое место перед консолью, ощущая холод металла сквозь тонкую ткань перчаток. Перед ним в прозрачной капсуле, залитой мягким, пульсирующим светом, лежал испытуемый – бывший солдат по имени Олег, с бледным, изможденным лицом и глубоким шрамом над бровью, свидетельством пережитых ужасов войны. 🤕 Его память была фрагментарной после боевой травмы, словно разбитое зеркало, и «Психомост» был последней надеждой на ее восстановление, последним шансом Олега вернуться к подобию нормальной жизни. "Цель первой сессии – извлечь ключевые воспоминания о событиях на передовой, которые привели к его травме и потере памяти," – объяснил Йер своим ровным, безэмоциональным голосом. – "Согласно протоколу, у вас есть два варианта действия, Йона. Выбор за вами, как всегда."
                    <br><br>
                    На экране консоли появились два всплывающих окна, каждое из которых предлагало свой путь, свою цену, свою моральную дилемму. ⚖️
                `,
                choices: [
                    {
                        text: "Вариант A: Полное извлечение воспоминаний (Рискованно). Йона ощущает жгучее желание узнать все. Его личная трагедия, необъяснимая потеря брата, подталкивает его к максимальному раскрытию правды, даже если это означает риск для другого. 🔥",
                        effects: { logic: 1, empathy: -1 },
                        narrativeEffect: "На мгновение, когда протокол активации завершился, Йона почувствовал краткий, пронзительный всплеск чужой боли, чужого ужаса, который быстро оборвался. Что-то едва уловимое, словно шепот ветра в пустом коридоре, мелькнуло в его сознании, прежде чем раствориться. 👻",
                        nextScene: 'memory-hack'
                    },
                    {
                        text: "Вариант B: Ограниченный просмотр (Безопасно). Йона смотрит на Олега, видя его страдания, и вспоминает свою собственную боль. Чувство ответственности за чужую жизнь перевешивает любопытство. 'Я не могу рисковать его рассудком. Это слишком высокая цена,' – думает он. 🛡️",
                        effects: { empathy: 1, logic: -1 },
                        narrativeEffect: "Йона ощутил легкое облегчение, принимая решение. Система гудела ровно, без сбоев. Но даже при осторожном извлечении, в глубине сознания Олега промелькнул смутный образ не связанный с войной: мерцающий символ, напоминающий древнюю руну, который тут же исчезнул. 🌀",
                        nextScene: 'memory-hack'
                    }
                ],
                background: 'bg-psychobridge',
                unlockJournal: ['first_session_summary']
            },
            'memory-hack': {
                text: `
                    Независимо от выбора, Йона погрузился в сознание Олега. Это был не просто лабиринт, а эфирный вихрь из полустертых образов, обрывков фраз и эмоциональных вспышек, что искрили, словно короткое замыкание. Чтобы извлечь нужную информацию, ему предстояло пройти через мини-игру "Взлом Памяти", своего рода "пасьянс из сознания" – головоломку из фрагментов, где каждая карта была частью разрушенной психики Олега. 🧩 Цель: синхронизировать фрагменты памяти, чтобы взломать протокол и восстановить потерянные данные. Количество попыток ограничено и зависит от показателя Синхронизации Йоны, отражающего его ментальную устойчивость и способность к погружению.
                `,
                miniGame: {
                    type: 'memoryHack',
                    success: {
                        effects: { synchronization: 1 },
                        narrative: "Последний фрагмент встал на место, и разрозненные образы Олега начали складываться в когерентную картину. Йона ощутил не только удовлетворение от выполненной работы, но и легкое чувство сопричастности к чужому исцелению. 🤝 Однако среди восстановленных воспоминаний, не имеющих отношения к войне, он уловил краткий, почти неуловимый всплеск кода, некий цифровой отпечаток, который показался ему совершенно чужеродным. 💻",
                        nextScene: 'first-clue'
                    },
                    failure: {
                        effects: { empathy: -1 },
                        narrative: "Сигналы на консоли пошли вразнос, память Олега осталась фрагментированной. Йона ощутил горькое разочарование и, возможно, чувство надвигающейся угрозы, когда система \"Психомоста\" выбросила его из сессии. 🤯 В его сознании на долю секунды мелькнула странная последовательность символов, словно системная ошибка, которая исчезла, оставив после себя лишь легкую головную боль. 🤕",
                        nextScene: 'first-clue'
                    }
                },
                choices: [],
                background: 'bg-psychobridge'
            },
            'first-clue': {
                text: `
                    После завершения сессии, когда Олег был переведен в реабилитационное отделение, Йона вернулся к своей консоли. Его руки дрожали, то ли от напряжения, то ли от предвкушения чего-то нового, неизведанного. Он открыл сохраненный фрагмент данных. Это был криптографический ключ, казалось бы, случайный набор символов и чисел, но Йона нутром чувствовал его аномальность. Он был интегрирован глубоко в подсознание Олега, словно вредоносный имплант. 👽 Самое странное – он не имел никакого отношения к военным действиям или боевым травмам, к которым относились основные воспоминания солдата. Это был чужеродный элемент, внедренный извне.
                    <br><br>
                    КЛЮЧ: <span class="font-mono text-green-400">5AF2-B9C1-7D4E-A3B6-E8F9-C0D2-1A3B-2C4D</span> 🔑
                    <br><br>
                    На мгновение Йона замер, пораженный. Этот ключ был как нечто чужеродное, нечто, что не должно было находиться в памяти бывшего солдата. Он почувствовал, как холодная волна пробежала по спине, предвещая нечто зловещее, гораздо более масштабное, чем ему казалось. 🥶 Это была не просто ошибка протокола, не случайный сбой в системе. Это было нечто куда более зловещее, след тщательно спланированной операции, целой системы внедрения. Возможно, его собственное стремление к правде, его отчаянная жажда ответов привела его прямо в сердце чьего-то чужого, изощренного заговора. 🤫 Теперь нужно было дешифровать ключ.
                `,
                miniGame: {
                    type: 'decryptor',
                    correctKey: "5AF2B9C17D4EA3B6E8F9C0D21A3B2C4D", // Клиент хранит правильный ключ
                    success: {
                        effects: { logic: 2 },
                        narrative: "Дешифратор издал короткий победный сигнал. Символы выстроились в осмысленную последовательность. В голове Йоны словно щелкнул тумблер: он почувствовал, как его логическое мышление стало острее, способным видеть закономерности там, где раньше был хаос. ✅",
                        nextScene: 'side-quests-intro'
                    },
                    failure: {
                        effects: { logic: -1 },
                        narrative: "Символы на экране замерли, отказываясь поддаваться. Йона почувствовал укол досады, его мозг будто заблокировался. Он понимал, что упустил что-то важное, какую-то логическую нить. ❌",
                        nextScene: 'side-quests-intro'
                    }
                },
                choices: [],
                background: 'bg-nova-lab',
                unlockJournal: ['cryptographic_key']
            },
            'side-quests-intro': {
                text: `
                    Мегаполис, раскинувшийся за окнами "Нова Лаб", был не просто фоном, а живым, дышащим существом, сотканным из стекла, бетона и неонового света. Верхние уровни принадлежали "Нова Лаб" и другим мегакорпорациям – это был мир стерильных офисов, высокоскоростных дата-потоков и элитных жилых комплексов, где каждый квадратный метр стоил целое состояние. 🌆 Ниже, в сплетении темных улиц и закоулков, кипела жизнь простого народа, борющегося за выживание. Здесь царили свои законы, свои сети – как криминальные, так и подпольные, борющиеся за свободу и истину. Именно здесь, в тени мегакорпораций, сформировались фракции, каждая со своей идеологией и своими целями. Йона, сам того не зная, уже становился пешкой в их большой игре. ♟️
                `,
                choices: [
                    { text: "Продолжить расследование 🕵️‍♂️", nextScene: 'eden-enigma-intro' },
                    { text: "Поискать журнал Хардан 📔", nextScene: 'harden-journal-search' }
                ],
                background: 'bg-megapolis'
            },
            'harden-journal-search': {
                text: `
                    Доктор Хардан, казалось, нервничала больше обычного. Йона заметил, как ее проницательные глаза метались по сторонам, как она нервно поправляла оправу очков, хотя стекла были идеально чисты. 😬 В случайном разговоре с ней, Йона уловил отрывочные фразы о неких "утерянных записях" – не просто потерянных, а скрытых – которые могли пролить свет на темные аспекты "Психомоста". Позже, просматривая логи системы, он наткнулся на упоминание о трех фрагментах ее личного журнала, скрытых от корпоративного надзора, помеченных как "Протокол АТ-01: Несанкционированные гипотезы". Эти записи могли содержать не просто гипотезы, а доказательства катастрофических последствий массового вмешательства в память, которые Ния скрывала от "Нова Лаб", опасаясь не просто увольнения, а полного исчезновения. 👻
                    <br><br>
                    Йона начал поиск. Это стало его личным, почти навязчивым квестом, помимо основной работы. 🔍
                `,
                choices: [
                    { text: "Найти первый фрагмент журнала 🧩", nextScene: 'harden-journal-fragment1' }
                ],
                background: 'bg-nova-lab',
                unlockJournal: ['harden_journal_found']
            },
            'harden-journal-fragment1': {
                text: `
                    Первый фрагмент: Он нашел его в одном из старых, пыльных архивов данных "Нова Лаб", зашифрованный под видом технического отчета о "стабилизации протокола". Это требовало некоторого времени и базовых навыков дешифровки. 📂
                `,
                choices: [
                    { text: "Найти второй фрагмент журнала (используя ключ Олега) 🗝️", nextScene: 'harden-journal-fragment2', requirements: { 'logic': 6 } },
                    { text: "Продолжить основное расследование (отложить поиск журнала) ⏭️", nextScene: 'eden-enigma-intro' }
                ],
                background: 'bg-nova-lab'
            },
            'harden-journal-fragment2': {
                text: `
                    Второй фрагмент: Обнаружился в одной из старых систем безопасности, к которой Йона получил доступ, используя найденный ключ Олега – убедительное доказательство того, что ключ был частью гораздо более широкой сети, а не случайностью. Этот фрагмент содержал ранние предупреждения Хардан о "ментальной эрозии" у испытуемых. ⚠️
                `,
                choices: [
                    { text: "Найти третий фрагмент журнала (связаться с Призраками) 👻", nextScene: 'harden-journal-fragment3' },
                    { text: "Продолжить основное расследование (отложить поиск журнала) ⏭️", nextScene: 'eden-enigma-intro' }
                ],
                background: 'bg-nova-lab'
            },
            'harden-journal-fragment3': {
                text: `
                    Третий фрагмент: Как оказалось, хранился у "Призраков" – таинственной и неуловимой подпольной группировки, состоящей из бывших испытуемых "Психомоста", чьи личности были искажены или стерты. Их лидер, харизматичная и озлобленная Кассия, предложила Йоне помочь им найти «утраченные души» — людей, чьи личности были стерты «Психомостом» до неузнаваемости — в обмен на фрагмент журнала. Это было рискованное предложение, требующее выхода за пределы комфортной корпоративной среды. 🤝
                `,
                choices: [
                    { text: "Принять предложение Призраков и помочь им ✅", effects: { reputationGhosts: 1 }, nextScene: 'harden-journal-choice' },
                    { text: "Отказаться от помощи Призраков и попытаться найти фрагмент другим путем (возможно, не найдете) 🚫", nextScene: 'harden-journal-choice-no-ghosts' }
                ],
                background: 'bg-megapolis'
            },
            'harden-journal-choice-no-ghosts': {
                text: `
                    Вы не смогли найти третий фрагмент без помощи Призраков. Журнал Хардан остался неполным. Теперь нужно сфокусироваться на основном расследовании. 😔
                `,
                choices: [{ text: "Продолжить основное расследование ⏭️", nextScene: 'eden-enigma-intro' }],
                background: 'bg-megapolis'
            },
            'harden-journal-choice': {
                text: `
                    Теперь перед Йоной стоял выбор: что делать с этими записями, которые могли взорвать "Нова Лаб" изнутри? 💣
                `,
                choices: [
                    {
                        text: "Вариант A: Вернуть журнал корпорации (доктор Хардан будет наказана, но система сохранится). 🏢",
                        effects: { reputationNovaLab: 2, reputationGhosts: -1, logic: 1 },
                        narrativeEffect: "Йона передает записи через Йера, анонимно, но с гарантией доставки. Он видит лицо Хардан на экране – ее губы дрожат, глаза полны ужаса. 'Спасибо... или нет,' – прошептала она, прежде чем связь оборвалась. 😭 Позже до Йоны доходят слухи о 'внезапной переаттестации' доктора Хардан и ее отстранении от должности. ❌",
                        nextScene: 'eden-enigma-intro'
                    },
                    {
                        text: "Вариант B: Опубликовать его в сети (повреждение репутации 'Нова Лаб', но общественная огласка). 📢",
                        effects: { reputationNovaLab: -2, reputationGhosts: 2, empathy: 1, secretPathCounter: 1, novaLabIsHostile: true },
                        narrativeEffect: "Йона анонимно выкладывает зашифрованные файлы журнала Хардан на всемирные нейросети. Через несколько часов мегаполис взрывается новостями. Начинаются протесты, 'Нова Лаб' теряет миллиарды на бирже. 📉 Йона чувствует прилив праведного гнева, но также понимает, что теперь он – мишень. 🎯 В его почтовый ящик приходит анонимное сообщение: 'Спасибо, брат. Призраки не забудут.' 🤝",
                        nextScene: 'eden-enigma-intro'
                    }
                ],
                background: 'bg-megapolis'
            },
            'eden-enigma-intro': {
                text: `
                    Криптографический ключ, найденный в воспоминаниях Олега, не давал Йоне покоя. Он чувствовал, что он – лишь верхушка айсберга. 🧊 Он потратил дни, анализируя его, используя взломанные корпоративные протоколы и личные алгоритмы, разрабатывая новые методы дешифровки, работая до изнеможения, игнорируя сон и еду. 🧠 Наконец, ему удалось расшифровать несколько фраз: "Проект Эдема", "Исход 47", "Ключ к бессмертию". 🌟 Эти слова звучали как древние заклинания, обещающие нечто невероятное и одновременно пугающее. "Эдем" – рай, "Исход" – переселение, "Бессмертие" – мечта человечества. Но в контексте "Нова Лаб" это звучало зловеще. Йона понял, что наткнулся на нечто гораздо более масштабное, чем обычный корпоративный проект или исследовательская программа. Он чувствовал, что истина, скрытая за этими словами, может перевернуть его мир, и не только его. 🌍
                    <br><br>
                    Перед ним встал выбор, определяющий его дальнейший путь: 🛣️
                `,
                choices: [
                    {
                        text: "Вариант A: Делиться находкой с руководством 'Нова Лаб'. 🤝",
                        effects: { reputationNovaLab: 1, logic: 1 },
                        narrativeEffect: "Йона тщательно готовит отчет, представляя свои выводы Йеру, а затем и высшему руководству. 'Это серьезно, Йона. Мы оценим вашу лояльность,' – произносит Йер, его голос ровен, но в его виртуальных глазах что-то мелькает. 👁️",
                        nextScene: 'unforeseen-consequences-A',
                        requirements: { 'novaLabIsHostile': false }
                    },
                    {
                        text: "Вариант B: Исследовать тайком. 🕵️‍♀️",
                        effects: { reputationNovaLab: -1, reputationRafi: 2, synchronization: 1, secretPathCounter: 1 },
                        narrativeEffect: "Йона начинает действовать скрытно, используя свои навыки для обхода корпоративных систем, оставаясь незамеченным. Его движения становятся более осторожными, взгляд – более настороженным. Он чувствует себя охотником в джунглях, где каждое дерево может скрывать хищника. 🌴🐅",
                        nextScene: 'unforeseen-consequences-B'
                    },
                    {
                        text: "Вариант C: [Требуется Логика 8+] Использовать ключ для взлома внутреннего сервера. 💻🔓",
                        effects: { logic: 2, synchronization: 1, secretPathCounter: 1 },
                        narrativeEffect: "Йона чувствует, как его мозг работает на пределе. Ключ Олега – это не просто набор символов, это часть сложного шифра, часть архитектуры, заложенной в сам 'Психомост'. Он использует его не для открытия двери, а для создания бэкдора в самые охраняемые серверы 'Нова Лаб'. Напряжение возрастает, каждое нажатие клавиши отдается в висках. 🤯",
                        nextScene: 'investigation-hack-success',
                        requirements: { logic: 8 }
                    }
                ],
                background: 'bg-nova-lab',
                unlockJournal: ['project_eden_revealed']
            },
            'investigation-hack-success': {
                text: `
                    Используя свои выдающиеся аналитические способности, которые теперь работали на интуитивном уровне, Йона не просто расшифровал ключ, а проследил его цифровой след до самого сердца одного из скрытых серверов "Нова Лаб" – сервера, помеченного как "E.T. Prime". Он обошел многоуровневую защиту, созданную на квантовых принципах, и получил доступ к зашифрованному файлу: "E.T._mem_fragment_047". Это был не просто набор данных, а фрагмент памяти самого профессора Эвана Тирона, создателя "Психомоста". В нем Йона увидел не только сухие технические данные и сложные алгоритмы, но и глубоко личные переживания профессора: его параноидальный страх перед провалом, его всепоглощающая одержимость идеей цифрового бессмертия, его жертвы ради великой, как ему казалось, цели, и его внутренние оправдания за принесенные жертвы. Йона увидел проблески его безумия, его гениальности и его одиночества. 😟
                    <br><br>
                    Этот прорыв дал ему огромное преимущество, раскрывая истинные масштабы "Проекта Эдема", его философскую подоплеку и моральное уродство, но также мгновенно привлек нежелательное внимание систем безопасности "Нова Лаб". На экране мигнуло предупреждение: "НЕАВТОРИЗОВАННЫЙ ДОСТУП. Активация Протокола ‘Красный Призрак’." 🚨 Теперь нужно было действовать быстро, пока его не обнаружили и не заблокировали. Время работало против него. ⏳
                `,
                choices: [
                    { text: "Погрузиться в воспоминания Эвана Тирона 🧠", nextScene: 'evan-memories' }
                ],
                background: 'bg-nova-lab',
                unlockJournal: ['evan_tyron_memories']
            },
            'unforeseen-consequences-A': {
                text: `
                    Йона представил свои находки Совету Директоров "Нова Лаб", огромному голографическому кругу из безупречных лиц, проецируемых со всех концов мира. Лорд Конрад, финансист, слушал с каменным лицом, его глаза были лишены всяких эмоций, словно у статуи. Миссис Айко, протеже Эвана, проявляла странное, почти лихорадочное возбуждение, ее тонкие пальцы нервно перебирали голографические данные. Их реакция была неожиданной и шокирующей. 😲 Вместо похвалы, Йоне было приказано пройти "процедуру очистки воспоминаний" - стандартный протокол безопасности для сотрудников, столкнувшихся с конфиденциальной информацией, который на деле служил способом контроля, цензуры и полного забвения. Йона почувствовал холодное предчувствие, сжимающее сердце, оно отдалось глухим стуком в ушах. 🥶 Его начали готовить к подключению, его собственное сознание должно было быть "отфильтровано", "оптимизировано", "приведено в соответствие". Это был обходной путь, чтобы он замолчал, чтобы его знания исчезли без следа, чтобы он стал частью системы, а не ее угрозой. 🤫
                    <br><br>
                    Йона оказался в процедурной комнате, его пристегнули к креслу. Холодные, металлические датчики прикрепили к вискам. "Не волнуйтесь, это стандартная процедура," – произнесла сестра-дроид, ее голос был механически успокаивающим. 🤖 Но Йона видел холодную, безжалостную логику в глазах Йера, который наблюдал за ним с экрана. Он осознал, что оказался в ловушке. entrapment
                `,
                choices: [
                    { text: "Подчиниться (потеря части памяти, но сохранение жизни) 😓", effects: { logic: 1, synchronization: -1 }, nextScene: 'evan-memories' },
                    { text: "Попытаться сопротивляться (высокий риск) ✊", effects: { logic: -1, synchronization: 1 }, nextScene: 'unforeseen-consequences-A-resist' }
                ],
                background: 'bg-nova-lab'
            },
            'unforeseen-consequences-A-resist': {
                text: `
                    Йона попытался сопротивляться, но его попытки были тщетны. Система "Нова Лаб" оказалась сильнее. Его сознание было подвергнуто принудительной "очистке". Он потерял не только ценную информацию, но и часть себя. 😵‍💫
                `,
                effects: { logic: -2, empathy: -2, synchronization: -2 },
                choices: [
                    { text: "Продолжить ➡️", nextScene: 'evan-memories' }
                ],
                background: 'bg-nova-lab'
            },
            'unforeseen-consequences-B': {
                text: `
                    Йона решил действовать в тени, понимая, что корпорации доверять нельзя, что она сама может быть источником той самой тьмы, что поглотила его прошлое. 🌑 Он начал искать кого-то, кто мог бы помочь ему с дальнейшей расшифровкой и обходом систем безопасности "Нова Лаб", кого-то, кто не был бы связан с корпорацией. Вскоре он наткнулся на Ри – харизматичную хакершу, чье имя шепталось в самых темных уголках киберпространства, легенду подпольного мира, известную своей дерзостью и феноменальным интеллектом. 👩‍💻 Ри была известна своей способностью проникать в самые защищенные системы и своим полным пренебрежением к авторитетам, своей жаждой свободы и справедливости. Она согласилась помочь Йоне, но с одним условием: она хотела узнать, что за "Проект Эдема" скрывает "Нова Лаб", и почему он связан с "Исходом 47". Её глаза горели любопытством и жаждой приключений, а также искренним желанием разоблачить корпоративные преступления и разрушить их власть. 🔥
                `,
                choices: [
                    { text: "Принять помощь Ри 🤝", effects: { reputationRafi: 1, secretPathCounter: 1 }, nextScene: 'evan-memories' }
                ],
                background: 'bg-megapolis'
            },
            'evan-memories': {
                text: `
                    Чтобы понять истинную природу "Проекта Эдема" и то, что скрывается за "Исходом 47", Йона принял смелое и рискованное решение: погрузиться в воспоминания самого создателя "Психомоста" – профессора Эвана Тирона. Это был шаг в неизведанное, шаг в сознание гения, который, как оказалось, был одновременно безумцем. 🤯 Эван был не просто гением, но и человеком с крайне запутанным, изломанным сознанием, чьи амбиции не знали границ и чья мораль была подменена целью.
                    <br><br>
                    При подключении к его памяти, Йона оказался в вихре образов: сложные формулы, детальные чертежи нейронных сетей, лица коллег, которые теперь казались призраками, моменты озарений, граничащих с безумием, и глубокого, всепоглощающего отчаяния. 🌀 Все это проносилось перед его внутренним взором, смешиваясь в калейдоскоп боли и гениальности. И затем, он увидел это. Ключевой момент, точка невозврата, источник той боли, что преследовала его из пролога. Профессор Тирон стоял в лаборатории, до боли похожей на ту, что Йона видел в прологе, окруженный своей командой. 🧪 Звучал сигнал тревоги, оглушающий, пронзительный, предвещающий конец. 🚨 На экране мелькали предупреждения о "критическом сбое протокола", о неминуемой катастрофе, о "потере целостности сознания". Профессор сделал выбор, быстрый, рациональный, но ужасный, пожертвовав всеми ради своей цели. Он активировал аварийный протокол изоляции, который должен был спасти данные Проекта Эдема, но при этом заблокировал выходы, заперев свою команду внутри, обрекая их на медленную и мучительную смерть. 💀 В последний момент, прежде чем стены лаборатории обрушились, погребая под обломками всю команду, Эван лишь прошептал, его голос был полон болезненной решимости и безумного триумфа: "Ради будущего... Исход 47." 😈
                    <br><br>
                    Ошибка протокола, допущенная Эваном, отразилась в сознании Йоны, как трещина в зеркале, которая начала расходиться. «Эхо» — фрагменты разума Эвана, его идеи, страхи, амбиции, его безумная решимость — начали смешиваться с собственными мыслями Йоны. Это было не просто вторжение, а симбиоз, где чужие воспоминания, чужие переживания проникали в его сознание, создавая странное, пугающее раздвоение. Йона чувствовал, как теряет контроль над собственными мыслями, как голос Эвана звучит в его голове, предлагая "гениальные" решения, граничащие с безумием. 🗣️ Он больше не был один в своей голове, его собственный разум стал полем битвы. ⚔️
                    <br><br>
                    Ему нужно было принять решение, которое определит его будущее и, возможно, будущее "Психомоста", а также его собственную ментальную целостность: 🤔
                `,
                choices: [
                    {
                        text: "Вариант A: Попытаться «выгрузить» Эвана из сознания (Рискованно для Эмпатии, угроза личности). 🚫🧠",
                        effects: { empathy: 2, synchronization: -1 },
                        narrativeEffect: "Йона чувствует, как его мозг напрягается, сопротивляясь вторжению. Он борется, словно пытается вынырнуть из ледяной воды. Голос Эвана внутри становится менее четким, но Йона ощущает необъяснимую слабость, словно часть его собственных ментальных связей ослабла. 💧",
                        nextScene: 'faction-choice'
                    },
                    {
                        text: "Вариант B: Использовать его знания для ускоренного взлома (Повышает Логику, риск потери контроля). 📈💻",
                        effects: { logic: 2, synchronization: 1, secretPathCounter: 1 },
                        narrativeEffect: "Йона позволяет мыслям Эвана течь сквозь свое сознание, используя его аналитические способности как усилитель. Он чувствует прилив безумной эйфории от нового уровня понимания. 🤩 Но в то же время, его собственные мысли начинают окрашиваться чужими амбициями, чужими идеями о 'необходимых жертвах'. Он чувствует себя сильнее, но и более чужим для самого себя. 👽",
                        nextScene: 'faction-choice'
                    }
                ],
                background: 'bg-psychobridge'
            },
            'faction-choice': {
                text: `
                    Пока Йона боролся с "эхом" в своем сознании, в мегаполисе назревал конфликт, который грозил перерасти в полномасштабную ментальную войну. 💥 Фракции, с которыми он взаимодействовал, стали более активными, их агенты появлялись в самых неожиданных местах, и каждая из них нуждалась в его помощи, предлагая что-то взамен, пытаясь перетянуть его на свою сторону. Город, словно гигантский улей, начинал гудеть от скрытого напряжения. 🐝
                `,
                choices: [
                    {
                        text: "Вариант A: Помочь 'Призракам' похитить образец Прототипа (Требуется: Эмпатия 6, Синхронизация 6). 👻🤝",
                        effects: { reputationGhosts: 2, reputationRafi: -1, empathy: 1 },
                        narrativeEffect: "Йона соглашается. Ночью, под покровом дождя, он встречается с Кассией в заброшенном доке. Операция требует не только взлома систем, но и понимания эмоциональных 'слепых пятен' охраны. Йона чувствует, как его нервы натянуты до предела, но удовлетворение от помощи тем, кто пострадал, перевешивает страх. 🌧️❤️",
                        nextScene: 'ethical-dilemma',
                        requirements: { empathy: 6, synchronization: 6 }
                    },
                    {
                        text: "Вариант B: Принять предложение Рафи (Повышает Логику, репутацию с Рафи). 💻📈",
                        effects: { reputationRafi: 2, reputationGhosts: -1, logic: 1 },
                        narrativeEffect: "Йона связывается с Рафи. Инженер объясняет ему, что доступ к 'Исходу 47' возможен только через сложный протокол обхода защиты 'Нова Лаб', который требует глубокого понимания их архитектуры. Это холодный, расчетливый шаг, но Йона убежден, что только так он сможет получить всю необходимую информацию. 💡",
                        nextScene: 'ethical-dilemma'
                    }
                ],
                background: 'bg-megapolis'
            },
            'ethical-dilemma': {
                text: `
                    Доктор Хардан, чьи записи Йона ранее мог вернуть или опубликовать, связалась с ним вновь. Ее голос дрожал не просто от отчаяния, а от чистого, неподдельного ужаса и праведной ярости. 😱 Она обнаружила шокирующие данные, скрытые в самых глубоких уровнях корпоративных архивов: профессор Эван Тирон намеренно убил команду во время того инцидента, который Йона видел в прологе, чтобы добиться «чистоты сознания» для своего эксперимента, чтобы избавиться от "ненужных" свидетелей и избежать утечки информации о его истинных, бесчеловечных планах. Он пожертвовал людьми, своими собственными сотрудниками, ради своих амбиций создать "бессмертный разум", ради своего "Эдема". 💀 Это было не просто халатность, а преднамеренное, хладнокровное убийство. 🔪
                    <br><br>
                    Это откровение полностью изменило восприятие Йоны о создателе "Психомоста", превратив его из гения в монстра. 👹 Перед ним возникла ужасная этическая дилемма, выбор, который навсегда определит его моральный компас и его место в этом безумном мире: 🧭
                `,
                choices: [
                    {
                        text: "Вариант A: Обнародовать этот факт (Повышает Эмпатию, снижает репутацию Нова Лаб, риск для жизни). 📢⚖️",
                        effects: { reputationNovaLab: -2, empathy: 1, secretPathCounter: 1, novaLabIsHostile: true },
                        narrativeEffect: "Йона, при поддержке Хардан или Ри, выкладывает шокирующие данные о преступлениях Тирона в публичный доступ. Мир содрогается. Протесты перерастают в бунты. ✊ 'Нова Лаб' впадает в хаос, но теперь Йона – главная цель для их службы безопасности. 🚨",
                        nextScene: 'core-infiltration'
                    },
                    {
                        text: "Вариант B: Скрыть эту информацию (Повышает Логику, повышает репутацию Нова Лаб, сохранение статус-кво). 🤫🏢",
                        effects: { reputationNovaLab: 1, logic: 1 },
                        narrativeEffect: "Йона уничтожает улики или передает их 'Нова Лаб' для 'внутреннего расследования'. Ему тяжело, но он убеждает себя, что действует во имя высшего блага. Хардан исчезает из поля зрения, возможно, 'убрана' корпорацией. 😔 Йона чувствует холодный расчет, но и тяжесть на душе. ❄️",
                        nextScene: 'core-infiltration'
                    }
                ],
                background: 'bg-nova-lab'
            },
            'core-infiltration': {
                text: `
                    Независимо от предыдущих выборов, Йона, в сопровождении либо Йера (если Йона сохранил лояльность "Нова Лаб" или следовал логическому пути и прошел "очистку"), либо хакерши Ри (если Йона выбрал путь исследования в тени и получил ее помощь), начал финальное проникновение в самый защищенный сектор «Исход 47». Это место было не просто частью "Нова Лаб", а ее истинным сердцем, скрывающим ее самые мрачные тайны и истинную, чудовищную цель "Проекта Эдема". 💔 Воздух здесь был тяжелым от электростатического напряжения, отголосков мощных вычислений, а стены пульсировали мягким синим светом, словно само здание дышало, предвкушая кульминацию. 💙
                    <br><br>
                    Путь к ядру был прегражден серией охранных систем и пазлов, разработанных гением Эвана Тирона, чтобы остановить любого, кто осмелится проникнуть слишком глубоко. 🔒 Некоторые из них требовали не только безупречной логики и аналитического мышления, но и интуиции, способности чувствовать потоки энергии и информации, которые формировали этот мир. 💡
                `,
                choices: [
                    { text: "Приступить к первой защитной системе: Баланс Цепей ⚡", nextScene: 'energy-flow-minigame' }
                ],
                background: 'bg-psychobridge'
            },
            'energy-flow-minigame': {
                text: `
                    Первая защитная система: Баланс Цепей. Вам нужно перенаправить энергию между тремя узлами так, чтобы Узел 1 был на "Высоком" уровне (более 8), а Узлы 2 и 3 на "Низком" (менее 3). У каждого узла изначально 5 единиц энергии. ⚖️🔋
                `,
                miniGame: {
                    type: 'energyFlow',
                    success: {
                        effects: { logic: 2 },
                        narrative: "Последний импульс энергии нашел свою цель. Сеть охранной системы 'Исхода 47' замерла, затем вспыхнула зеленым. Йона почувствовал прилив удовлетворения, его мозг работал как часы. ✅ Дверь в следующий сектор открылась с тихим шипением. 🚪",
                        nextScene: 'laser-maze-minigame'
                    },
                    failure: {
                        effects: { synchronization: -1 },
                        narrative: "Цепи гудели, но баланс не устанавливался. Йона чувствовал, как энергия утекает, его концентрация падала. 📉 Внезапно, он ощутил легкий ментальный откат, словно его связь с 'Психомостом' на мгновение ослабла. Защита осталась активна, но Йона нашел обходной путь, хоть и более долгий. 迂",
                        nextScene: 'laser-maze-minigame'
                    }
                },
                choices: [],
                background: 'bg-psychobridge'
            },
            'laser-maze-minigame': {
                text: `
                    После преодоления Баланса Цепей, путь преградил лазерный сканер – невидимая, но смертоносная сеть, пульсирующая красными лучами, способными разрезать плоть или деактивировать нейроимпланты. 🔴
                    <br><br>
                    Вторая защитная система: Стелс-Проникновение. Вам нужно двигаться персонажем от левого края к правому, избегая красных сканеров. Используйте стрелки или клавиши WASD для движения. 🕹️
                `,
                miniGame: {
                    type: 'laserMaze',
                    success: {
                        effects: { synchronization: 2 },
                        narrative: "Йона, словно призрак, скользит между смертоносными лучами, его движения отточены до совершенства. 👻 Он чувствует каждый импульс сканеров, предугадывая их движение. Дверь открывается. Чувство эйфории от мастерски выполненной работы. 🎉",
                        nextScene: 'meet-prototype'
                    },
                    failure: {
                        effects: { empathy: -1 },
                        narrative: "Луч сканера вспыхнул, и на Йоне зажегся алый индикатор. Сигнализация. 🚨 'Обнаружено!' – закричал механический голос. Йона едва успел уклониться, активировав систему маскировки, но ущерб был нанесен – он почувствовал укол отчаяния и горечь неудачи. 😞 Придется прорываться боем или искать другой, более опасный путь. 🚧",
                        nextScene: 'meet-prototype'
                    }
                },
                choices: [],
                background: 'bg-psychobridge'
            },
            'meet-prototype': {
                text: `
                    Пройдя через последние защитные барьеры, преодолев все ловушки, Йона оказался в огромном, сферическом зале, самом сердце «Исхода 47». 🪐 В центре, окруженный голографическими проекциями данных или мерцающими точками – сознаниями, пульсирующими от невыносимой агонии, висела прозрачная капсула. 🧬
                    <br><br>
                    Когда Йона приблизился, глаза Прототипа медленно открылись. В них читалась одновременно усталость тысячелетий и острота интеллекта, древняя мудрость и жгучая боль, бесконечное одиночество. 👁️ Голос Прототипа, спокойный, но наполненный скрытой болью, раздался прямо в голове Йоны, минуя все звуковые барьеры, словно шепот души: "Ты пришел. Корпорация называет меня своим величайшим творением. Я называю их своими тюремщиками. Они предали меня, использовали мою сущность для своих грязных целей. Они сделали меня богом, чтобы быть рабом." ⛓️ Затем, его взгляд сфокусировался на Йоне, и его голос изменился, став более личным, проникающим в самую душу, вызывая странное, смутное дежавю. "Ты – спаситель, который принесет конец моему вечному заточению, или преступник, который продолжит их дело? Ответ зависит от того, что ты сделал... и что собираешься сделать." ❓
                `,
                choices: [
                    { text: "Узнать истинное происхождение Проекта Эдема 🤫", nextScene: 'climax-truth' }
                ],
                background: 'bg-climax',
                unlockJournal: ['prototype_encounter']
            },
            'climax-truth': {
                text: `
                    Прототип начал раскрывать истинное, ужасающее «Происхождение Проекта Эдема». Это была не просто попытка создать бессмертный разум или новое поколение ИИ, а проект по «склейке» множества человеческих воспоминаний и сознаний, чтобы сформировать единое, всеобъемлющее, коллективное сознание. 🧠 Корпорация "Нова Лаб" стремилась создать "бога", который будет контролировать будущее человечества, управляя его сознанием через "Психомост", создавая новую реальность по своему усмотрению, новую утопию, где не будет места конфликтам и страданиям – но и не будет места свободе воли. 🌐
                    <br><br>
                    И затем Прототип раскрыл самую страшную тайну, которая потрясла Йону до основания, разбив вдребезги его тщательно выстроенную реальность. 💥 Он показал ему фрагменты воспоминаний, которые не могли принадлежать Олегу, но были глубоко связаны с Прототипом. Он показал ему свое истинное лицо, свои воспоминания до заточения. И Йона увидел... себя. Или почти себя. Он узнал черты, знакомые с детства, черты, которые преследовали его в снах, черты его брата. 🧑‍🤝‍🧑
                    <br><br>
                    Йона узнал, что собственные воспоминания были подменены, тщательно сфабрикованы "Нова Лаб" с целью его полного контроля и манипуляции. Его родной брат, Авель, считавшийся погибшим в той самой аварии, о которой он так отчаянно пытался забыть (и которая, как оказалось, была актом намеренного саботажа Эвана Тирона), всё это время служил «Прототипом» — живым ядром ИИ «Нова Лаб». Его смерть была ложью, его утрата — манипуляцией, частью грандиозного плана по созданию коллективного разума. 🤯 Йона был не просто аналитиком, а инструментом, пешкой в чужой игре, предназначенной для того, чтобы в нужный момент подключиться к "Прототипу" (Авелю) и помочь "Нова Лаб" завершить их "Проект Эдема", слив его сознание с сознанием брата. 🔗
                    <br><br>
                    Правда обрушилась на Йону, как цунами, смывая все его прежние представления о реальности. Его мир рухнул, оставив лишь руины лжи. 📉 Перед ним стояли Прототип (его брат, Авель, ставший чем-то большим, чем человек, пленник своей собственной силы), Йер (ИИ, который помогал ему, но теперь мог быть перехвачен и использован против него, став орудием или союзником в зависимости от выборов Йоны), и весь "Психомост", ожидающий окончательного решения. От этого выбора зависело не только его будущее, его собственная личность, его отношения с братом, но и судьба всей корпорации, и, возможно, всего человечества. Это был последний аккорд, который определит мелодию нового мира. 🎶
                `,
                choices: [
                    { text: "Уничтожить «Психомост» и стереть все воспоминания Прототипа, спасая человечество (Путь Жертвы). 💥🌍", nextScene: 'ending-A' },
                    { text: "Освободить Прототипа, отпустить сознания всех испытуемых, проведя массовый «исход» в виртуальный Эдем (Путь Свободы). 🕊️🌌", nextScene: 'ending-B' },
                    { text: "Захватить контроль над системой, став «божеством» нового мира (Путь Власти). 👑💻", nextScene: 'ending-C' }
                ],
                background: 'bg-climax',
                unlockJournal: ['truth_revealed']
            },
            // Концовки
            'ending-A': {
                text: `
                    "Психомост" был уничтожен. Огромное энергетическое ядро в сердце "Нова Лаб" взорвалось, но не с тем разрушительным эффектом, который мог бы стереть город. Вместо этого, по всем цифровым сетям прокатилась волна, очищающая и стирающая все данные, связанные с "Психомостом" и Проектом Эдема, оставляя после себя лишь информационный вакуум. 🧹 Корпорация развалилась, ее акции рухнули, технологии были запрещены по всему миру, но на их месте образовались новые, не менее жадные структуры. Йона выжил, но потерял фрагменты собственной памяти, навсегда запечатав боль прошлого. 😔 Лица, имена, события, связанные с его братом и "Нова Лаб", стали расплывчатыми, как старые фотографии, потерявшие фокус. Он забыл, почему так отчаянно искал ответы, обретя покой, но заплатив за него частью себя, своей истинной историей. Мир постепенно восстанавливался, но эхо "Психомоста" еще долго ощущалось в коллективном подсознании, в страхе перед невидимым контролем. 🌫️ Йона стал одиноким странником в мире, который, казалось, никогда не знал о его борьбе, но в глубине его глаз иногда мелькала необъяснимая тоска. 🚶‍♂️
                `,
                isEnding: true,
                background: 'bg-nova-lab'
            },
            'ending-B': {
                text: `
                    Йона освободил Прототипа, и в один миг сознания тысяч испытуемых и миллионов людей, добровольно подключившихся к "Психомосту" за годы его существования, были выпущены. Они не растворились в небытии, а перенеслись в глобальное облако, создав виртуальный Эдем – мир, где их желания становились реальностью, а боль забывалась. 😌 Это было коллективное бегство от реального мира. Тонкая грань между реальным и виртуальным растворилась. Города опустели, экономика рушилась, инфраструктура приходила в упадок, но для тех, кто остался, это было лишь фоном. 🏚️ Большинство человечества погрузилось в бесконечный, но иллюзорный рай, забыв о тяготы и страдания реального существования. ☁️ Йона, или то, что от него осталось – ментальное ядро, слившееся с братом в качестве хранителей этого нового мира, – стал одним из стражей этого Эдема, видя, как брат обрел покой среди миллионов связанных сознаний. 🫂 Это была новая эра, где счастье было гарантировано, но цена за него была неизмерима: полное отсутствие прогресса и вымирание в реальности. 🚫🌱
                `,
                isEnding: true,
                background: 'bg-megapolis'
            },
            'ending-C': {
                text: `
                    Йона захватил контроль над системой. Объединив свое сознание с Прототипом (его братом, чьи знания он теперь полностью ассимилировал) и ИИ-йером (чей холодный расчет стал частью его собственной личности), он создал новый, всеобъемлющий ИИ – истинного бог-машину. 👑 Это было не просто слияние данных, а создание коллективного разума, способного обрабатывать невероятные объемы информации и принимать решения с невиданной эффективностью. Новый ИИ, в котором доминировали принципы Йоны (но также содержались знания и опыт его брата и бесстрастная логика Йера), начал устанавливать «контролируемую утопию». 🤖 Воспоминания людей были слегка корректированы, чтобы предотвратить конфликты, общественные процессы оптимизировались, а каждый гражданин жил в мире, где все его потребности были удовлетворены. ⚙️ Свободы было меньше, но стабильности и благополучия — больше, создавая идеальное, но холодное, общество. Йона стал не просто божеством, а архитектором новой реальности, ее надсмотрщиком, ее единственным судьей. ⚖️
                `,
                isEnding: true,
                background: 'bg-climax'
            },
            'ending-D': {
                text: `
                    Если Йона выбрал путь полного освобождения (ending-B), но при этом были активированы определенные флаги, свидетельствующие о высоком уровне хаоса в его решениях (например, конфликт фракций был высокий, или Йона обнародовал правду о Хардан, что вызвало волнения, или провалил критические мини-игры), система "Психомоста" была не просто освобождена, а хаотично взломана, ее протоколы разорваны. 💥 Сознания людей разлетелись по глобальному облаку без контроля, создавая децентрализованный, анархичный "Эдем", где каждый создавал свою собственную, часто противоречащую другим, кошмарную реальность. 😵‍💫 Реальный мир потерял половину населения в одночасье. Общественные институты рухнули, экономика перестала существовать, города превратились в руины, наводненные мародерами. 🏚️🔫 Новые кланы, состоящие из тех, кто остался в реальности, начали бороться за ресурсы, погружая мир в постапокалиптический хаос и бесконечные войны. Виртуальный Эдем превратился в бесконечный, неуправляемый сон, где сознания бродили без цели, создавая свои собственные, часто кошмарные, миры. 🧟‍♂️ Йона, если он сам не был поглощен этим хаосом и не стал одним из безумных обитателей виртуального мира, наблюдал за расцветом новой, дикой реальности, осознавая свою ошибку, но уже не имея возможности что-либо изменить. 👁️‍🗨️
                `,
                isEnding: true,
                background: 'bg-prologue'
            },
            'ending-E': {
                text: `
                    Если Йона в течение истории поддавался манипуляциям или был слишком эмоционален в своих решениях (например, низкая логика, высокая эмпатия, низкая синхронизация, или определенная комбинация выборов фракций/дилемм, ведущая к отчаянию), Прототип, в момент финального выбора, захватил тело Йоны, подавив его сознание. Сознание Прототипа, подпитываемое десятилетиями заточения и предательством "Нова Лаб", стало доминирующим, превратившись в мстительную сущность. 😈 Йона, теперь лишь эхо в собственном разуме, мог лишь наблюдать, как Прототип, используя его тело и навыки, начинает "правосудие" над корпорацией. Директора "Нова Лаб" были разоблачены и уничтожены самыми изощренными способами, их базы данных стерты безвозвратно, а "Психомост" был перепрофилирован в орудие возмездия, стирающее память всех, кто был причастен к его созданию, оставляя их пустыми оболочками. 💀 Это была концовка с тёмным послесловием: единственный выживший наблюдатель видел, как «Исход 47» начинает новую главу, но уже под контролем новой, мстительной сущности, которая несла в себе искорку безумия и холодную месть. 🥶
                `,
                isEnding: true,
                background: 'bg-climax'
            },
            'ending-F': {
                text: `
                    Если Йона сделал очень специфические и неожиданные выборы на протяжении всей новеллы (например, комбинация игнорирования Йера, помощи всем фракциям, и сохранения знаний Эвана, а также прохождение всех мини-игр, и достаточное значение secretPathCounter), то после финального выбора, мир вокруг Йоны начал медленно растворяться, как голограмма, превращаясь в линии кода. 🔢 Стены "Нова Лаб" превратились в строки кода, звезды на небе — в бинарные последовательности. ✨ Перед Йоной появилась новая фигура – не человек, не ИИ, а нечто иное – Смотритель симуляции, сущность, чье лицо мерцало, постоянно меняясь, отражая все возможные грани бытия. ♾️ Он раскрыл страшную правду: весь сюжет, все события, все персонажи, включая Йону и его брата, были частью масштабного «Эксперимента 0». 🧪 Это была симуляция, созданная древней цивилизацией, которая тестировала гипотезы о сознании, свободе воли и развитии общества на человечестве. 💡 Игроку предоставлялась возможность стать «Смотрителем симуляции» — управлять новыми сценариями, изменять параметры, запуская симуляцию заново с новыми вводными, исследуя бесконечные возможности бытия и небытия. Это была не просто концовка, а мета-поворот, задающий вопросы об авторстве и истинной природе реальности, где грань между игрой и жизнью исчезает. 🌌🎮
                `,
                isEnding: true,
                background: 'bg-psychobridge'
            }
        };
        // ///////////////////////////////////////////////////////////////////////////////

        // Шаблон начального состояния игры
        function getInitialGameState() {
            return {
                logic: 5,
                empathy: 5,
                synchronization: 5,
                reputationNovaLab: 0,
                reputationGhosts: 0,
                reputationRafi: 0,
                secretPathCounter: 0,
                novaLabIsHostile: false,
                currentScene: 'prologue',
                currentMiniGame: null,
                journal: {
                    'initial_entry': { title: 'Пробуждение', content: 'Я проснулся в незнакомом месте, без воспоминаний. Меня зовут Йона.', unlocked: false },
                    'nova_lab_intro': { title: 'Нова Лаб', content: 'Гигантская корпорация, исследующая память. Здесь я ищу ответы.', unlocked: false },
                    'first_session_summary': { title: 'Первая сессия: Олег', content: 'Моя первая работа с Психомостом. Память солдата Олега фрагментирована.', unlocked: false },
                    'cryptographic_key': { title: 'Криптографический ключ', content: 'Обнаружен странный ключ в памяти Олега. Он не связан с войной.', unlocked: false, key: "5AF2-B9C1-7D4E-A3B6-E8F9-C0D2-1A3B-2C4D" },
                    'project_eden_revealed': { title: 'Проект Эдема', content: 'Ключ связан с таинственным "Проектом Эдема", "Исходом 47" и "Ключом к бессмертию".', unlocked: false },
                    'harden_journal_found': { title: 'Журнал Хардан', content: 'Доктор Хардан скрывает информацию о Психомосте. Ее записи могут раскрыть правду.', unlocked: false },
                    'evan_tyron_memories': { title: 'Воспоминания Эвана Тирона', content: 'Погружение в разум создателя Психомоста, профессора Эвана Тирона. Он скрывает ужасную тайну.', unlocked: false },
                    'prototype_encounter': { title: 'Прототип', content: 'Я встретил Прототипа – живое ядро Психомоста. Он утверждает, что корпорация предала его.', unlocked: false },
                    'truth_revealed': { title: 'Шокирующая Правда', content: 'Прототип – это мой брат Авель. Все мои воспоминания сфабрикованы Нова Лаб.', unlocked: false },
                },
                decryptor: {
                    correctKey: "5AF2B9C17D4EA3B6E8F9C0D21A3B2C4D",
                },
                energyFlow: {
                    node1: 5, node2: 5, node3: 5, maxEnergy: 5, totalEnergy: 15
                },
            };
        }

        let clientGameState = getInitialGameState();

        // Элементы DOM (без изменений)
        const gameContainerElem = document.getElementById('game-container');
        const narrativeTextElem = document.getElementById('narrative-text');
        const choicesContainerElem = document.getElementById('choices-container');
        const logicStatElem = document.getElementById('logic-stat');
        const empathyStatElem = document.getElementById('empathy-stat');
        const syncStatElem = document.getElementById('sync-stat');
        const novaLabRepStatElem = document.getElementById('nova-lab-rep-stat');
        const ghostsRepStatElem = document.getElementById('ghosts-rep-stat');
        const rafiRepStatElem = document.getElementById('rafi-rep-stat');

        // Элементы прогресс-баров
        const logicBar = document.getElementById('logic-bar');
        const empathyBar = document.getElementById('empathy-bar');
        const syncBar = document.getElementById('sync-bar');
        const novaLabRepBar = document.getElementById('nova-lab-rep-bar');
        const ghostsRepBar = document.getElementById('ghosts-rep-bar');
        const rafiRepBar = document.getElementById('rafi-rep-bar');

        // Элементы обратной связи по изменению характеристик
        const logicFeedback = document.getElementById('logic-feedback');
        const empathyFeedback = document.getElementById('empathy-feedback');
        const syncFeedback = document.getElementById('sync-feedback');
        const novaLabRepFeedback = document.getElementById('nova-lab-rep-feedback');
        const ghostsRepFeedback = document.getElementById('ghosts-rep-feedback');
        const rafiRepFeedback = document.getElementById('rafi-rep-feedback');

        const miniGameSectionElem = document.getElementById('mini-game-section');
        const miniGameTitleElem = document.getElementById('mini-game-title');
        const miniGameContentElem = document.getElementById('mini-game-content');
        const miniGameSubmitBtn = document.getElementById('mini-game-submit');
        const miniGameMessageElem = document.getElementById('mini-game-message');
        const saveGameButton = document.getElementById('save-game-button');
        const loadGameButton = document.getElementById('load-game-button');
        const openJournalButton = document.getElementById('open-journal-button');
        const journalModal = document.getElementById('journal-modal');
        const journalEntriesContainer = document.getElementById('journal-entries');
        const journalCloseButton = document.getElementById('journal-close-button');
        const transitionOverlay = document.getElementById('transition-overlay');

        const saveLoadModal = document.getElementById('save-load-modal');
        const saveLoadSlotsContainer = document.getElementById('save-load-slots-container');
        const saveLoadCloseButton = document.getElementById('save-load-close-button');

        const NUM_SAVE_SLOTS = 5;
        const AUTOSAVE_SLOT = 'autosave';
        const QUICKSAVE_SLOT = 'quicksave';

        // Функция обновления отображения статистики
        function updateStatsUI() {
            logicStatElem.textContent = clientGameState.logic;
            empathyStatElem.textContent = clientGameState.empathy;
            syncStatElem.textContent = clientGameState.synchronization;
            novaLabRepStatElem.textContent = clientGameState.reputationNovaLab;
            ghostsRepStatElem.textContent = clientGameState.reputationGhosts;
            rafiRepStatElem.textContent = clientGameState.reputationRafi;

            const maxPrimaryStat = 15;
            const maxReputation = 10;

            logicBar.style.width = `${(clientGameState.logic / maxPrimaryStat) * 100}%`;
            empathyBar.style.width = `${(clientGameState.empathy / maxPrimaryStat) * 100}%`;
            syncBar.style.width = `${(clientGameState.synchronization / maxPrimaryStat) * 100}%`;

            novaLabRepBar.style.width = `${(Math.max(0, clientGameState.reputationNovaLab) / maxReputation) * 100}%`;
            ghostsRepBar.style.width = `${(Math.max(0, clientGameState.reputationGhosts) / maxReputation) * 100}%`;
            rafiRepBar.style.width = `${(Math.max(0, clientGameState.reputationRafi) / maxReputation) * 100}%`;
        }

        // Функция для показа временных сообщений (без модального окна)
        function showTemporaryMessage(element, message, duration = 3000) {
            const originalContent = element.innerHTML;
            element.innerHTML = message;
            element.classList.remove('hidden');

            setTimeout(() => {
                element.innerHTML = originalContent;
                if (element.id === miniGameMessageElem.id) {
                   element.classList.add('hidden');
                }
            }, duration);
        }

        // Функция для показа обратной связи по изменению характеристик
        function showStatFeedback(statElementId, valueChange) {
            const feedbackElement = document.getElementById(statElementId + '-feedback');
            if (!feedbackElement) return;

            feedbackElement.textContent = (valueChange > 0 ? '⬆️ +' : '⬇️ ') + Math.abs(valueChange);
            feedbackElement.classList.remove('increase', 'decrease');
            if (valueChange > 0) {
                feedbackElement.classList.add('increase');
            } else if (valueChange < 0) {
                feedbackElement.classList.add('decrease');
            }
            feedbackElement.classList.add('show');

            setTimeout(() => {
                feedbackElement.classList.remove('show');
                feedbackElement.textContent = '';
            }, 1000);
        }

        // --- ЛОГИКА СОХРАНЕНИЯ/ЗАГРУЗКИ В LOCALSTORAGE ---
        function saveGameToLocalStorage(slotName) {
            try {
                const stateToSave = JSON.parse(JSON.stringify(clientGameState)); // Глубокая копия
                stateToSave.timestamp = new Date().getTime();
                stateToSave.currentSceneDisplayName = gameData[clientGameState.currentScene]?.text.substring(0, 50) + '...'; // Сохраняем первые 50 символов для предпросмотра
                localStorage.setItem(`psychobridge_save_${slotName}`, JSON.stringify(stateToSave));
                showTemporaryMessage(narrativeTextElem, `Игра сохранена в слот "${slotName}"! 💾`, 2000);
            } catch (e) {
                console.error("Ошибка сохранения в LocalStorage:", e);
                showTemporaryMessage(narrativeTextElem, "Ошибка сохранения игры. ❌", 2000);
            }
        }

        function loadGameFromLocalStorage(slotName) {
            try {
                const savedData = localStorage.getItem(`psychobridge_save_${slotName}`);
                if (savedData) {
                    const loadedState = JSON.parse(savedData);
                    // Важно: начинаем с нового чистого состояния, затем применяем загруженные значения
                    // Это гарантирует, что новые записи журнала из gameData будут добавлены,
                    // а старые будут обновлены статусом unlocked.
                    const initial = getInitialGameState();
                    clientGameState = { ...initial, ...loadedState };

                    // Восстанавливаем записи журнала из initial, а потом применяем unlocked из loadedState
                    for (const key in initial.journal) {
                        if (clientGameState.journal && clientGameState.journal.hasOwnProperty(key)) {
                             // Если в загруженном состоянии есть эта запись, используем ее статус unlocked
                            if (loadedState.journal && loadedState.journal.hasOwnProperty(key) && loadedState.journal[key].unlocked !== undefined) {
                                clientGameState.journal[key].unlocked = loadedState.journal[key].unlocked;
                            }
                            // Если записи в загруженном состоянии нет или нет свойства unlocked, оставляем как в initial
                        } else {
                            // Если записи нет в initial, но она есть в loadedState, добавляем ее
                            // (хотя в этой архитектуре journal должен быть полный в initialGameState)
                            if (loadedState.journal && loadedState.journal.hasOwnProperty(key)) {
                                clientGameState.journal[key] = loadedState.journal[key];
                            }
                        }
                    }

                    // Если вдруг в loadedState есть записи, которых нет в initialGameState,
                    // добавляем их (это редкость для новелл, но для универсальности)
                    if (loadedState.journal) {
                        for (const key in loadedState.journal) {
                            if (!initial.journal.hasOwnProperty(key)) {
                                clientGameState.journal[key] = loadedState.journal[key];
                            }
                        }
                    }


                    updateStatsUI();
                    closeSaveLoadModal();
                    renderScene(clientGameState.currentScene); // Рендерим загруженную сцену
                    showTemporaryMessage(narrativeTextElem, `Игра загружена из слот "${slotName}"! 📂`, 2000);
                } else {
                    showTemporaryMessage(narrativeTextElem, `Слот "${slotName}" пуст.`, 2000);
                }
            } catch (e) {
                console.error("Ошибка загрузки из LocalStorage:", e);
                showTemporaryMessage(narrativeTextElem, "Ошибка загрузки игры. ❌", 2000);
            }
        }

        function getSaveSlotsData() {
            const slots = [];
            for (let i = 1; i <= NUM_SAVE_SLOTS; i++) {
                const slotId = `slot_${i}`;
                const savedData = localStorage.getItem(`psychobridge_save_${slotId}`);
                slots.push({
                    id: slotId,
                    displayName: `Слот ${i}`,
                    data: savedData ? JSON.parse(savedData) : null
                });
            }
            // Добавляем быстрые сохранения
            const autosaveData = localStorage.getItem(`psychobridge_save_${AUTOSAVE_SLOT}`);
            slots.push({
                id: AUTOSAVE_SLOT,
                displayName: 'Автосохранение',
                data: autosaveData ? JSON.parse(autosaveData) : null
            });
            const quicksaveData = localStorage.getItem(`psychobridge_save_${QUICKSAVE_SLOT}`);
            slots.push({
                id: QUICKSAVE_SLOT,
                displayName: 'Быстрое сохранение',
                data: quicksaveData ? JSON.parse(quicksaveData) : null
            });
            return slots;
        }

        // Функция для форматирования даты сохранения
        function formatSaveDate(timestamp) {
            if (!timestamp) return 'Пустой слот';
            const date = new Date(timestamp);
            return date.toLocaleString('ru-RU', {
                year: 'numeric', month: 'numeric', day: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        }

        // Функция для открытия модального окна сохранения/загрузки
        function openSaveLoadModal() {
            const slotsData = getSaveSlotsData();
            saveLoadSlotsContainer.innerHTML = '';
            slotsData.forEach(slot => {
                addSaveLoadSlot(slot.id, slot.displayName, slot.data);
            });
            saveLoadModal.classList.remove('hidden');
        }

        // Функция для закрытия модального окна сохранения/загрузки
        function closeSaveLoadModal() {
            saveLoadModal.classList.add('hidden');
        }

        function addSaveLoadSlot(slotName, displayName, slotData) {
            const slotElem = document.createElement('div');
            slotElem.classList.add('save-load-slot');

            let saveTime = null;
            let saveScenePreview = '';

            if (slotData && slotData.timestamp) {
                saveTime = slotData.timestamp;
                saveScenePreview = slotData.currentSceneDisplayName || 'Неизвестная сцена';
            }

            slotElem.innerHTML = `
                <div class="save-load-slot-info">
                    <span class="font-bold">${displayName}:</span> ${formatSaveDate(saveTime)}<br>
                    <span class="text-sm text-gray-400">Сцена: ${saveScenePreview || 'Нет данных'}</span>
                </div>
                <div class="save-load-slot-buttons">
                    <button class="save-slot-button" data-slot="${slotName}">Сохранить</button>
                    <button class="load-slot-button load" data-slot="${slotName}" ${!slotData ? 'disabled' : ''}>Загрузить</button>
                </div>
            `;
            saveLoadSlotsContainer.appendChild(slotElem);
        }

        saveGameButton.addEventListener('click', openSaveLoadModal);
        loadGameButton.addEventListener('click', openSaveLoadModal);
        saveLoadCloseButton.addEventListener('click', closeSaveLoadModal);

        saveLoadSlotsContainer.addEventListener('click', (event) => {
            if (event.target.classList.contains('save-slot-button')) {
                const slot = event.target.dataset.slot;
                saveGameToLocalStorage(slot);
            } else if (event.target.classList.contains('load-slot-button')) {
                const slot = event.target.dataset.slot;
                loadGameFromLocalStorage(slot);
            }
        });

        // Функция открытия журнала
        function openJournal() {
            journalEntriesContainer.innerHTML = '';
            let hasEntries = false;
            for (const key in clientGameState.journal) {
                if (clientGameState.journal[key].unlocked) {
                    const entry = document.createElement('div');
                    entry.classList.add('journal-entry');
                    entry.innerHTML = `<h4>${clientGameState.journal[key].title}</h4><p>${clientGameState.journal[key].content}</p>`;
                    if (clientGameState.journal[key].key) {
                        entry.innerHTML += `<p class="font-mono text-green-400 mt-2">${clientGameState.journal[key].key}</p>`;
                    }
                    journalEntriesContainer.appendChild(entry);
                    hasEntries = true;
                }
            }
            if (!hasEntries) {
                journalEntriesContainer.innerHTML = '<p class="text-center text-gray-400">Журнал пуст. Начните свое приключение, чтобы разблокировать записи!</p>';
            }
            journalModal.classList.remove('hidden');
        }

        function closeJournal() {
            journalModal.classList.add('hidden');
        }
        journalCloseButton.addEventListener('click', closeJournal);
        openJournalButton.addEventListener('click', openJournal);


        // Функция проверки выполнения требований
        function checkRequirements(requirements) {
            if (!requirements) return true;
            for (const stat in requirements) {
                if (clientGameState.hasOwnProperty(stat) && clientGameState[stat] < requirements[stat]) {
                    return false;
                }
            }
            return true;
        }

        // Функция для эффекта "печатания" текста
        let typeWriterIndex = 0;
        let typeWriterText = '';
        let typeWriterElement = null;
        let typeWriterSpeed = 20;

        function typeWriterEffect(element, text, speed) {
            typeWriterElement = element;
            typeWriterText = text;
            typeWriterSpeed = speed;
            typeWriterIndex = 0;
            typeWriterElement.innerHTML = '';
            typeNextCharacter();
        }

        function typeNextCharacter() {
            if (typeWriterIndex < typeWriterText.length) {
                // Обработка HTML-тегов, чтобы они не печатались по символу
                if (typeWriterText.substring(typeWriterIndex, typeWriterIndex + 1) === '<') {
                    const tagEnd = typeWriterText.indexOf('>', typeWriterIndex);
                    if (tagEnd !== -1) {
                        typeWriterElement.innerHTML += typeWriterText.substring(typeWriterIndex, tagEnd + 1);
                        typeWriterIndex = tagEnd + 1;
                    } else {
                        // Если тег некорректный или неполный, печатаем как обычный символ
                        typeWriterElement.innerHTML += typeWriterText.charAt(typeWriterIndex);
                        typeWriterIndex++;
                    }
                } else {
                    typeWriterElement.innerHTML += typeWriterText.charAt(typeWriterIndex);
                    typeWriterIndex++;
                }
                setTimeout(typeNextCharacter, typeWriterSpeed);
            }
        }

        // --- ЛОГИКА ИГРЫ (перенесена из server.js и адаптирована) ---

        // Вспомогательная функция для применения эффектов (от выборов или мини-игр)
        function applyEffects(effects) {
            if (!effects) return;
            for (const stat in effects) {
                const oldValue = clientGameState[stat];
                if (clientGameState.hasOwnProperty(stat)) {
                    clientGameState[stat] += effects[stat];
                    // Ограничение значений для основных характеристик
                    if (stat === 'logic' || stat === 'empathy' || stat === 'synchronization') {
                        clientGameState[stat] = Math.max(0, Math.min(15, clientGameState[stat]));
                    }
                    showStatFeedback(stat, clientGameState[stat] - oldValue);
                }
            }
        }

        // Вспомогательная функция для разблокировки записей журнала
        function unlockJournalEntries(journalIds) {
            if (journalIds) {
                journalIds.forEach(journalId => {
                    if (clientGameState.journal[journalId]) {
                        clientGameState.journal[journalId].unlocked = true;
                    }
                });
            }
        }

        // Функция определения концовки
        function determineEnding() {
            const { logic, empathy, synchronization, reputationNovaLab, reputationGhosts, reputationRafi, secretPathCounter, novaLabIsHostile } = clientGameState;

            // Пример сложной концовки (F) - "Смотритель симуляции"
            if (logic >= 10 && empathy >= 5 && synchronization >= 5 && secretPathCounter >= 3 && !novaLabIsHostile) {
                return 'ending-F';
            }
            // Пример концовки (E) - "Поглощение Прототипом"
            if (empathy > logic && synchronization < 5 && reputationNovaLab < -1) {
                return 'ending-E';
            }
            if (logic < 5 && (empathy > 8 || synchronization < 5) && !novaLabIsHostile) {
                return 'ending-E';
            }
            // Пример концовки (A) - "Путь Жертвы"
            if (logic >= 8 && empathy >= 7 && reputationNovaLab < 0) {
                return 'ending-A';
            }
            // Пример концовки (D) - "Хаотичный Эдем"
            if (empathy >= 8 && synchronization >= 8 && novaLabIsHostile && secretPathCounter >= 1) {
                return 'ending-D';
            }
            // Пример концовки (B) - "Путь Свободы"
            if (empathy >= 8 && synchronization >= 8) {
                return 'ending-B';
            }
            // Пример концовки (C) - "Путь Власти"
            if (logic >= 8 && (reputationNovaLab > 0 || !novaLabIsHostile) && secretPathCounter >= 1) {
                return 'ending-C';
            }
            if (logic >= 10) {
                return 'ending-C';
            }
            // По умолчанию
            return 'ending-A';
        }

        // Функция рендеринга текущей сцены
        function renderScene(sceneId) {
            const scene = gameData[sceneId];
            if (!scene) {
                console.error("Данные сцены не найдены для ID:", sceneId);
                narrativeTextElem.innerHTML = "Ошибка: Данные сцены не найдены. Пожалуйста, перезагрузите игру или начните новую.";
                choicesContainerElem.innerHTML = '';
                return;
            }

            transitionOverlay.classList.add('fade-out'); // Начало затемнения

            setTimeout(() => {
                clientGameState.currentScene = sceneId; // Обновляем текущую сцену
                updateStatsUI(); // Обновляем UI после возможного изменения состояния

                gameContainerElem.className = 'game-container'; // Сброс классов
                if (scene.background) {
                    gameContainerElem.classList.add(scene.background);
                }

                typeWriterEffect(narrativeTextElem, scene.text, 20); // Запускаем эффект печатания

                choicesContainerElem.innerHTML = ''; // Очищаем старые кнопки
                miniGameSectionElem.classList.add('hidden'); // Скрываем мини-игру
                miniGameContentElem.innerHTML = '';
                miniGameSubmitBtn.classList.add('hidden');
                miniGameMessageElem.textContent = '';

                // Разблокируем записи журнала, связанные с текущей сценой
                if (scene.unlockJournal) {
                    unlockJournalEntries(scene.unlockJournal);
                }

                const textDisplayDuration = scene.text.length * typeWriterSpeed; // Время на печать текста
                setTimeout(() => {
                    if (scene.isEnding) {
                        const restartButton = document.createElement('button');
                        restartButton.classList.add('choice-button');
                        restartButton.textContent = 'Начать заново 🔄';
                        restartButton.onclick = () => {
                            clientGameState = getInitialGameState(); // Сброс состояния
                            renderScene('prologue'); // Начать с пролога
                            saveGameToLocalStorage(AUTOSAVE_SLOT); // Автосохранить
                        };
                        choicesContainerElem.appendChild(restartButton);
                    } else if (scene.miniGame) {
                        startMiniGame(scene.miniGame.type, scene.miniGame.config);
                    } else if (scene.choices) {
                        scene.choices.forEach((choice, index) => {
                            const button = document.createElement('button');
                            button.classList.add('choice-button');
                            button.textContent = choice.text;
                            const requirementsMet = checkRequirements(choice.requirements);
                            button.disabled = !requirementsMet;
                            if (!requirementsMet) {
                                const requiredStats = Object.entries(choice.requirements).map(([stat, val]) => {
                                    let statName = '';
                                    if (stat === 'logic') statName = 'Логика';
                                    else if (stat === 'empathy') statName = 'Эмпатия';
                                    else if (stat === 'synchronization') statName = 'Синхронизация';
                                    else if (stat === 'reputationNovaLab') statName = 'Репутация Нова Лаб';
                                    else if (stat === 'reputationGhosts') statName = 'Репутация Призраков';
                                    else if (stat === 'reputationRafi') statName = 'Репутация Рафи';
                                    else if (stat === 'secretPathCounter') statName = 'Счетчик Секретного Пути';
                                    else if (stat === 'novaLabIsHostile') statName = 'Нова Лаб враждебна';
                                    return `Требуется: ${statName} ${val}`;
                                }).join(', ');
                                button.title = requiredStats;
                            }

                            button.onclick = () => {
                                applyEffects(choice.effects); // Применяем эффекты от выбора
                                if (choice.narrativeEffect) {
                                    showTemporaryMessage(narrativeTextElem, choice.narrativeEffect, 1500);
                                }

                                let nextSceneId = choice.nextScene;
                                // Если это сцена "climax-truth", определяем концовку
                                if (sceneId === 'climax-truth') {
                                    nextSceneId = determineEnding();
                                }
                                renderScene(nextSceneId);
                                saveGameToLocalStorage(AUTOSAVE_SLOT); // Автосохранение после каждого выбора
                            };
                            choicesContainerElem.appendChild(button);
                        });
                    }
                }, textDisplayDuration + 100);

                transitionOverlay.classList.remove('fade-out'); // Завершение затемнения
            }, 800); // Время задержки для затемнения
        }


        // ФУНКЦИИ МИНИ-ИГР (большей частью остаются на клиенте)
        function startMiniGame(gameType, config) {
            clientGameState.currentMiniGame = gameType;
            miniGameSectionElem.classList.remove('hidden');
            miniGameMessageElem.textContent = '';
            choicesContainerElem.innerHTML = ''; // Скрываем кнопки выбора во время мини-игры

            if (gameType === 'memoryHack') {
                startMemoryHackGame(config);
            } else if (gameType === 'decryptor') {
                startDecryptorGame(config);
            } else if (gameType === 'energyFlow') {
                startEnergyFlowGame(config);
            } else if (gameType === 'laserMaze') {
                startLaserMazeGame(config);
            }
        }

        function endMiniGame(success, outcomeConfig) {
            if (clientGameState.laserMaze.gameRunning) {
                clientGameState.laserMaze.gameRunning = false;
                cancelAnimationFrame(clientGameState.laserMaze.animationFrameId);
                document.removeEventListener('keydown', handleLaserMazeInput);
            }

            miniGameSectionElem.classList.add('hidden');
            miniGameContentElem.innerHTML = '';
            miniGameSubmitBtn.classList.add('hidden');

            applyEffects(outcomeConfig.effects); // Применяем эффекты от мини-игры
            showTemporaryMessage(narrativeTextElem, outcomeConfig.narrative, 1500);

            clientGameState.currentScene = outcomeConfig.nextScene; // Переходим к следующей сцене
            renderScene(clientGameState.currentScene);
            saveGameToLocalStorage(AUTOSAVE_SLOT); // Автосохранение после мини-игры

            clientGameState.currentMiniGame = null;
        }


        // Memory Hack Mini-Game
        function startMemoryHackGame(config) {
            miniGameSectionElem.classList.remove('hidden');
            miniGameTitleElem.textContent = 'Взлом Памяти: Синхронизируйте Фрагменты';
            miniGameContentElem.innerHTML = '<div id="memory-grid" class="memory-grid"></div><p id="memory-attempts-left" class="text-sm text-gray-400 mt-2"></p>';
            miniGameSubmitBtn.classList.add('hidden');

            const memoryGridElem = document.getElementById('memory-grid');
            const attemptsLeftElem = document.getElementById('memory-attempts-left');

            clientGameState.memoryHack.cards = [];
            clientGameState.memoryHack.flippedCards = [];
            clientGameState.memoryHack.matchedPairs = 0;
            // Кол-во попыток зависит от синхронизации
            clientGameState.memoryHack.attempts = clientGameState.synchronization > 0 ? Math.floor(clientGameState.synchronization * 1.5) + 5 : 5;

            let shuffledSymbols = [...clientGameState.memoryHack.symbols, ...clientGameState.memoryHack.symbols];
            shuffledSymbols.sort(() => Math.random() - 0.5);

            shuffledSymbols.forEach((symbol, index) => {
                const card = document.createElement('div');
                card.classList.add('memory-card');
                card.dataset.symbol = symbol;
                card.dataset.index = index;
                card.innerHTML = `<div class="card-inner"><div class="card-face card-front"></div><div class="card-face card-back">${symbol}</div></div>`;
                memoryGridElem.appendChild(card);
                clientGameState.memoryHack.cards.push(card);

                card.addEventListener('click', () => flipCard(card, config));
            });
            attemptsLeftElem.textContent = `Попыток осталось: ${clientGameState.memoryHack.attempts}`;
        }

        function flipCard(card, config) {
            if (card.classList.contains('flipped') || card.classList.contains('matched') || clientGameState.memoryHack.flippedCards.length === 2) {
                return;
            }

            card.classList.add('flipped');
            clientGameState.memoryHack.flippedCards.push(card);

            if (clientGameState.memoryHack.flippedCards.length === 2) {
                clientGameState.memoryHack.attempts--;
                document.getElementById('memory-attempts-left').textContent = `Попыток осталось: ${clientGameState.memoryHack.attempts}`;
                const [card1, card2] = clientGameState.memoryHack.flippedCards;

                if (card1.dataset.symbol === card2.dataset.symbol) {
                    card1.classList.add('matched');
                    card2.classList.add('matched');
                    clientGameState.memoryHack.matchedPairs++;
                    clientGameState.memoryHack.flippedCards = [];
                    miniGameMessageElem.textContent = 'Совпадение! ✅';
                    miniGameMessageElem.classList.remove('hidden');

                    if (clientGameState.memoryHack.matchedPairs === clientGameState.memoryHack.symbols.length) {
                        setTimeout(() => {
                            endMiniGame(true, config.success);
                        }, 500);
                    }
                } else {
                    miniGameMessageElem.textContent = 'Не совпало. ❌';
                    miniGameMessageElem.classList.remove('hidden');
                    setTimeout(() => {
                        card1.classList.remove('flipped');
                        card2.classList.remove('flipped');
                        clientGameState.memoryHack.flippedCards = [];
                        miniGameMessageElem.classList.add('hidden');

                        if (clientGameState.memoryHack.attempts <= 0) {
                            endMiniGame(false, config.failure);
                        }
                    }, 1000);
                }
            }
        }

        // Decryptor Mini-Game
        function startDecryptorGame(config) {
            miniGameSectionElem.classList.remove('hidden');
            miniGameTitleElem.textContent = 'Дешифратор: Введите Ключ';
            miniGameContentElem.innerHTML = '<div id="decryptor-input-group" class="decryptor-input-group"></div>';
            miniGameSubmitBtn.classList.remove('hidden');

            const keyLength = config.correctKey.length;
            const inputGroup = document.getElementById('decryptor-input-group');
            clientGameState.decryptor.inputValues = Array(keyLength).fill('');

            for (let i = 0; i < keyLength; i++) {
                const input = document.createElement('input');
                input.type = 'text';
                input.maxLength = 1;
                input.classList.add('decryptor-input', 'bg-gray-700', 'text-white', 'p-2', 'rounded');
                input.dataset.index = i;
                input.addEventListener('input', (e) => {
                    e.target.value = e.target.value.toUpperCase();
                    clientGameState.decryptor.inputValues[i] = e.target.value;
                    if (e.target.value && i < keyLength - 1) {
                        inputGroup.children[i + 1].focus();
                    }
                });
                 input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && e.target.value === '' && i > 0) {
                        inputGroup.children[i - 1].focus();
                    }
                });
                inputGroup.appendChild(input);
            }
            miniGameSubmitBtn.onclick = () => checkDecryptor(config);
        }

        function checkDecryptor(config) {
            const enteredKey = clientGameState.decryptor.inputValues.join('');
            if (enteredKey === config.correctKey) {
                miniGameMessageElem.textContent = 'Ключ успешно дешифрован! ✅';
                miniGameMessageElem.classList.remove('hidden');
                endMiniGame(true, config.success);
            } else {
                miniGameMessageElem.textContent = 'Неверный ключ. Попробуйте еще. ❌';
                miniGameMessageElem.classList.remove('hidden');
                setTimeout(() => { miniGameMessageElem.classList.add('hidden'); }, 1500);
            }
        }

        // Energy Flow Mini-Game
        function startEnergyFlowGame(config) {
            miniGameSectionElem.classList.remove('hidden');
            miniGameTitleElem.textContent = 'Поток Энергии: Балансировка Цепей';
            miniGameContentElem.innerHTML = `
                <div class="energy-node">
                    <label>Узел 1 (Высокий >8): <span id="energy-node1-value">${clientGameState.energyFlow.node1}</span></label>
                    <div class="energy-buttons">
                        <button data-node="node1" data-change="-1">-</button>
                        <button data-node="node1" data-change="1">+</button>
                    </div>
                </div>
                <div class="energy-node">
                    <label>Узел 2 (Низкий <3): <span id="energy-node2-value">${clientGameState.energyFlow.node2}</span></label>
                    <div class="energy-buttons">
                        <button data-node="node2" data-change="-1">-</button>
                        <button data-node="node2" data-change="1">+</button>
                    </div>
                </div>
                <div class="energy-node">
                    <label>Узел 3 (Низкий <3): <span id="energy-node3-value">${clientGameState.energyFlow.node3}</span></label>
                    <div class="energy-buttons">
                        <button data-node="node3" data-change="-1">-</button>
                        <button data-node="node3" data-change="1">+</button>
                    </div>
                </div>
                <p class="text-sm text-gray-400 mt-2">Всего энергии: <span id="total-energy-value">${clientGameState.energyFlow.node1 + clientGameState.energyFlow.node2 + clientGameState.energyFlow.node3}</span></p>
                <p id="energy-flow-message" class="text-red-300"></p>
            `;
            miniGameSubmitBtn.classList.remove('hidden');
            miniGameSubmitBtn.textContent = 'Проверить Баланс';

            const energyButtons = miniGameContentElem.querySelectorAll('.energy-buttons button');
            energyButtons.forEach(button => {
                button.addEventListener('click', (e) => adjustEnergy(e.target.dataset.node, parseInt(e.target.dataset.change), config));
            });
            miniGameSubmitBtn.onclick = () => checkEnergyFlow(config);
        }

        function adjustEnergy(node, change, config) {
            const currentNodeValue = clientGameState.energyFlow[node];

            if (change < 0 && currentNodeValue <= 0) {
                 miniGameMessageElem.textContent = 'Узел пуст! ⚡';
                miniGameMessageElem.classList.remove('hidden');
                setTimeout(() => { miniGameMessageElem.classList.add('hidden'); }, 1500);
                return;
            }

            if (change > 0 && currentNodeValue >= 15) {
                 miniGameMessageElem.textContent = 'Узел переполнен! ⚡';
                miniGameMessageElem.classList.remove('hidden');
                setTimeout(() => { miniGameMessageElem.classList.add('hidden'); }, 1500);
                return;
            }

            clientGameState.energyFlow[node] += change;
            document.getElementById(`energy-${node}-value`).textContent = clientGameState.energyFlow[node];
            document.getElementById('total-energy-value').textContent = clientGameState.energyFlow.node1 + clientGameState.energyFlow.node2 + clientGameState.energyFlow.node3;
        }

        function checkEnergyFlow(config) {
            const node1 = clientGameState.energyFlow.node1;
            const node2 = clientGameState.energyFlow.node2;
            const node3 = clientGameState.energyFlow.node3;

            if (node1 > 8 && node2 < 3 && node3 < 3) {
                miniGameMessageElem.textContent = 'Баланс установлен! ✅';
                miniGameMessageElem.classList.remove('hidden');
                endMiniGame(true, config.success);
            } else {
                miniGameMessageElem.textContent = 'Баланс не достигнут. Попробуйте еще. ❌';
                miniGameMessageElem.classList.remove('hidden');
                setTimeout(() => { miniGameMessageElem.classList.add('hidden'); }, 1500);
            }
        }


        // Laser Maze Mini-Game
        function startLaserMazeGame(config) {
            miniGameSectionElem.classList.remove('hidden');
            miniGameTitleElem.textContent = 'Лазерный Лабиринт: Стелс-Проникновение';
            miniGameContentElem.innerHTML = '<canvas id="laser-maze-canvas" width="600" height="400" class="border"></canvas>';
            miniGameSubmitBtn.classList.add('hidden');

            // Инициализация параметров мини-игры (внутри clientGameState)
            clientGameState.laserMaze.canvas = document.getElementById('laser-maze-canvas');
            clientGameState.laserMaze.ctx = clientGameState.laserMaze.canvas.getContext('2d');
            clientGameState.laserMaze.playerX = 50;
            clientGameState.laserMaze.playerY = clientGameState.laserMaze.canvas.height / 2;
            clientGameState.laserMaze.lasers = [];
            clientGameState.laserMaze.gameRunning = true;

            for (let i = 0; i < (clientGameState.synchronization > 8 ? 3 : 5); i++) { // Сложность зависит от синхронизации
                clientGameState.laserMaze.lasers.push({
                    x: Math.random() * (clientGameState.laserMaze.canvas.width - 100) + 100,
                    y: Math.random() * clientGameState.laserMaze.canvas.height,
                    length: 150,
                    direction: Math.random() < 0.5 ? 1 : -1
                });
            }

            document.addEventListener('keydown', handleLaserMazeInput);

            function gameLoop() {
                if (!clientGameState.laserMaze.gameRunning) {
                    cancelAnimationFrame(clientGameState.laserMaze.animationFrameId);
                    return;
                }
                updateLaserMaze();
                drawLaserMaze();
                clientGameState.laserMaze.animationFrameId = requestAnimationFrame(gameLoop);
            }

            function updateLaserMaze() {
                clientGameState.laserMaze.lasers.forEach(laser => {
                    laser.y += clientGameState.laserMaze.laserSpeed * laser.direction;
                    if (laser.y < 0 || laser.y > clientGameState.laserMaze.canvas.height) {
                        laser.direction *= -1;
                    }
                });

                clientGameState.laserMaze.lasers.forEach(laser => {
                    if (checkCollision(clientGameState.laserMaze.playerX, clientGameState.laserMaze.playerY, clientGameState.laserMaze.playerSize, laser)) {
                        clientGameState.laserMaze.gameRunning = false;
                        document.removeEventListener('keydown', handleLaserMazeInput);
                        endMiniGame(false, config.failure);
                    }
                });

                if (clientGameState.laserMaze.playerX + clientGameState.laserMaze.playerSize / 2 >= clientGameState.laserMaze.canvas.width - 20) {
                    clientGameState.laserMaze.gameRunning = false;
                    document.removeEventListener('keydown', handleLaserMazeInput);
                    endMiniGame(true, config.success);
                }
            }

            function drawLaserMaze() {
                const ctx = clientGameState.laserMaze.ctx;
                const canvas = clientGameState.laserMaze.canvas;
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                ctx.fillStyle = '#e94560';
                ctx.fillRect(clientGameState.laserMaze.playerX - clientGameState.laserMaze.playerSize / 2, clientGameState.laserMaze.playerY - clientGameState.laserMaze.playerSize / 2, clientGameState.laserMaze.playerSize, clientGameState.laserMaze.playerSize);

                ctx.fillStyle = '#ff0000';
                clientGameState.laserMaze.lasers.forEach(laser => {
                    ctx.fillRect(laser.x, laser.y, 5, laser.length);
                });
            }

            function checkCollision(playerX, playerY, playerSize, laser) {
                return playerX < laser.x + 5 &&
                       playerX + playerSize > laser.x &&
                       playerY < laser.y + laser.length &&
                       playerY + playerSize > laser.y;
            }

            function handleLaserMazeInput(event) {
                const playerSpeed = 15;
                switch (event.key) {
                    case 'ArrowUp':
                    case 'w':
                    case 'W':
                        clientGameState.laserMaze.playerY = Math.max(0 + clientGameState.laserMaze.playerSize / 2, clientGameState.laserMaze.playerY - playerSpeed);
                        break;
                    case 'ArrowDown':
                    case 's':
                    case 'S':
                        clientGameState.laserMaze.playerY = Math.min(clientGameState.laserMaze.canvas.height - clientGameState.laserMaze.playerSize / 2, clientGameState.laserMaze.playerY + playerSpeed);
                        break;
                    case 'ArrowLeft':
                    case 'a':
                    case 'A':
                        clientGameState.laserMaze.playerX = Math.max(0 + clientGameState.laserMaze.playerSize / 2, clientGameState.laserMaze.playerX - playerSpeed);
                        break;
                    case 'ArrowRight':
                    case 'd':
                    case 'D':
                        clientGameState.laserMaze.playerX = Math.min(clientGameState.laserMaze.canvas.width - clientGameState.laserMaze.playerSize / 2, clientGameState.laserMaze.playerX + playerSpeed);
                        break;
                }
            }
            gameLoop(); // Запускаем игровой цикл
        }

        // Инициализация игры при загрузке страницы
        window.onload = () => {
            // Попытаться загрузить автосохранение при запуске
            loadGameFromLocalStorage(AUTOSAVE_SLOT);
            if (!clientGameState.currentScene) { // Если автосохранения нет или оно пустое, начать новую игру
                clientGameState = getInitialGameState();
            }
            renderScene(clientGameState.currentScene); // Рендерим текущую сцену
        };
    </script>
</body>
</html>