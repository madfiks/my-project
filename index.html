<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Наше Путешествие Любви: Признание</title>
    <!-- Подключение Tailwind CSS для быстрой и адаптивной верстки -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Подключение шрифтов Google Fonts: Playfair Display для заголовков, Inter для основного текста -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Подключение Font Awesome для иконок, используемых в различных секциях -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* --- Общие стили и переменные --- */
        :root {
            --primary-color: #ff6b6b; /* Нежно-розовый */
            --secondary-color: #ffa07a; /* Светло-оранжевый */
            --text-dark: #333;
            --text-light: #f0f4f8;
            --bg-light: #f0f4f8;
            --bg-medium: #d9e2ec;
            --card-bg: rgba(255, 255, 255, 0.95);
            --shadow-light: 0 5px 15px rgba(0, 0, 0, 0.08);
            --shadow-medium: 0 10px 30px rgba(0, 0, 0, 0.15);
            --shadow-strong: 0 20px 60px rgba(0, 0, 0, 0.25);
        }

        body {
            font-family: 'Inter', sans-serif;
            color: var(--text-dark);
            line-height: 1.7;
            margin: 0;
            padding: 0;
            overflow-x: hidden; /* Предотвращаем горизонтальную прокрутку */
            background: linear-gradient(135deg, var(--bg-light) 0%, var(--bg-medium) 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            position: relative; /* Для позиционирования фоновых элементов */
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Playfair Display', serif;
            color: var(--text-dark);
            margin-bottom: 1rem;
            line-height: 1.2;
        }

        p {
            margin-bottom: 1rem;
        }

        /* --- Фоновые анимации --- */
        .background-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at top left, rgba(255, 107, 107, 0.1) 0%, transparent 30%),
                        radial-gradient(circle at bottom right, rgba(255, 160, 122, 0.1) 0%, transparent 30%);
            animation: pulse-gradient 15s infinite alternate ease-in-out;
            z-index: -1; /* Под основным контентом */
            pointer-events: none; /* Не мешает взаимодействию */
        }

        @keyframes pulse-gradient {
            0% { background-size: 150% 150%; background-position: 0% 0%; }
            50% { background-size: 170% 170%; background-position: 100% 100%; }
            100% { background-size: 150% 150%; background-position: 0% 0%; }
        }

        /* Анимация "падающих сердечек" */
        .heart {
            position: absolute;
            background-color: var(--primary-color);
            transform: rotate(-45deg);
            animation: fall 15s linear infinite;
            opacity: 0;
            pointer-events: none;
            z-index: 0;
        }
        .heart::before, .heart::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background-color: inherit;
            border-radius: 50%;
        }
        .heart::before { top: -50%; left: 0; }
        .heart::after { top: 0; left: 50%; }

        @keyframes fall {
            0% { transform: translateY(-100px) rotate(-45deg); opacity: 0; }
            10% { opacity: 0.6; }
            80% { opacity: 0.6; }
            100% { transform: translateY(100vh) rotate(-45deg); opacity: 0; }
        }

        /* Стили для Canvas частиц */
        #particles-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2; /* Под всеми остальными фонами */
            pointer-events: none;
        }

        /* --- Стили для секций (теперь как контент вкладок) --- */
        .tab-content {
            display: none; /* По умолчанию скрыты */
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 4rem 2rem;
            /* Улучшенная анимация появления контента вкладки */
            animation: fadeInScaleUp 0.8s ease-out forwards;
            min-height: calc(100vh - 120px - 80px); /* Высота экрана минус навигация и футер */
            box-sizing: border-box; /* Учитываем padding в высоте */
        }
        .tab-content.active {
            display: block; /* Активная вкладка показывается */
        }

        @keyframes fadeInScaleUp {
            from { opacity: 0; transform: translateY(30px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .section-heading {
            text-align: center;
            font-size: 3.5rem; /* md:text-5xl lg:text-6xl */
            font-weight: 700;
            margin-bottom: 3rem;
            color: var(--primary-color);
            text-shadow: 2px 2px 5px rgba(0,0,0,0.05);
            position: relative;
        }
        .section-heading::after {
            content: '';
            display: block;
            width: 80px;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            margin: 1.5rem auto 0;
            border-radius: 2px;
        }

        /* --- Навигация по вкладкам --- */
        .tabs-nav {
            background-color: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(15px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            width: 100%;
            z-index: 100;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .tab-button {
            padding: 0.75rem 1.5rem;
            border-radius: 9999px; /* Полностью скругленные углы */
            font-weight: 600;
            color: var(--text-dark);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            background-color: transparent;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
        }
        .tab-button::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            transition: width 0.3s ease;
            border-radius: 2px;
        }
        .tab-button:hover {
            color: var(--primary-color);
        }
        .tab-button:hover::before {
            width: 100%;
        }
        .tab-button.active {
            color: white;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            box-shadow: var(--shadow-light);
            transform: translateY(-2px);
        }
        .tab-button.active::before {
            width: 0; /* Убираем нижнюю полосу для активной кнопки */
        }

        /* --- Hero Section --- */
        .hero-section {
            min-height: calc(100vh - 80px); /* Высота экрана минус навигация */
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.8) 0%, rgba(255, 255, 255, 0.95) 100%);
            padding: 4rem 2rem;
            position: relative;
            z-index: 1;
        }

        .hero-card {
            background-color: var(--card-bg);
            backdrop-filter: blur(20px);
            box-shadow: var(--shadow-medium);
            border-radius: 2rem;
            padding: 3rem;
            max-width: 800px;
            width: 100%;
            animation: scaleIn 1.5s ease-out forwards; /* Анимация появления карточки */
        }

        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .hero-image {
            border: 5px solid var(--primary-color);
            box-shadow: var(--shadow-light);
            transition: transform 0.3s ease-in-out;
        }
        .hero-image:hover {
            transform: scale(1.05) rotate(2deg);
        }

        /* Текст пишущей машинки теперь просто отображается */
        .typewriter-text {
            font-weight: 600;
        }

        /* --- Our Story Section --- */
        .story-timeline {
            position: relative;
            padding-left: 2rem;
            border-left: 3px solid var(--primary-color);
        }
        .timeline-item {
            margin-bottom: 3rem;
            position: relative;
            padding-left: 2rem;
            opacity: 0; /* Изначально скрыты для анимации */
            transform: translateY(20px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }
        .timeline-item.active {
            opacity: 1;
            transform: translateY(0);
        }
        .timeline-date {
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        /* --- Qualities Section --- */
        .quality-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
        }
        .quality-item {
            background-color: var(--card-bg);
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: var(--shadow-light);
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            border: 1px solid rgba(255, 107, 107, 0.1);
            opacity: 0; /* Изначально скрыты для анимации */
            transform: translateY(20px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
            position: relative; /* Для кнопки удаления */
        }
        .quality-item.active {
            opacity: 1;
            transform: translateY(0);
        }
        .quality-item:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-medium);
        }
        .quality-icon {
            color: var(--primary-color);
            font-size: 2.5rem;
            margin-bottom: 1rem;
            transition: transform 0.3s ease-in-out;
        }
        .quality-item:hover .quality-icon {
            transform: scale(1.1);
        }
        .quality-delete-btn {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background-color: rgba(255, 0, 0, 0.1);
            color: #ff0000;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8rem;
            opacity: 0.7;
            transition: opacity 0.2s ease-in-out, background-color 0.2s ease-in-out;
        }
        .quality-delete-btn:hover {
            opacity: 1;
            background-color: rgba(255, 0, 0, 0.2);
        }


        /* --- Future Dreams Section --- */
        .dream-gallery img {
            border-radius: 1.5rem;
            box-shadow: var(--shadow-light);
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            border: 3px solid var(--secondary-color);
            opacity: 0; /* Изначально скрыты для анимации */
            transform: scale(0.95);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }
        .dream-gallery img.active {
            opacity: 1;
            transform: scale(1);
        }
        .dream-gallery img:hover {
            transform: scale(1.03);
            box-shadow: var(--shadow-medium);
        }

        /* --- Modal для изображений --- */
        .image-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200; /* Выше всего */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-out, visibility 0.3s ease-out;
        }
        .image-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .image-modal-content {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 1rem;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
            transform: scale(0.8);
            transition: transform 0.3s ease-out;
        }
        .image-modal-overlay.active .image-modal-content {
            transform: scale(1);
        }
        .image-modal-close {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            background: none;
            border: none;
            font-size: 2.5rem;
            color: white;
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
        }
        .image-modal-close:hover {
            transform: rotate(90deg);
        }

        /* --- Final Message Section --- */
        .final-message-card {
            background-color: var(--card-bg);
            backdrop-filter: blur(15px);
            box-shadow: var(--shadow-strong);
            border-radius: 2.5rem;
            padding: 4rem;
            max-width: 900px;
            width: 100%;
            text-align: center;
            position: relative;
            overflow: hidden;
            opacity: 0; /* Изначально скрыты для анимации */
            transform: translateY(30px);
            animation: fadeInScaleUp 0.8s ease-out forwards; /* Используем ту же анимацию, что и для вкладок */
        }
        .final-message-card.active {
            opacity: 1;
            transform: translateY(0);
        }

        .final-message-card::before {
            content: '';
            position: absolute;
            top: -20px;
            left: -20px;
            right: -20px;
            bottom: -20px;
            background: linear-gradient(45deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            z-index: -1;
            filter: blur(30px); /* Эффект свечения */
            opacity: 0.3;
            animation: pulse-glow 5s infinite alternate;
        }

        @keyframes pulse-glow {
            0% { transform: scale(1); opacity: 0.3; }
            50% { transform: scale(1.05); opacity: 0.5; }
            100% { transform: scale(1); opacity: 0.3; }
        }

        .signature {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-top: 3rem;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
        }

        /* --- Countdown Section --- */
        .countdown-container {
            text-align: center;
            padding: 3rem;
            background-color: var(--card-bg);
            border-radius: 2rem;
            box-shadow: var(--shadow-medium);
            max-width: 700px;
            margin: 0 auto;
            opacity: 0;
            transform: translateY(30px);
            animation: fadeInScaleUp 0.8s ease-out forwards;
        }
        .countdown-container.active {
            opacity: 1;
            transform: translateY(0);
        }

        .countdown-heading {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 2rem;
        }

        .countdown-timer {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .countdown-item {
            background-color: var(--bg-light);
            padding: 1.5rem 1rem;
            border-radius: 1rem;
            box-shadow: var(--shadow-light);
            min-width: 100px;
        }

        .countdown-value {
            font-size: 3.5rem;
            font-weight: 700;
            color: var(--secondary-color);
            line-height: 1;
            margin-bottom: 0.5rem;
        }

        .countdown-label {
            font-size: 1rem;
            color: var(--primary-color);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* --- Footer --- */
        footer {
            background-color: var(--text-dark);
            color: var(--text-light);
            padding: 3rem 0;
            margin-top: 5rem;
            width: 100%;
            text-align: center;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.1);
        }
        footer a {
            color: var(--secondary-color);
            transition: color 0.3s ease;
        }
        footer a:hover {
            color: var(--primary-color);
        }

        /* --- Адаптивность (Медиа-запросы) --- */
        @media (max-width: 1024px) {
            .section-heading {
                font-size: 3rem;
            }
            .hero-card {
                padding: 2.5rem;
            }
            .final-message-card {
                padding: 3rem;
            }
            .countdown-value {
                font-size: 3rem;
            }
        }

        @media (max-width: 768px) {
            .tabs-nav ul {
                flex-wrap: wrap;
                justify-content: center;
            }
            .tab-button {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
                margin: 0.25rem;
            }
            .tab-content {
                padding: 3rem 1.5rem;
            }
            .section-heading {
                font-size: 2.5rem;
                margin-bottom: 2rem;
            }
            .hero-card {
                padding: 2rem;
            }
            .hero-image {
                width: 120px;
                height: 120px;
            }
            .story-timeline {
                padding-left: 1.5rem;
            }
            .timeline-item::before {
                left: -1.8rem;
                width: 1rem;
                height: 1rem;
            }
            .quality-item {
                padding: 1.5rem;
            }
            .quality-icon {
                font-size: 2rem;
            }
            .final-message-card {
                padding: 2.5rem;
                border-radius: 2rem;
            }
            .signature {
                font-size: 2rem;
            }
            .countdown-value {
                font-size: 2.5rem;
            }
            .countdown-item {
                min-width: 80px;
                padding: 1rem 0.5rem;
            }
            .countdown-label {
                font-size: 0.8rem;
            }
        }

        @media (max-width: 480px) {
            .tabs-nav {
                padding: 0.5rem 0;
            }
            .tab-button {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
            }
            .section-heading {
                font-size: 2rem;
            }
            .hero-card {
                padding: 1.5rem;
                border-radius: 1.5rem;
            }
            .hero-image {
                width: 100px;
                height: 100px;
            }
            .story-timeline {
                padding-left: 1rem;
                border-left: 2px solid var(--primary-color);
            }
            .timeline-item::before {
                left: -1.3rem;
                width: 0.8rem;
                height: 0.8rem;
                border: 2px solid var(--bg-light);
                box-shadow: 0 0 0 2px var(--primary-color);
            }
            .final-message-card {
                padding: 1.5rem;
                border-radius: 1.5rem;
            }
            .signature {
                font-size: 1.5rem;
            }
            .countdown-value {
                font-size: 2rem;
            }
            .countdown-item {
                min-width: 70px;
                padding: 0.75rem 0.25rem;
            }
            .countdown-label {
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body>
    <!-- Фоновый анимированный оверлей для создания мягкого свечения -->
    <div class="background-overlay"></div>

    <!-- Контейнер для падающих сердечек -->
    <div id="heart-container" class="absolute inset-0 overflow-hidden pointer-events-none z-0"></div>

    <!-- Canvas для фоновых частиц -->
    <canvas id="particles-canvas"></canvas>

    <!-- Аудио элемент для фоновой музыки -->
    <audio id="backgroundMusic" loop autoplay style="display: none;">
        <!-- Пример аудио: "SoundHelix-Song-1.mp3" от SoundHelix.com -->
        <source src="" type="audio/mpeg">
        Ваш браузер не поддерживает элемент аудио.
    </audio>

    <!-- --- Навигация по вкладкам --- -->
    <nav class="tabs-nav">
        <ul class="flex justify-center space-x-2 md:space-x-4">
            <li><button class="tab-button active" data-tab="hero-tab">Главная</button></li>
            <li><button class="tab-button" data-tab="our-story-tab">Наша История</button></li>
            <li><button class="tab-button" data-tab="qualities-tab">Что я люблю</button></li>
            <li><button class="tab-button" data-tab="future-dreams-tab">Наши Мечты</button></li>
            <li><button class="tab-button" data-tab="countdown-tab">Обратный отсчет</button></li> <!-- Новая вкладка -->
            <li><button class="tab-button" data-tab="final-message-tab">Послание</button></li>
            <li><button class="tab-button" data-tab="settings-tab">Настройки</button></li>
        </ul>
    </nav>

    <!-- --- Контент вкладок --- -->

    <!-- Вкладка "Главная" (бывшая Hero Section) -->
    <div id="hero-tab" class="tab-content active bg-white rounded-3xl shadow-xl mt-8">
        <section class="hero-section w-full">
            <div class="hero-card">
                <!-- Место для фотографии, теперь динамическое -->
                <div class="mb-8">
                    <img id="mainHeroImage" src="https://placehold.co/150x150/FF6B6B/FFFFFF?text=Фото" alt="Фото получателя"
                         class="hero-image w-40 h-40 rounded-full mx-auto object-cover">
                </div>

                <h1 class="playfair-display text-5xl md:text-6xl lg:text-7xl font-bold text-gray-800 mb-6 leading-tight">
                    Моему единственному человеку
                </h1>

                <p class="text-xl md:text-2xl text-gray-700 mb-8 typewriter-text" id="typewriter-text-hero">
                    Ты — моя самая большая радость.
                </p>

                <p id="mainIntroText" class="text-lg md:text-xl text-gray-600 mb-10">
                    Добро пожаловать в историю, написанную моим сердцем, только для тебя.
                </p>

                <!-- Кнопка для перехода на вкладку "Наша История" -->
                <button class="inline-block bg-gradient-to-r from-pink-500 to-orange-400 text-white font-semibold py-4 px-10 rounded-full text-lg md:text-xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 uppercase tracking-wide focus:outline-none focus:ring-4 focus:ring-pink-300 focus:ring-opacity-75"
                        onclick="showTab('our-story-tab')">
                    Начать наше путешествие <i class="fas fa-arrow-right ml-2"></i>
                </button>

                <!-- Кнопка "Поделиться" -->
                <button id="shareButton" class="mt-4 inline-block bg-gray-200 text-gray-700 font-semibold py-3 px-8 rounded-full text-lg shadow-md hover:shadow-xl transform hover:scale-105 transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-gray-300 focus:ring-opacity-75">
                    <i class="fas fa-share-alt mr-2"></i> Поделиться
                </button>
                <p id="shareMessage" class="text-center text-sm mt-2"></p>
            </div>
        </section>
    </div>

    <!-- Вкладка "Наша История" -->
    <div id="our-story-tab" class="tab-content bg-white rounded-3xl shadow-xl mt-8">
        <section class="w-full">
            <h2 class="section-heading playfair-display">Наша История</h2>
            <p class="text-center text-lg text-gray-700 mb-12 max-w-2xl mx-auto">
                Добавьте свои самые дорогие моменты в нашу общую историю!
            </p>

            <!-- Форма для добавления новой записи в историю -->
            <div class="max-w-2xl mx-auto p-6 bg-pink-50 rounded-xl shadow-md mb-10 border border-pink-100">
                <h3 class="font-semibold text-xl text-gray-800 mb-4 text-center">Добавить новый момент</h3>
                <div class="mb-4">
                    <label for="storyDate" class="block text-gray-700 text-sm font-bold mb-2">Дата (например, 2023 год, Весна):</label>
                    <input type="text" id="storyDate" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-pink-300" placeholder="Например, 2023 год, Весна">
                </div>
                <div class="mb-4">
                    <label for="storyTitle" class="block text-gray-700 text-sm font-bold mb-2">Заголовок:</label>
                    <input type="text" id="storyTitle" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-pink-300" placeholder="Например, Наше первое знакомство">
                </div>
                <div class="mb-6">
                    <label for="storyDescription" class="block text-gray-700 text-sm font-bold mb-2">Описание:</label>
                    <textarea id="storyDescription" rows="4" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-pink-300" placeholder="Подробности этого момента..."></textarea>
                </div>
                <button id="addStoryButton" class="bg-gradient-to-r from-pink-500 to-orange-400 hover:from-orange-400 hover:to-pink-500 text-white font-bold py-2 px-4 rounded-full w-full transition-all duration-300">
                    Добавить в историю
                </button>
                <p id="storyMessage" class="text-center text-sm mt-3"></p>
            </div>

            <!-- Индикатор загрузки -->
            <div id="storyLoading" class="text-center text-gray-500 text-lg mt-10" style="display: none;">
                <i class="fas fa-spinner fa-spin text-primary-color text-3xl"></i> Загрузка истории...
            </div>

            <!-- Контейнер для отображения истории -->
            <div id="storyTimeline" class="story-timeline max-w-2xl mx-auto">
                <!-- Элементы истории будут добавлены здесь JavaScript'ом -->
            </div>
            
            <!-- Отображение текущего ID пользователя -->
            <p class="text-center text-sm text-gray-500 mt-8">
                Ваш ID пользователя: <span id="currentUserId">Загрузка...</span>
            </p>
        </section>
    </div>

    <!-- Вкладка "Что я люблю в тебе" -->
    <div id="qualities-tab" class="tab-content bg-pink-50 rounded-3xl shadow-xl mt-8">
        <section class="w-full">
            <h2 class="section-heading playfair-display">Что я люблю в тебе</h2>
            <p class="text-center text-lg text-gray-700 mb-12 max-w-2xl mx-auto">
                Твои качества делают тебя таким(ой) невероятным(ой) человеком. Вот лишь некоторые из них, которые я обожаю:
            </p>

            <div id="qualitiesGrid" class="quality-grid">
                <!-- Качества будут загружены здесь из Firestore -->
            </div>
            
            <!-- Сообщение об отсутствии качеств -->
            <p id="noQualitiesMessage" class="text-center text-gray-500 mt-10" style="display: none;">
                Пока нет добавленных качеств. Добавьте их на вкладке "Настройки"!
            </p>
        </section>
    </div>

    <!-- Вкладка "Наши будущие мечты" -->
    <div id="future-dreams-tab" class="tab-content bg-white rounded-3xl shadow-xl mt-8">
        <section class="w-full">
            <h2 class="section-heading playfair-display">Наши будущие мечты</h2>
            <p class="text-center text-lg text-gray-700 mb-12 max-w-2xl mx-auto">
                Я мечтаю о нашем будущем, наполненном приключениями, смехом и бесконечной любовью.
            </p>

            <div class="dream-gallery grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
                <img src="https://placehold.co/400x300/FFD1DC/6B4C5C?text=Путешествия" alt="Мечта о путешествиях" class="w-full h-auto object-cover">
                <img src="https://placehold.co/400x300/FFC0CB/6B4C5C?text=Уютный+дом" alt="Мечта об уютном доме" class="w-full h-auto object-cover">
                <img src="https://placehold.co/400x300/FFB6C1/6B4C5C?text=Общие+хобби" alt="Мечта об общих хобби" class="w-full h-auto object-cover">
                <img src="https://placehold.co/400x300/FF99AA/6B4C5C?text=Счастливые+моменты" alt="Мечта о счастливых моментах" class="w-full h-auto object-cover">
                <img src="https://placehold.co/400x300/FF8899/6B4C5C?text=Рост+и+развитие" alt="Мечта о росте и развитии" class="w-full h-auto object-cover">
                <img src="https://placehold.co/400x300/FF6677/6B4C5C?text=Бесконечная+любовь" alt="Мечта о бесконечной любви" class="w-full h-auto object-cover">
            </div>
        </section>
    </div>

    <!-- Новая вкладка "Обратный отсчет" -->
    <div id="countdown-tab" class="tab-content bg-white rounded-3xl shadow-xl mt-8">
        <section class="w-full">
            <h2 class="section-heading playfair-display">Обратный отсчет до <span id="countdownEventName">[Событие]</span></h2>
            <p class="text-center text-lg text-gray-700 mb-12 max-w-2xl mx-auto" id="countdownDescription">
                До нашего особенного дня осталось...
            </p>

            <div class="countdown-container">
                <div class="countdown-timer">
                    <div class="countdown-item">
                        <div id="countdownDays" class="countdown-value">00</div>
                        <div class="countdown-label">Дней</div>
                    </div>
                    <div class="countdown-item">
                        <div id="countdownHours" class="countdown-value">00</div>
                        <div class="countdown-label">Часов</div>
                    </div>
                    <div class="countdown-item">
                        <div id="countdownMinutes" class="countdown-value">00</div>
                        <div class="countdown-label">Минут</div>
                    </div>
                    <div class="countdown-item">
                        <div id="countdownSeconds" class="countdown-value">00</div>
                        <div class="countdown-label">Секунд</div>
                    </div>
                </div>
                <p id="countdownFinishedMessage" class="text-xl text-primary-color mt-8" style="display: none;">
                    Поздравляем! Этот день настал!
                </p>
            </div>
        </section>
    </div>

    <!-- Вкладка "Финальное послание" -->
    <div id="final-message-tab" class="tab-content bg-white rounded-3xl shadow-xl mt-8">
        <section class="w-full flex justify-center items-center">
            <div class="final-message-card">
                <h2 class="playfair-display text-4xl md:text-5xl font-bold text-gray-800 mb-8">
                    Мое сердце говорит...
                </h2>
                <p id="recipientNameDisplay" class="text-xl md:text-2xl text-gray-700 leading-relaxed mb-8">
                    Дорогой(ая) [Имя получателя],
                </p>
                <p id="finalMessageText" class="text-lg md:text-xl text-gray-700 leading-relaxed text-justify mb-8">
                    Каждый день, проведенный рядом с тобой, — это благословение. Ты наполнил(а) мою жизнь светом, смыслом и безграничной любовью. Я ценю каждую нашу минуту, каждый смех, каждую тихую беседу. Ты — тот(та) человек, который делает меня лучше, вдохновляет на новые свершения и дарит ощущение полного счастья. Я не могу представить свою жизнь без тебя. Ты — моя родственная душа, мой лучший друг и моя самая большая любовь. Я люблю тебя всем сердцем, сегодня, завтра и всегда.
                </p>
                <p class="signature playfair-display">
                    С любовью, <span id="senderNameDisplay">[Твое Имя]</span>
                </p>
            </div>
        </section>
    </div>

    <!-- Новая вкладка "Настройки" -->
    <div id="settings-tab" class="tab-content bg-white rounded-3xl shadow-xl mt-8">
        <section class="w-full">
            <h2 class="section-heading playfair-display">Настройки сайта</h2>
            <p class="text-center text-lg text-gray-700 mb-12 max-w-2xl mx-auto">
                Здесь вы можете персонализировать сайт, изменив имена, пол получателя и фотографию.
            </p>

            <div class="max-w-2xl mx-auto p-6 bg-gray-50 rounded-xl border border-gray-100 shadow-md">
                <div class="mb-5">
                    <label for="recipientNameInput" class="block text-gray-700 text-lg font-bold mb-3">
                        Имя получателя (для послания):
                    </label>
                    <input type="text" id="recipientNameInput"
                           class="shadow appearance-none border rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-pink-300 text-center text-xl"
                           placeholder="Введите полное имя получателя">
                    <p id="recipientNameMessage" class="text-center text-sm mt-2"></p>
                </div>

                <div class="mb-5">
                    <label for="recipientGenderSelect" class="block text-gray-700 text-lg font-bold mb-3">
                        Пол получателя:
                    </label>
                    <select id="recipientGenderSelect"
                            class="shadow appearance-none border rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-pink-300 text-center text-xl">
                        <option value="unspecified">Не указано</option>
                        <option value="male">Парень</option>
                        <option value="female">Девушка</option>
                    </select>
                </div>

                <div class="mb-5">
                    <label for="recipientPhotoUrlInput" class="block text-gray-700 text-lg font-bold mb-3">
                        URL фотографии получателя:
                    </label>
                    <input type="url" id="recipientPhotoUrlInput"
                           class="shadow appearance-none border rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-pink-300 text-center text-xl"
                           placeholder="Вставьте URL изображения (например, с Imgur)">
                    <p class="text-sm text-gray-500 mt-2">
                        Используйте прямую ссылку на изображение (например, `https://example.com/your-photo.jpg`).
                    </p>
                </div>

                <div class="mb-5">
                    <label for="senderNameInput" class="block text-gray-700 text-lg font-bold mb-3">
                        Ваше имя (отправителя):
                    </label>
                    <input type="text" id="senderNameInput"
                           class="shadow appearance-none border rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-pink-300 text-center text-xl"
                           placeholder="Введите ваше полное имя">
                    <p id="senderNameMessage" class="text-center text-sm mt-2"></p>
                </div>

                <div class="mb-5">
                    <label for="backgroundMusicUrlInput" class="block text-gray-700 text-lg font-bold mb-3">
                        URL фоновой музыки (.mp3):
                    </label>
                    <input type="url" id="backgroundMusicUrlInput"
                           class="shadow appearance-none border rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-pink-300 text-center text-xl"
                           placeholder="Вставьте URL вашей любимой песни">
                    <p class="text-sm text-gray-500 mt-2">
                        Используйте прямую ссылку на MP3-файл (например, `https://example.com/song.mp3`).
                    </p>
                </div>

                <div class="mb-5">
                    <label for="mainIntroTextInput" class="block text-gray-700 text-lg font-bold mb-3">
                        Текст на главной странице:
                    </label>
                    <textarea id="mainIntroTextInput" rows="3"
                              class="shadow appearance-none border rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-pink-300"
                              placeholder="Добро пожаловать в историю, написанную моим сердцем, только для тебя."></textarea>
                </div>

                <div class="mb-6">
                    <label for="finalMessageTextInput" class="block text-gray-700 text-lg font-bold mb-3">
                        Текст финального послания:
                    </label>
                    <textarea id="finalMessageTextInput" rows="8"
                              class="shadow appearance-none border rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-pink-300"
                              placeholder="Каждый день, проведенный рядом с тобой..."></textarea>
                </div>

                <hr class="my-8 border-gray-300">

                <h3 class="font-semibold text-2xl text-gray-800 mb-5 text-center playfair-display">Настройка качеств</h3>
                <p class="text-center text-gray-700 mb-6">Добавьте качества, которые вы цените в своем особенном человеке.</p>
                <div class="mb-4">
                    <label for="newQualityText" class="block text-gray-700 text-sm font-bold mb-2">Новое качество:</label>
                    <input type="text" id="newQualityText" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-pink-300" placeholder="Например, Твоя доброта">
                </div>
                <div class="mb-6">
                    <label for="newQualityDescription" class="block text-gray-700 text-sm font-bold mb-2">Описание качества:</label>
                    <textarea id="newQualityDescription" rows="2" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-pink-300" placeholder="Например, Твое большое сердце и забота о других вдохновляют меня."></textarea>
                </div>
                <button id="addQualityButton" class="bg-gradient-to-r from-purple-500 to-indigo-400 hover:from-indigo-400 hover:to-purple-500 text-white font-bold py-2 px-4 rounded-full w-full transition-all duration-300">
                    Добавить качество
                </button>
                <p id="qualityMessage" class="text-center text-sm mt-3"></p>

                <h4 class="font-semibold text-xl text-gray-800 mt-8 mb-4 text-center">Существующие качества:</h4>
                <div id="existingQualitiesList" class="space-y-3 text-left">
                    <!-- Существующие качества будут загружены здесь -->
                </div>

                <hr class="my-8 border-gray-300">

                <h3 class="font-semibold text-2xl text-gray-800 mb-5 text-center playfair-display">Настройка обратного отсчета</h3>
                <p class="text-center text-gray-700 mb-6">Укажите дату и название важного события.</p>
                <div class="mb-4">
                    <label for="countdownEventNameInput" class="block text-gray-700 text-lg font-bold mb-3">
                        Название события:
                    </label>
                    <input type="text" id="countdownEventNameInput"
                           class="shadow appearance-none border rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-pink-300 text-center text-xl"
                           placeholder="Например, Наша годовщина">
                </div>
                <div class="mb-6">
                    <label for="countdownDateInput" class="block text-gray-700 text-lg font-bold mb-3">
                        Дата события:
                    </label>
                    <input type="date" id="countdownDateInput"
                           class="shadow appearance-none border rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-pink-300 text-center text-xl">
                </div>
                <p id="countdownSettingsMessage" class="text-center text-sm mt-3"></p>

                <button id="saveSiteSettingsButton"
                        class="bg-gradient-to-r from-blue-500 to-cyan-400 hover:from-cyan-400 hover:to-blue-500 text-white font-bold py-3 px-6 rounded-full w-full transition-all duration-300 text-lg mt-8">
                    Сохранить все настройки
                </button>
            </div>
        </section>
    </div>

    <!-- Футер -->
    <footer class="mt-20 py-10">
        <p class="text-lg mb-4">&copy; 2025 Сделано с любовью и вдохновением.</p>
        <div class="flex justify-center space-x-6 text-2xl">
            <a href="#" class="hover:scale-110 transition-transform duration-300"><i class="fab fa-instagram"></i></a>
            <a href="#" class="hover:scale-110 transition-transform duration-300"><i class="fab fa-telegram-plane"></i></a>
            <a href="#" class="hover:scale-110 transition-transform duration-300"><i class="fas fa-envelope"></i></a>
        </div>
        <p class="text-sm text-gray-400 mt-6">
            Пусть наша история продолжается вечно.
        </p>
    </footer>

    <!-- Модальное окно для изображений -->
    <div id="imageModal" class="image-modal-overlay hidden">
        <button class="image-modal-close" id="closeImageModal">&times;</button>
        <img src="" alt="Увеличенное изображение" class="image-modal-content" id="modalImage">
    </div>

    <script type="module">
        // Импорт Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Глобальные переменные для Firebase (предоставляются средой Canvas)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' && Object.keys(JSON.parse(__firebase_config)).length > 0
            ? JSON.parse(__firebase_config)
            : { projectId: 'love-journey-default-id' }; // Используем фиктивный ID для локального запуска
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let currentUserId = null;
        let unsubscribeFromStory = null; // Для отписки от слушателя Firestore истории
        let unsubscribeFromQualities = null; // Для отписки от слушателя Firestore качеств
        let unsubscribeFromSettings = null; // Для отписки от слушателя настроек
        let countdownInterval = null; // Для интервала обратного отсчета

        document.addEventListener('DOMContentLoaded', async () => {
            const heartContainer = document.getElementById('heart-container');
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            const storyDateInput = document.getElementById('storyDate');
            const storyTitleInput = document.getElementById('storyTitle');
            const storyDescriptionInput = document.getElementById('storyDescription');
            const addStoryButton = document.getElementById('addStoryButton');
            const storyMessage = document.getElementById('storyMessage');
            const storyTimelineDiv = document.getElementById('storyTimeline');
            const storyLoadingSpinner = document.getElementById('storyLoading');
            const currentUserIdSpan = document.getElementById('currentUserId');

            const recipientNameInput = document.getElementById('recipientNameInput');
            const recipientGenderSelect = document.getElementById('recipientGenderSelect');
            const recipientPhotoUrlInput = document.getElementById('recipientPhotoUrlInput');
            const senderNameInput = document.getElementById('senderNameInput');
            const backgroundMusicUrlInput = document.getElementById('backgroundMusicUrlInput');
            const mainIntroTextInput = document.getElementById('mainIntroTextInput');
            const finalMessageTextInput = document.getElementById('finalMessageTextInput');
            const saveSiteSettingsButton = document.getElementById('saveSiteSettingsButton');
            const recipientNameMessage = document.getElementById('recipientNameMessage');
            const senderNameMessage = document.getElementById('senderNameMessage');
            const recipientNameDisplay = document.getElementById('recipientNameDisplay');
            const senderNameDisplay = document.getElementById('senderNameDisplay');
            const mainHeroImage = document.getElementById('mainHeroImage');
            const particlesCanvas = document.getElementById('particles-canvas');
            const ctx = particlesCanvas.getContext('2d');
            const backgroundMusic = document.getElementById('backgroundMusic');
            const mainIntroTextDisplay = document.getElementById('mainIntroText');
            const finalMessageTextDisplay = document.getElementById('finalMessageText');

            const shareButton = document.getElementById('shareButton');
            const shareMessage = document.getElementById('shareMessage');

            const imageModal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            const closeImageModalButton = document.getElementById('closeImageModal');
            const dreamGalleryImages = document.querySelectorAll('#future-dreams-tab .dream-gallery img');

            // Элементы для динамических качеств
            const newQualityText = document.getElementById('newQualityText');
            const newQualityDescription = document.getElementById('newQualityDescription');
            const addQualityButton = document.getElementById('addQualityButton');
            const qualityMessage = document.getElementById('qualityMessage');
            const qualitiesGrid = document.getElementById('qualitiesGrid'); // Контейнер для отображения качеств
            const existingQualitiesList = document.getElementById('existingQualitiesList'); // Список для редактирования качеств в настройках
            const noQualitiesMessage = document.getElementById('noQualitiesMessage');

            // Элементы для обратного отсчета
            const countdownEventNameInput = document.getElementById('countdownEventNameInput');
            const countdownDateInput = document.getElementById('countdownDateInput');
            const countdownSettingsMessage = document.getElementById('countdownSettingsMessage');
            const countdownEventNameDisplay = document.getElementById('countdownEventName');
            const countdownDescriptionDisplay = document.getElementById('countdownDescription');
            const countdownDays = document.getElementById('countdownDays');
            const countdownHours = document.getElementById('countdownHours');
            const countdownMinutes = document.getElementById('countdownMinutes');
            const countdownSeconds = document.getElementById('countdownSeconds');
            const countdownFinishedMessage = document.getElementById('countdownFinishedMessage');


            // --- Инициализация Firebase ---
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Аутентификация пользователя
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        currentUserIdSpan.textContent = currentUserId;
                        console.log("Authenticated with UID:", currentUserId);
                        // Запускаем слушателей после аутентификации
                        listenForStoryUpdates();
                        listenForQualities(); // Запускаем слушатель качеств
                        listenForSiteSettings(); // Слушаем настройки (включая оба имени, пол, фото, музыку, тексты и дату отсчета)
                    } else {
                        // Если токен не предоставлен, анонимная аутентификация
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Firebase authentication error:", error);
                            currentUserIdSpan.textContent = "Ошибка аутентификации";
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase initialization error:", error);
                storyMessage.textContent = "Ошибка инициализации Firebase. Пожалуйста, проверьте консоль.";
                storyMessage.classList.add('text-red-500');
            }

            // --- Функция для создания падающих сердечек ---
            function createHeart() {
                const heart = document.createElement('div');
                heart.classList.add('heart');
                const size = Math.random() * 20 + 10; /* Случайный размер от 10 до 30px */
                heart.style.width = `${size}px`;
                heart.style.height = `${size}px`;
                heart.style.left = `${Math.random() * 100}vw`; /* Случайная позиция по горизонтали */
                heart.style.animationDuration = `${Math.random() * 8 + 5}s`; /* Случайная длительность анимации */
                heart.style.animationDelay = `${Math.random() * 5}s`; /* Случайная задержка */
                heartContainer.appendChild(heart);

                // Удаляем сердце после завершения анимации, чтобы не перегружать DOM
                heart.addEventListener('animationend', () => {
                    heart.remove();
                });
            }

            // Создаем сердечки с интервалом
            setInterval(createHeart, 300); // Создаем новое сердце каждые 300 мс

            // --- Анимация частиц на Canvas ---
            let particles = [];
            const numParticles = 100; // Количество частиц
            const maxDistance = 100; // Максимальное расстояние для соединения линиями

            // Класс для отдельной частицы
            class Particle {
                constructor(x, y) {
                    this.x = x;
                    this.y = y;
                    this.size = Math.random() * 2 + 0.5; // Размер частицы
                    this.speedX = Math.random() * 0.5 - 0.25; // Скорость по X (-0.25 до 0.25)
                    this.speedY = Math.random() * 0.5 - 0.25; // Скорость по Y (-0.25 до 0.25)
                    this.color = `rgba(255, 255, 255, ${Math.random() * 0.5 + 0.2})`; // Полупрозрачный белый
                }

                update() {
                    this.x += this.speedX;
                    this.y += this.speedY;

                    // Отскок от краев Canvas
                    if (this.x > particlesCanvas.width || this.x < 0) {
                        this.speedX *= -1;
                    }
                    if (this.y > particlesCanvas.height || this.y < 0) {
                        this.speedY *= -1;
                    }
                }

                draw() {
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                    ctx.fill();
                }
            }

            // Инициализация частиц
            function initParticles() {
                particles = [];
                for (let i = 0; i < numParticles; i++) {
                    const x = Math.random() * particlesCanvas.width;
                    const y = Math.random() * particlesCanvas.height;
                    particles.push(new Particle(x, y));
                }
            }

            // Анимационный цикл Canvas
            function animateParticles() {
                ctx.clearRect(0, 0, particlesCanvas.width, particlesCanvas.height); // Очистка Canvas

                for (let i = 0; i < particles.length; i++) {
                    particles[i].update();
                    particles[i].draw();

                    // Соединение частиц линиями
                    for (let j = i; j < particles.length; j++) {
                        const dx = particles[i].x - particles[j].x;
                        const dy = particles[i].y - particles[j].y;
                        const distance = Math.sqrt(dx * dx + dy * dy);

                        if (distance < maxDistance) {
                            ctx.strokeStyle = `rgba(255, 255, 255, ${1 - (distance / maxDistance)})`;
                            ctx.lineWidth = 0.5;
                            ctx.beginPath();
                            ctx.moveTo(particles[i].x, particles[i].y);
                            ctx.lineTo(particles[j].x, particles[j].y);
                            ctx.stroke();
                        }
                    }
                }
                requestAnimationFrame(animateParticles); // Запрос следующего кадра
            }

            // Изменение размера Canvas при изменении размера окна
            function resizeCanvas() {
                particlesCanvas.width = window.innerWidth;
                particlesCanvas.height = window.innerHeight;
                initParticles(); // Переинициализация частиц при изменении размера
            }

            window.addEventListener('resize', resizeCanvas);
            resizeCanvas(); // Инициализация при загрузке
            animateParticles(); // Запуск анимации

            // --- Функция для переключения вкладок ---
            window.showTab = (tabId) => {
                // Отписываемся от предыдущих слушателей, если они были
                if (unsubscribeFromStory) {
                    unsubscribeFromStory();
                    unsubscribeFromStory = null;
                }
                if (unsubscribeFromQualities) {
                    unsubscribeFromQualities();
                    unsubscribeFromQualities = null;
                }
                if (countdownInterval) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                }


                // Скрываем весь контент вкладок
                tabContents.forEach(content => {
                    content.classList.remove('active');
                    // Сбрасываем анимации для элементов внутри, чтобы они анимировались заново
                    content.querySelectorAll('.timeline-item, .quality-item, .dream-gallery img, .final-message-card, .countdown-container').forEach(el => {
                        el.classList.remove('active');
                        el.style.transitionDelay = '0s'; // Сброс задержки
                    });
                });

                // Деактивируем все кнопки вкладок
                tabButtons.forEach(button => {
                    button.classList.remove('active');
                });

                // Активируем нужную вкладку и кнопку
                const activeTabContent = document.getElementById(tabId);
                activeTabContent.classList.add('active');
                document.querySelector(`.tab-button[data-tab="${tabId}"]`).classList.add('active');

                // Плавная прокрутка к началу активной вкладки
                activeTabContent.scrollIntoView({ behavior: 'smooth', block: 'start' });


                // Если это вкладка "Главная", запускаем эффект пишущей машинки
                if (tabId === 'hero-tab') {
                    const typewriterTextHero = document.getElementById('typewriter-text-hero');
                    const textToTypeHero = "Ты — моя самая большая радость.";
                    let i = 0;
                    typewriterTextHero.textContent = ''; // Очищаем текст перед началом печати
                    if (window.innerWidth > 480) {
                        function typeWriter() {
                            if (i < textToTypeHero.length) {
                                typewriterTextHero.textContent += textToTypeHero.charAt(i);
                                i++;
                                setTimeout(typeWriter, 70);
                            }
                        }
                        typeWriter();
                    } else {
                        typewriterTextHero.textContent = textToTypeHero;
                    }
                } else if (tabId === 'our-story-tab') {
                    // Анимируем элементы истории при переходе на вкладку
                    // Используем setTimeout, чтобы анимация запускалась после того, как вкладка станет видимой
                    setTimeout(() => {
                        const timelineItems = storyTimelineDiv.querySelectorAll('.timeline-item');
                        timelineItems.forEach((item, index) => {
                            item.style.transitionDelay = `${index * 0.1}s`; // Задержка для последовательного появления
                            item.classList.add('active');
                        });
                    }, 100); // Небольшая задержка после активации вкладки
                } else if (tabId === 'qualities-tab') {
                    // Запускаем слушатель качеств при переходе на вкладку
                    if (currentUserId) {
                        listenForQualities();
                    } else {
                        qualitiesGrid.innerHTML = '<p class="text-center text-gray-500 mt-10">Пожалуйста, подождите, идет аутентификация...</p>';
                    }
                    // Анимируем элементы качеств при переходе на вкладку
                    setTimeout(() => {
                        const qualityItems = document.querySelectorAll('#qualities-tab .quality-item');
                        qualityItems.forEach((item, index) => {
                            item.style.transitionDelay = `${index * 0.08}s`;
                            item.classList.add('active');
                        });
                    }, 100);
                } else if (tabId === 'future-dreams-tab') {
                    // Анимируем изображения мечты при переходе на вкладку
                    setTimeout(() => {
                        const dreamImages = document.querySelectorAll('#future-dreams-tab .dream-gallery img');
                        dreamImages.forEach((img, index) => {
                            img.style.transitionDelay = `${index * 0.07}s`;
                            img.classList.add('active');
                        });
                    }, 100);
                } else if (tabId === 'countdown-tab') { // Новая логика для вкладки отсчета
                    setTimeout(() => {
                        const countdownContainer = document.querySelector('#countdown-tab .countdown-container');
                        countdownContainer.classList.add('active');
                        // Запускаем обратный отсчет только когда вкладка активна
                        if (currentUserId) {
                            listenForSiteSettings(); // Чтобы получить дату
                        }
                    }, 100);
                }
                else if (tabId === 'final-message-tab') {
                    // Анимируем финальное послание при переходе на вкладку
                    setTimeout(() => {
                        const finalMessageCard = document.querySelector('#final-message-tab .final-message-card');
                        finalMessageCard.classList.add('active');
                    }, 100);
                }
            };

            // --- Эффект конфетти/искр ---
            function createConfetti(x, y, color) {
                const confetti = document.createElement('div');
                confetti.style.position = 'absolute';
                confetti.style.left = `${x}px`;
                confetti.style.top = `${y}px`;
                confetti.style.width = '8px';
                confetti.style.height = '8px';
                confetti.style.backgroundColor = color;
                confetti.style.borderRadius = '50%';
                confetti.style.opacity = '1';
                confetti.style.transform = `scale(${Math.random() * 0.5 + 0.5})`;
                confetti.style.transition = 'transform 0.8s ease-out, opacity 0.8s ease-out';
                confetti.style.zIndex = '9999';
                document.body.appendChild(confetti);

                const angle = Math.random() * Math.PI * 2;
                const distance = Math.random() * 50 + 30;
                const finalX = x + Math.cos(angle) * distance;
                const finalY = y + Math.sin(angle) * distance;

                setTimeout(() => {
                    confetti.style.transform = `translate(${finalX - x}px, ${finalY - y}px) scale(0)`;
                    confetti.style.opacity = '0';
                    confetti.style.transition = 'transform 0.8s ease-in, opacity 0.8s ease-in';
                }, 10); // Небольшая задержка, чтобы анимация сработала

                confetti.addEventListener('transitionend', () => {
                    confetti.remove();
                });
            }

            function triggerConfetti(event, count = 20) {
                const colors = ['#ff6b6b', '#ffa07a', '#fca5a5', '#fef2f2', '#a78bfa', '#818cf8'];
                const rect = event.target.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;

                for (let i = 0; i < count; i++) {
                    const color = colors[Math.floor(Math.random() * colors.length)];
                    createConfetti(centerX, centerY, color);
                }
            }

            // --- Обработчики модального окна изображений ---
            dreamGalleryImages.forEach(img => {
                img.addEventListener('click', () => {
                    modalImage.src = img.src;
                    imageModal.classList.add('active');
                });
            });

            closeImageModalButton.addEventListener('click', () => {
                imageModal.classList.remove('active');
            });

            imageModal.addEventListener('click', (event) => {
                // Закрываем модальное окно, если клик был по оверлею, а не по изображению
                if (event.target === imageModal) {
                    imageModal.classList.remove('active');
                }
            });


            // --- Firestore: Добавление новой записи в историю ---
            addStoryButton.addEventListener('click', async (event) => { // Передаем event
                const date = storyDateInput.value.trim();
                const title = storyTitleInput.value.trim();
                const description = storyDescriptionInput.value.trim();

                if (!date || !title || !description) {
                    storyMessage.textContent = "Пожалуйста, заполните все поля.";
                    storyMessage.classList.remove('text-green-500', 'text-gray-500');
                    storyMessage.classList.add('text-red-500');
                    return;
                }

                if (!currentUserId) {
                    storyMessage.textContent = "Ошибка: Пользователь не аутентифицирован. Пожалуйста, обновите страницу.";
                    storyMessage.classList.remove('text-green-500', 'text-gray-500');
                    storyMessage.classList.add('text-red-500');
                    return;
                }

                try {
                    storyMessage.textContent = "Добавление...";
                    storyMessage.classList.remove('text-red-500', 'text-green-500');
                    storyMessage.classList.add('text-gray-500');
                    addStoryButton.disabled = true; // Отключаем кнопку во время добавления

                    const storyCollectionRef = collection(db, `artifacts/${appId}/public/data/love_story_items`);
                    await addDoc(storyCollectionRef, {
                        date: date,
                        title: title,
                        description: description,
                        createdAt: new Date(), // Добавляем метку времени для сортировки
                        userId: currentUserId // Сохраняем ID пользователя, который добавил запись
                    });

                    storyMessage.textContent = "Момент успешно добавлен!";
                    storyMessage.classList.remove('text-red-500', 'text-gray-500');
                    storyMessage.classList.add('text-green-500');
                    triggerConfetti(event); // Запускаем конфетти при успехе!

                    // Очищаем поля формы
                    storyDateInput.value = '';
                    storyTitleInput.value = '';
                    storyDescriptionInput.value = '';

                } catch (e) {
                    console.error("Ошибка при добавлении документа: ", e);
                    storyMessage.textContent = "Ошибка при добавлении момента. Пожалуйста, попробуйте снова.";
                    storyMessage.classList.remove('text-green-500', 'text-gray-500');
                    storyMessage.classList.add('text-red-500');
                } finally {
                    addStoryButton.disabled = false; // Включаем кнопку обратно
                }
            });

            // --- Firestore: Слушатель обновлений истории ---
            function listenForStoryUpdates() {
                if (!db || !currentUserId) {
                    console.warn("Firestore или userId не инициализированы. Невозможно начать слушать обновления истории.");
                    return;
                }

                storyLoadingSpinner.style.display = 'block'; // Показываем спиннер загрузки
                storyTimelineDiv.innerHTML = ''; // Очищаем текущую историю

                const storyCollectionRef = collection(db, `artifacts/${appId}/public/data/love_story_items`);
                // Запрос с сортировкой по дате создания
                const q = query(storyCollectionRef, orderBy("createdAt", "asc"));

                unsubscribeFromStory = onSnapshot(q, (snapshot) => {
                    storyTimelineDiv.innerHTML = ''; // Очищаем перед перерисовкой
                    if (snapshot.empty) {
                        storyTimelineDiv.innerHTML = '<p class="text-center text-gray-500 mt-10">Пока нет записей в истории. Будьте первым, кто добавит!</p>';
                    } else {
                        snapshot.forEach((doc) => {
                            const data = doc.data();
                            const itemDiv = document.createElement('div');
                            itemDiv.classList.add('timeline-item');
                            itemDiv.innerHTML = `
                                <p class="timeline-date">${data.date}</p>
                                <h3 class="font-semibold text-xl text-gray-800 mb-2">${data.title}</h3>
                                <p class="text-gray-600">${data.description}</p>
                                <p class="text-xs text-gray-400 mt-2">Добавлено: ${data.userId.substring(0, 8)}...</p>
                            `;
                            storyTimelineDiv.appendChild(itemDiv);
                        });
                    }
                    storyLoadingSpinner.style.display = 'none'; // Скрываем спиннер после загрузки
                }, (error) => {
                    console.error("Ошибка при получении обновлений истории: ", error);
                    storyMessage.textContent = "Не удалось загрузить историю. Пожалуйста, попробуйте снова.";
                    storyMessage.classList.remove('text-green-500', 'text-gray-500');
                    storyMessage.classList.add('text-red-500');
                    storyLoadingSpinner.style.display = 'none';
                });
            }

            // --- Firestore: Добавление нового качества ---
            addQualityButton.addEventListener('click', async () => {
                const text = newQualityText.value.trim();
                const description = newQualityDescription.value.trim();

                if (!text || !description) {
                    qualityMessage.textContent = "Пожалуйста, заполните оба поля качества.";
                    qualityMessage.classList.remove('text-green-500', 'text-gray-500');
                    qualityMessage.classList.add('text-red-500');
                    return;
                }

                if (!currentUserId) {
                    qualityMessage.textContent = "Ошибка: Пользователь не аутентифицирован. Пожалуйста, обновите страницу.";
                    qualityMessage.classList.remove('text-green-500', 'text-gray-500');
                    qualityMessage.classList.add('text-red-500');
                    return;
                }

                try {
                    qualityMessage.textContent = "Добавление...";
                    qualityMessage.classList.remove('text-red-500', 'text-green-500');
                    qualityMessage.classList.add('text-gray-500');
                    addQualityButton.disabled = true;

                    const qualitiesCollectionRef = collection(db, `artifacts/${appId}/public/data/qualities_items`);
                    await addDoc(qualitiesCollectionRef, {
                        text: text,
                        description: description,
                        createdAt: new Date(),
                        userId: currentUserId
                    });

                    qualityMessage.textContent = "Качество успешно добавлено!";
                    qualityMessage.classList.remove('text-red-500', 'text-gray-500');
                    qualityMessage.classList.add('text-green-500');

                    newQualityText.value = '';
                    newQualityDescription.value = '';

                } catch (e) {
                    console.error("Ошибка при добавлении качества: ", e);
                    qualityMessage.textContent = "Ошибка при добавлении качества. Пожалуйста, попробуйте снова.";
                    qualityMessage.classList.remove('text-green-500', 'text-gray-500');
                    qualityMessage.classList.add('text-red-500');
                } finally {
                    addQualityButton.disabled = false;
                }
            });

            // --- Firestore: Удаление качества ---
            existingQualitiesList.addEventListener('click', async (event) => {
                if (event.target.classList.contains('quality-delete-btn')) {
                    const qualityId = event.target.dataset.id;
                    if (!qualityId) return;

                    if (!currentUserId) {
                        qualityMessage.textContent = "Ошибка: Пользователь не аутентифицирован для удаления.";
                        qualityMessage.classList.remove('text-green-500', 'text-gray-500');
                        qualityMessage.classList.add('text-red-500');
                        return;
                    }

                    try {
                        qualityMessage.textContent = "Удаление...";
                        qualityMessage.classList.remove('text-green-500', 'text-red-500');
                        qualityMessage.classList.add('text-gray-500');

                        const qualityDocRef = doc(db, `artifacts/${appId}/public/data/qualities_items`, qualityId);
                        await deleteDoc(qualityDocRef);

                        qualityMessage.textContent = "Качество удалено!";
                        qualityMessage.classList.remove('text-red-500', 'text-gray-500');
                        qualityMessage.classList.add('text-green-500');
                    } catch (e) {
                        console.error("Ошибка при удалении качества: ", e);
                        qualityMessage.textContent = "Ошибка при удалении качества. Пожалуйста, попробуйте снова.";
                        qualityMessage.classList.remove('text-green-500', 'text-gray-500');
                        qualityMessage.classList.add('text-red-500');
                    }
                }
            });

            // --- Firestore: Слушатель обновлений качеств ---
            function listenForQualities() {
                if (!db || !currentUserId) {
                    console.warn("Firestore или userId не инициализированы. Невозможно начать слушать обновления качеств.");
                    return;
                }

                qualitiesGrid.innerHTML = ''; // Очищаем сетку качеств
                existingQualitiesList.innerHTML = ''; // Очищаем список в настройках
                noQualitiesMessage.style.display = 'none';

                const qualitiesCollectionRef = collection(db, `artifacts/${appId}/public/data/qualities_items`);
                const q = query(qualitiesCollectionRef, orderBy("createdAt", "asc"));

                unsubscribeFromQualities = onSnapshot(q, (snapshot) => {
                    qualitiesGrid.innerHTML = '';
                    existingQualitiesList.innerHTML = '';

                    if (snapshot.empty) {
                        noQualitiesMessage.style.display = 'block';
                        qualitiesGrid.innerHTML = '<p class="text-center text-gray-500 mt-10">Пока нет добавленных качеств. Добавьте их на вкладке "Настройки"!</p>';
                    } else {
                        noQualitiesMessage.style.display = 'none';
                        snapshot.forEach((doc) => {
                            const data = doc.data();
                            // Для отображения на вкладке "Что я люблю"
                            const qualityItemDiv = document.createElement('div');
                            qualityItemDiv.classList.add('quality-item', 'text-center');
                            // Иконку можно выбрать динамически или оставить одну
                            qualityItemDiv.innerHTML = `
                                <i class="fas fa-heart quality-icon"></i>
                                <h3 class="font-semibold text-xl text-gray-800 mb-2">${data.text}</h3>
                                <p class="text-gray-600">${data.description}</p>
                            `;
                            qualitiesGrid.appendChild(qualityItemDiv);

                            // Для списка в настройках
                            const existingQualityLi = document.createElement('li');
                            existingQualityLi.classList.add('flex', 'justify-between', 'items-center', 'bg-white', 'p-3', 'rounded-lg', 'shadow-sm', 'border', 'border-gray-200');
                            existingQualityLi.innerHTML = `
                                <span>${data.text}</span>
                                <button class="quality-delete-btn" data-id="${doc.id}">
                                    <i class="fas fa-times"></i>
                                </button>
                            `;
                            existingQualitiesList.appendChild(existingQualityLi);
                        });
                        // Анимируем качества после их загрузки
                        setTimeout(() => {
                            const qualityItems = qualitiesGrid.querySelectorAll('.quality-item');
                            qualityItems.forEach((item, index) => {
                                item.style.transitionDelay = `${index * 0.08}s`;
                                item.classList.add('active');
                            });
                        }, 100);
                    }
                }, (error) => {
                    console.error("Ошибка при получении качеств: ", error);
                    qualityMessage.textContent = "Не удалось загрузить качества. Пожалуйста, попробуйте снова.";
                    qualityMessage.classList.remove('text-green-500', 'text-gray-500');
                    qualityMessage.classList.add('text-red-500');
                });
            }

            // --- Firestore: Сохранение настроек сайта (имена, пол, фото, музыка, тексты, дата отсчета) ---
            saveSiteSettingsButton.addEventListener('click', async (event) => { // Передаем event
                const recipientName = recipientNameInput.value.trim();
                const recipientGender = recipientGenderSelect.value;
                const recipientPhotoUrl = recipientPhotoUrlInput.value.trim();
                const senderName = senderNameInput.value.trim();
                const backgroundMusicUrl = backgroundMusicUrlInput.value.trim();
                const mainIntroText = mainIntroTextInput.value.trim();
                const finalMessageText = finalMessageTextInput.value.trim();
                const countdownEventName = countdownEventNameInput.value.trim(); // Новое поле
                const countdownDate = countdownDateInput.value; // Новое поле (YYYY-MM-DD)


                if (!recipientName) {
                    recipientNameMessage.textContent = "Пожалуйста, введите имя получателя.";
                    recipientNameMessage.classList.remove('text-green-500', 'text-gray-500');
                    recipientNameMessage.classList.add('text-red-500');
                    return;
                } else {
                    recipientNameMessage.textContent = "";
                }

                if (!senderName) {
                    senderNameMessage.textContent = "Пожалуйста, введите ваше имя.";
                    senderNameMessage.classList.remove('text-green-500', 'text-gray-500');
                    senderNameMessage.classList.add('text-red-500');
                    return;
                } else {
                    senderNameMessage.textContent = "";
                }

                if (!currentUserId) {
                    recipientNameMessage.textContent = "Ошибка: Пользователь не аутентифицирован. Пожалуйста, обновите страницу.";
                    recipientNameMessage.classList.remove('text-green-500', 'text-gray-500');
                    recipientNameMessage.classList.add('text-red-500');
                    return;
                }

                try {
                    recipientNameMessage.textContent = "Сохранение...";
                    recipientNameMessage.classList.remove('text-red-500', 'text-green-500');
                    recipientNameMessage.classList.add('text-gray-500');
                    senderNameMessage.textContent = "";
                    countdownSettingsMessage.textContent = ""; // Очищаем сообщение отсчета
                    saveSiteSettingsButton.disabled = true;

                    const settingsDocRef = doc(db, `artifacts/${appId}/public/data/site_settings/global_settings`);
                    await setDoc(settingsDocRef, {
                        recipientName: recipientName,
                        recipientGender: recipientGender,
                        recipientPhotoUrl: recipientPhotoUrl,
                        senderName: senderName,
                        backgroundMusicUrl: backgroundMusicUrl,
                        mainIntroText: mainIntroText,
                        finalMessageText: finalMessageText,
                        countdownEventName: countdownEventName, // Сохраняем название события
                        countdownDate: countdownDate, // Сохраняем дату события
                        lastUpdatedBy: currentUserId,
                        timestamp: new Date()
                    });

                    recipientNameMessage.textContent = "Настройки успешно сохранены!";
                    recipientNameMessage.classList.remove('text-red-500', 'text-gray-500');
                    recipientNameMessage.classList.add('text-green-500');
                    triggerConfetti(event); // Запускаем конфетти при успехе!

                } catch (e) {
                    console.error("Ошибка при сохранении настроек сайта: ", e);
                    recipientNameMessage.textContent = "Ошибка при сохранении настроек. Пожалуйста, попробуйте снова.";
                    recipientNameMessage.classList.remove('text-green-500', 'text-gray-500');
                    recipientNameMessage.classList.add('text-red-500');
                } finally {
                    saveSiteSettingsButton.disabled = false;
                }
            });

            // --- Firestore: Слушатель обновлений настроек сайта (имена, пол, фото, музыка, тексты, дата отсчета) ---
            function listenForSiteSettings() {
                if (!db) {
                    console.warn("Firestore не инициализирован. Невозможно начать слушать настройки.");
                    return;
                }

                const settingsDocRef = doc(db, `artifacts/${appId}/public/data/site_settings/global_settings`);
                unsubscribeFromSettings = onSnapshot(settingsDocRef, (docSnapshot) => {
                    if (docSnapshot.exists()) {
                        const data = docSnapshot.data();
                        const currentRecipientName = data.recipientName || "[Имя получателя]";
                        const currentRecipientGender = data.recipientGender || "unspecified";
                        const currentRecipientPhotoUrl = data.recipientPhotoUrl || "";
                        const currentSenderName = data.senderName || "[Твое Имя]";
                        const currentBackgroundMusicUrl = data.backgroundMusicUrl || "";
                        const currentMainIntroText = data.mainIntroText || "Добро пожаловать в историю, написанную моим сердцем, только для тебя.";
                        const currentFinalMessageText = data.finalMessageText || "Каждый день, проведенный рядом с тобой, — это благословение. Ты наполнил(а) мою жизнь светом, смыслом и безграничной любовью. Я ценю каждую нашу минуту, каждый смех, каждую тихую беседу. Ты — тот(та) человек, который делает меня лучше, вдохновляет на новые свершения и дарит ощущение полного счастья. Я не могу представить свою жизнь без тебя. Ты — моя родственная душа, мой лучший друг и моя самая большая любовь. Я люблю тебя всем сердцем, сегодня, завтра и всегда.";
                        const currentCountdownEventName = data.countdownEventName || "Особенный день";
                        const currentCountdownDate = data.countdownDate || "";


                        recipientNameInput.value = currentRecipientName;
                        recipientGenderSelect.value = currentRecipientGender;
                        recipientPhotoUrlInput.value = currentRecipientPhotoUrl;
                        senderNameInput.value = currentSenderName;
                        backgroundMusicUrlInput.value = currentBackgroundMusicUrl;
                        mainIntroTextInput.value = currentMainIntroText;
                        finalMessageTextInput.value = currentFinalMessageText;
                        countdownEventNameInput.value = currentCountdownEventName;
                        countdownDateInput.value = currentCountdownDate;

                        // Обновляем отображение имени получателя с учетом пола
                        let greeting = "Дорогой(ая)";
                        if (currentRecipientGender === "male") {
                            greeting = "Дорогой";
                        } else if (currentRecipientGender === "female") {
                            greeting = "Дорогая";
                        }
                        recipientNameDisplay.textContent = `${greeting} ${currentRecipientName},`;
                        senderNameDisplay.textContent = currentSenderName;
                        mainIntroTextDisplay.textContent = currentMainIntroText;
                        finalMessageTextDisplay.textContent = currentFinalMessageText;
                        countdownEventNameDisplay.textContent = currentCountdownEventName;
                        
                        // Обновляем фото на главной странице
                        if (currentRecipientPhotoUrl) {
                            mainHeroImage.src = currentRecipientPhotoUrl;
                            mainHeroImage.onerror = () => { // Обработка ошибки загрузки фото
                                mainHeroImage.src = "https://placehold.co/150x150/FF6B6B/FFFFFF?text=Ошибка+фото";
                                console.error("Не удалось загрузить фото по URL:", currentRecipientPhotoUrl);
                            };
                        } else {
                            mainHeroImage.src = "https://placehold.co/150x150/FF6B6B/FFFFFF?text=Фото"; // Дефолтное фото
                        }

                        // Обновляем и проигрываем фоновую музыку
                        if (currentBackgroundMusicUrl && backgroundMusic.src !== currentBackgroundMusicUrl) {
                            backgroundMusic.src = currentBackgroundMusicUrl;
                            backgroundMusic.load(); // Перезагружаем аудио
                            backgroundMusic.play().catch(error => {
                                console.warn("Автоматическое воспроизведение музыки заблокировано браузером. Пользователю нужно будет нажать на страницу.", error);
                                // Можно добавить кнопку "Включить музыку"
                            });
                        } else if (!currentBackgroundMusicUrl) {
                            backgroundMusic.pause();
                            backgroundMusic.src = "";
                        }

                        // Запускаем или обновляем обратный отсчет
                        if (countdownInterval) {
                            clearInterval(countdownInterval); // Очищаем предыдущий интервал
                        }
                        if (currentCountdownDate) {
                            startCountdown(currentCountdownDate, currentCountdownEventName);
                        } else {
                            countdownDescriptionDisplay.textContent = "Укажите дату события в настройках.";
                            countdownDays.textContent = "00";
                            countdownHours.textContent = "00";
                            countdownMinutes.textContent = "00";
                            countdownSeconds.textContent = "00";
                            countdownFinishedMessage.style.display = 'none';
                        }


                    } else {
                        // Если настроек нет, используем значения по умолчанию
                        recipientNameInput.value = "";
                        recipientGenderSelect.value = "unspecified";
                        recipientPhotoUrlInput.value = "";
                        senderNameInput.value = "";
                        backgroundMusicUrlInput.value = "";
                        mainIntroTextInput.value = "Добро пожаловать в историю, написанную моим сердцем, только для тебя.";
                        finalMessageTextInput.value = "Каждый день, проведенный рядом с тобой, — это благословение. Ты наполнил(а) мою жизнь светом, смыслом и безграничной любовью. Я ценю каждую нашу минуту, каждый смех, каждую тихую беседу. Ты — тот(та) человек, который делает меня лучше, вдохновляет на новые свершения и дарит ощущение полного счастья. Я не могу представить свою жизнь без тебя. Ты — моя родственная душа, мой лучший друг и моя самая большая любовь. Я люблю тебя всем сердцем, сегодня, завтра и всегда.";
                        countdownEventNameInput.value = "";
                        countdownDateInput.value = "";

                        recipientNameDisplay.textContent = "Дорогой(ая) [Имя получателя],";
                        senderNameDisplay.textContent = "[Твое Имя]";
                        mainHeroImage.src = "https://placehold.co/150x150/FF6B6B/FFFFFF?text=Фото"; // Дефолтное фото
                        mainIntroTextDisplay.textContent = "Добро пожаловать в историю, написанную моим сердцем, только для тебя.";
                        finalMessageTextDisplay.textContent = "Каждый день, проведенный рядом с тобой, — это благословение. Ты наполнил(а) мою жизнь светом, смыслом и безграничной любовью. Я ценю каждую нашу минуту, каждый смех, каждую тихую беседу. Ты — тот(та) человек, который делает меня лучше, вдохновляет на новые свершения и дарит ощущение полного счастья. Я не могу представить свою жизнь без тебя. Ты — моя родственная душа, мой лучший друг и моя самая большая любовь. Я люблю тебя всем сердцем, сегодня, завтра и всегда.";
                        countdownEventNameDisplay.textContent = "[Событие]";
                        countdownDescriptionDisplay.textContent = "Укажите дату события в настройках.";
                        countdownDays.textContent = "00";
                        countdownHours.textContent = "00";
                        countdownMinutes.textContent = "00";
                        countdownSeconds.textContent = "00";
                        countdownFinishedMessage.style.display = 'none';
                        backgroundMusic.pause();
                        backgroundMusic.src = "";
                    }
                }, (error) => {
                    console.error("Ошибка при получении настроек сайта: ", error);
                    recipientNameMessage.textContent = "Не удалось загрузить настройки имени.";
                    recipientNameMessage.classList.remove('text-green-500', 'text-gray-500');
                    recipientNameMessage.classList.add('text-red-500');
                });
            }

            // --- Функция обратного отсчета ---
            function startCountdown(targetDateString, eventName) {
                const targetDate = new Date(targetDateString).getTime();

                countdownInterval = setInterval(() => {
                    const now = new Date().getTime();
                    const distance = targetDate - now;

                    if (distance < 0) {
                        clearInterval(countdownInterval);
                        countdownDays.textContent = "00";
                        countdownHours.textContent = "00";
                        countdownMinutes.textContent = "00";
                        countdownSeconds.textContent = "00";
                        countdownFinishedMessage.style.display = 'block';
                        countdownDescriptionDisplay.textContent = "";
                        return;
                    }

                    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                    countdownDays.textContent = String(days).padStart(2, '0');
                    countdownHours.textContent = String(hours).padStart(2, '0');
                    countdownMinutes.textContent = String(minutes).padStart(2, '0');
                    countdownSeconds.textContent = String(seconds).padStart(2, '0');
                    countdownDescriptionDisplay.textContent = `До ${eventName} осталось...`;
                    countdownFinishedMessage.style.display = 'none';

                }, 1000);
            }


            // --- Кнопка "Поделиться" ---
            shareButton.addEventListener('click', async () => {
                try {
                    // Используем navigator.clipboard.writeText для копирования URL
                    // В некоторых средах (например, в iframe) это может быть ограничено,
                    // тогда можно использовать document.execCommand('copy') как запасной вариант.
                    await navigator.clipboard.writeText(window.location.href);
                    shareMessage.textContent = "Ссылка скопирована в буфер обмена!";
                    shareMessage.classList.remove('text-red-500');
                    shareMessage.classList.add('text-green-500');
                } catch (err) {
                    console.error('Не удалось скопировать ссылку: ', err);
                    // Запасной вариант для старых браузеров или ограниченных сред
                    const textarea = document.createElement('textarea');
                    textarea.value = window.location.href;
                    textarea.style.position = 'fixed'; // Чтобы не влияло на макет
                    document.body.appendChild(textarea);
                    textarea.focus();
                    textarea.select();
                    try {
                        document.execCommand('copy');
                        shareMessage.textContent = "Ссылка скопирована (запасной метод)!";
                        shareMessage.classList.remove('text-red-500');
                        shareMessage.classList.add('text-green-500');
                    } catch (errCopy) {
                        console.error('Не удалось скопировать ссылку запасным методом: ', errCopy);
                        shareMessage.textContent = "Не удалось скопировать ссылку. Пожалуйста, скопируйте ее вручную из адресной строки.";
                        shareMessage.classList.remove('text-green-500');
                        shareMessage.classList.add('text-red-500');
                    }
                    document.body.removeChild(textarea);
                }
                // Скрываем сообщение через несколько секунд
                setTimeout(() => {
                    shareMessage.textContent = "";
                }, 3000);
            });


            // Инициализация: показываем первую вкладку при загрузке
            showTab('hero-tab');

            // Добавляем обработчики событий для кнопок вкладок
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.dataset.tab;
                    showTab(tabId);
                });
            });
        });
    </script>
</body>
</html>
