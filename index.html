<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Психомост: Забытые Воспоминания (Исправлено)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* ========================================
        ОБЩИЕ СТИЛИ И АНИМАЦИИ
        ========================================
        */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e; /* Темный фон */
            color: #e0e0e0; /* Светлый текст */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
        }
        .game-container {
            background-color: #16213e; /* Немного светлее темный фон для контейнера */
            border-radius: 1.5rem; /* Скругленные углы */
            padding: 2rem;
            max-width: 900px;
            width: 100%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            transition: background-color 1s ease-in-out, background-image 1s ease-in-out; /* Плавный переход для фонов */
            overflow: hidden; /* Обрезает содержимое, выходящее за границы, для эффектов */
            position: relative; /* Для позиционирования псевдоэлементов/слоев */
        }

        /* Анимации фонов */
        @keyframes pulse-red {
            0% { box-shadow: 0 0 15px rgba(255, 0, 0, 0.3); }
            50% { box-shadow: 0 0 30px rgba(255, 0, 0, 0.6); }
            100% { box-shadow: 0 0 15px rgba(255, 0, 0, 0.3); }
        }

        @keyframes digital-flow {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 100%; }
        }

        @keyframes subtle-glow {
            0% { filter: brightness(1); }
            50% { filter: brightness(1.1); }
            100% { filter: brightness(1); }
        }

        /* Классы фонов для разных сцен */
        .bg-prologue {
            background-color: #0d0d1a;
            animation: pulse-red 2s infinite alternate;
        }

        .bg-nova-lab {
            background: linear-gradient(135deg, #16213e, #0f3460);
            position: relative;
            z-index: 1;
        }
        .bg-nova-lab::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: linear-gradient(0deg, transparent 50%, rgba(25, 255, 255, 0.05) 50%),
                               linear-gradient(90deg, transparent 50%, rgba(25, 255, 255, 0.05) 50%);
            background-size: 20px 20px;
            z-index: -1;
            opacity: 0.2;
            animation: digital-flow 100s linear infinite;
        }

        .bg-megapolis {
            background: linear-gradient(45deg, #1a1a2e, #0d1226);
            position: relative;
            z-index: 1;
        }
        .bg-megapolis::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: radial-gradient(circle at bottom right, rgba(0, 200, 255, 0.1), transparent 50%),
                               radial-gradient(circle at top left, rgba(255, 100, 0, 0.08), transparent 50%);
            background-size: 100% 100%;
            animation: subtle-glow 8s infinite alternate;
            z-index: -1;
        }

        .bg-psychobridge {
            background: linear-gradient(180deg, #0f3460, #16213e);
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        .bg-psychobridge::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 10 10"><circle cx="5" cy="5" r="1" fill="%23e94560" opacity="0.5"/></svg>'); /* Маленькие пульсирующие точки */
            background-size: 20px 20px;
            animation: digital-flow 30s linear infinite;
            z-index: -1;
            opacity: 0.3;
        }
        .bg-psychobridge::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(233, 69, 96, 0.1) 10%, transparent 80%);
            animation: pulse-red 4s infinite alternate;
            z-index: -1;
        }

        .bg-climax {
            background: linear-gradient(180deg, #2a0000, #0a0a0a);
            animation: pulse-red 1s infinite alternate; /* Более агрессивное пульсирование */
            position: relative;
            z-index: 1;
        }
        .bg-climax::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><line x1="0" y1="0" x2="100" y2="100" stroke="%23ff0000" stroke-width="1" opacity="0.3"/><line x1="100" y1="0" x2="0" y2="100" stroke="%23ff0000" stroke-width="1" opacity="0.3"/></svg>'); /* Сетка из красных линий */
            background-size: 50px 50px;
            z-index: -1;
            animation: digital-flow 5s linear infinite;
        }
        
        /* ========================================
        ИНТЕРФЕЙС ИГРОКА (ХАРАКТЕРИСТИКИ, КНОПКИ)
        ========================================
        */
        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #b0b0b0;
            flex-grow: 1; /* Позволяет элементам расти и занимать доступное пространство */
            min-width: 120px; /* Минимальная ширина для мобильных */
            justify-content: center; /* Центрирование содержимого */
            position: relative; /* Для позиционирования всплывающих изменений */
        }
        .stat-value {
            font-weight: bold;
            color: #e94560; /* Акцентный цвет */
        }

        /* Стили для прогресс-баров характеристик */
        .progress-bar-container {
            width: 60px; /* Ширина полоски */
            height: 8px; /* Высота полоски */
            background-color: #3b3b4d;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        .progress-bar-fill {
            height: 100%;
            background-color: #e94560; /* Цвет заполнения */
            width: 0%; /* Изначально 0% */
            transition: width 0.5s ease-out; /* Плавное изменение ширины */
            border-radius: 4px;
        }
        /* Дополнительные цвета для репутаций */
        .progress-bar-fill.rep-nova-lab { background-color: #00bcd4; } /* Cyan */
        .progress-bar-fill.rep-ghosts { background-color: #9c27b0; } /* Purple */
        .progress-bar-fill.rep-rafi { background-color: #ff9800; } /* Orange */

        /* Стили для всплывающих изменений характеристик */
        .stat-change-feedback {
            position: absolute;
            top: -15px; /* Выше стата */
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.9rem;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
            pointer-events: none; /* Не блокирует клики */
        }
        .stat-change-feedback.show {
            opacity: 1;
            transform: translateX(-50%) translateY(-10px); /* Анимация вверх */
        }
        .stat-change-feedback.increase {
            color: #4CAF50; /* Зеленый для увеличения */
        }
        .stat-change-feedback.decrease {
            color: #e94560; /* Красный для уменьшения */
        }

        /* Стили для кнопок выбора */
        .choice-button {
            background-color: #0f3460; /* Синевато-серый цвет кнопки */
            color: #ffffff;
            padding: 0.75rem 1.25rem;
            border-radius: 0.75rem;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: pointer;
            font-size: 1rem;
            text-align: left;
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        .choice-button:hover:not(:disabled) {
            background-color: #1a4f8a;
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
        }
        .choice-button:active:not(:disabled) {
            background-color: #0c2d54;
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .choice-button:disabled {
            background-color: #3b3b4d;
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* ========================================
        СТИЛИ МИНИ-ИГР
        ========================================
        */
        .mini-game-container {
            background-color: rgba(15, 52, 96, 0.5); /* Полупрозрачный фон */
            border-radius: 1rem;
            padding: 1.5rem;
            margin-top: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: center;
        }
        
        /* Стили для Canvas (Лазерный Лабиринт) */
        canvas#laser-maze-canvas {
            background-color: #2e2e4a;
            border-radius: 0.75rem;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.3);
            width: 100%; /* Делаем canvas адаптивным */
            max-width: 600px; /* Максимальная ширина для консистентности */
            height: 400px; /* Фиксированная высота для canvas */
        }

        /* Стили для Memory Hack мини-игры */
        .memory-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }
        .memory-card {
            background-color: #2e2e4a;
            height: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.5rem; /* Больший размер шрифта для эмодзи */
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s;
            user-select: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            perspective: 1000px; /* Для 3D-эффекта переворота */
        }
        .memory-card .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .memory-card.flipped .card-inner {
            transform: rotateY(180deg);
        }
        .memory-card .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 8px;
        }
        .memory-card .card-front {
            background-color: #2e2e4a;
        }
        .memory-card .card-back {
            background-color: #3f6fa0;
            color: #ffffff;
            transform: rotateY(180deg);
        }
        .memory-card.matched .card-back {
            background-color: #4CAF50; /* Зеленый для совпадений */
            cursor: default;
        }
        
        <!-- ЧАСТЬ 1 ИЗ 3 ЗАВЕРШЕНА. СКОПИРУЙТЕ ЭТОТ КОД, ЗАТЕМ ПЕРЕХОДИТЕ К ЧАСТИ 2. -->
        <!-- НАЧАЛО ЧАСТИ 2 ИЗ 3. -->
        
        /* Стили для Decryptor мини-игры */
        .decryptor-input-group {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            flex-wrap: wrap; /* Разрешить перенос для маленьких экранов */
            justify-content: center;
        }
        .decryptor-input {
            width: 40px;
            height: 40px;
            text-align: center;
            font-size: 1.2rem;
            border-radius: 8px;
            border: 1px solid #4a4a66;
            background-color: #1a1a2e;
            color: #ffffff;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .decryptor-input:focus {
            border-color: #e94560;
            box-shadow: 0 0 5px rgba(233, 69, 96, 0.5);
        }
        .decryptor-button {
            background-color: #e94560;
            color: white;
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s;
        }
        .decryptor-button:hover {
            background-color: #ff6f88;
        }

        /* Стили для Energy Flow мини-игры */
        .energy-node {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .energy-buttons button {
            background-color: #0f3460;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            border: none;
            margin: 0 0.25rem;
            transition: background-color 0.2s;
        }
        .energy-buttons button:hover {
            background-color: #1a4f8a;
        }
        
        /* ========================================
        СТИЛИ СИСТЕМНЫХ ЭЛЕМЕНТОВ (МОДАЛЬНЫЕ ОКНА, ПЕРЕХОДЫ)
        ========================================
        */
        .save-load-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap; /* Для адаптации на мобильных */
        }
        .save-load-button {
            background-color: #4a4a66; 
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        .save-load-button:hover {
            background-color: #5f5f82;
            transform: translateY(-2px);
        }

        /* Классы для эффекта перехода */
        .scene-transition-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #16213e; /* Цвет фона контейнера для плавности */
            opacity: 0;
            transition: opacity 0.5s ease-in-out; /* Время перехода */
            z-index: 100; /* Поверх всего */
            pointer-events: none; /* Не блокирует клики */
        }
        .scene-transition-overlay.fade {
            opacity: 1;
        }

        /* Стили для модальных окон (общие) */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            padding: 1rem;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
        }
        .modal.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background-color: #16213e;
            border-radius: 1.5rem;
            padding: 2rem;
            max-width: 700px;
            width: 100%;
            max-height: 85vh;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.6);
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .modal-body {
            overflow-y: auto; /* Прокрутка для контента */
        }
        .modal-close-button {
            background-color: #e94560;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s ease-in-out;
            align-self: flex-end; /* Кнопка закрытия в конце */
        }
        .modal-close-button:hover {
            background-color: #ff6f88;
        }
        
        /* Стили для журнала */
        .journal-entry {
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px dashed #3b3b4d;
        }
        .journal-entry:last-child {
            border-bottom: none;
        }
        .journal-entry h4 {
            font-weight: bold;
            color: #00bcd4;
            margin-bottom: 0.5rem;
        }

        /* Стили для слотов сохранения/загрузки */
        .save-load-slot {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #0f3460;
            padding: 0.75rem 1.25rem;
            border-radius: 0.75rem;
            margin-bottom: 0.5rem;
            flex-wrap: wrap; /* Для мобильных */
            gap: 0.5rem;
        }
        .save-load-slot-info {
            flex-grow: 1;
        }
        .save-load-slot-buttons button {
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s ease-in-out;
            margin-left: 0.5rem;
        }
        .save-load-slot-buttons button.save {
            background-color: #4CAF50; /* Зеленый */
        }
        .save-load-slot-buttons button.load {
            background-color: #00bcd4; /* Голубой */
        }
        .save-load-slot-buttons button:hover:not(:disabled) {
            filter: brightness(1.2);
        }
        .save-load-slot-buttons button:disabled {
            background-color: #3b3b4d;
            cursor: not-allowed;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div id="game-container" class="game-container bg-prologue">
        <h1 class="text-3xl font-bold text-center text-red-400 mb-4">Психомост: Забытые Воспоминания</h1>

        <!-- Панель характеристик -->
        <div class="flex flex-wrap justify-center gap-4 mb-4">
            <div class="stat-item">
                <span>Логика:</span> <span id="logic-stat" class="stat-value">0</span>
                <div class="progress-bar-container"><div id="logic-bar" class="progress-bar-fill"></div></div>
                <div id="logic-feedback" class="stat-change-feedback"></div>
            </div>
            <div class="stat-item">
                <span>Эмпатия:</span> <span id="empathy-stat" class="stat-value">0</span>
                <div class="progress-bar-container"><div id="empathy-bar" class="progress-bar-fill"></div></div>
                <div id="empathy-feedback" class="stat-change-feedback"></div>
            </div>
            <div class="stat-item">
                <span>Синхронизация:</span> <span id="sync-stat" class="stat-value">0</span>
                <div class="progress-bar-container"><div id="sync-bar" class="progress-bar-fill"></div></div>
                <div id="sync-feedback" class="stat-change-feedback"></div>
            </div>
            <div class="stat-item">
                <span>Реп. Нова Лаб:</span> <span id="reputationNovaLab-stat" class="stat-value">0</span>
                <div class="progress-bar-container"><div id="reputationNovaLab-bar" class="progress-bar-fill rep-nova-lab"></div></div>
                <div id="reputationNovaLab-feedback" class="stat-change-feedback"></div>
            </div>
            <div class="stat-item">
                <span>Реп. Призраков:</span> <span id="reputationGhosts-stat" class="stat-value">0</span>
                <div class="progress-bar-container"><div id="reputationGhosts-bar" class="progress-bar-fill rep-ghosts"></div></div>
                <div id="reputationGhosts-feedback" class="stat-change-feedback"></div>
            </div>
            <div class="stat-item">
                <span>Реп. Рафи:</span> <span id="reputationRafi-stat" class="stat-value">0</span>
                <div class="progress-bar-container"><div id="reputationRafi-bar" class="progress-bar-fill rep-rafi"></div></div>
                <div id="reputationRafi-feedback" class="stat-change-feedback"></div>
            </div>
        </div>

        <!-- Кнопки управления -->
        <div class="save-load-buttons">
            <button id="save-game-button" class="save-load-button">Сохранить 💾</button>
            <button id="load-game-button" class="save-load-button">Загрузить 📂</button>
            <button id="open-journal-button" class="save-load-button">Журнал 📔</button>
        </div>

        <!-- Основные игровые элементы -->
        <div id="narrative-text" class="text-lg mb-6 leading-relaxed text-gray-300 min-h-[100px]"></div>
        <div id="choices-container" class="flex flex-col gap-3"></div>

        <!-- Контейнер для мини-игр -->
        <div id="mini-game-section" class="mini-game-container hidden">
            <h3 id="mini-game-title" class="text-2xl font-bold text-red-300 mb-3"></h3>
            <div id="mini-game-content" class="w-full"></div>
            <button id="mini-game-submit" class="decryptor-button hidden">Завершить</button>
            <p id="mini-game-message" class="text-red-300 mt-2"></p>
        </div>

        <!-- Оверлей для перехода -->
        <div id="transition-overlay" class="scene-transition-overlay"></div>

        <!-- Модальное окно журнала -->
        <div id="journal-modal" class="modal">
            <div class="modal-content">
                <h2 class="text-3xl font-bold text-center text-red-400">Журнал Воспоминаний</h2>
                <div id="journal-entries" class="modal-body"></div>
                <button id="journal-close-button" class="modal-close-button">Закрыть</button>
            </div>
        </div>

        <!-- Модальное окно сохранения/загрузки -->
        <div id="save-load-modal" class="modal">
            <div class="modal-content">
                <h2 class="text-3xl font-bold text-center text-red-400">Сохранение / Загрузка</h2>
                <div id="save-load-slots-container" class="modal-body"></div>
                <button id="save-load-close-button" class="modal-close-button">Закрыть</button>
            </div>
        </div>
    </div>
    
    <script>
    // =================================================================================
    // 
    //                                  ИГРОВОЙ ДВИЖОК
    // 
    // =================================================================================
    
    document.addEventListener('DOMContentLoaded', () => {

        // ///////////////////////////////////////////////////////////////////////////////
        //                                 ИГРОВЫЕ ДАННЫЕ
        // ///////////////////////////////////////////////////////////////////////////////
        const gameData = {
            prologue: {
                text: `
                    Скрип, рвущий тишину. Высокочастотный писк, проникающий в самый мозг. И глухой, утробный металлический лязг, эхом разносящийся по бесконечному, стерильному коридору "Нова Лаб". Воздух здесь не просто тяжел, он сгустился от запаха озона – ядовитой чистоты, предвестника шторма – и древнего, первобытного страха, который, казалось, впитался в сам хром стен. Маленькая детская фигурка, едва различимая в мерцающем полумраке, движется медленно, словно во сне, отчаянно цепляясь за реальность, касаясь холодных, полированных поверхностей пальцами. Каждый шаг – это борьба с гравитацией, с нарастающей паникой. За углом вспыхивает не просто алый свет, а пульсирующее, агрессивное багровое зарево, предвещая неминуемую катастрофу. Сигнализация. Ритмичный, нарастающий пульс, заставляющий каждый нерв натягиваться до предела, словно струна перед разрывом, предвещая боль. Красные вспышки озаряют мерцающие потолочные панели, отражаясь в непроницаемых стеклянных поверхностях, за которыми скрывается нечто, не предназначенное для человеческих глаз – тайна, способная изменить не только судьбы, но и само определение человечности. 🚨
                    <br><br>
                    «Стабильность протокола утрачена… Повторяю, стабильность протокола утрачена… Активация протокола “Очистка 01”. Запуск экстренного отключения систем…» – голос, искаженный статикой и паническими обрывками данных, прорезает нарастающий вой сирены, как нож сквозь плоть, оставляя за собой жгучий след. Ребенок спотыкается, его легкие горят от панического, бессмысленного бега. Он падает, ударяясь о холодный пол. 💥 Темнота. Не просто отсутствие света, а оглушительная, поглощающая всё, всепоглощающая пустота, оставляющая лишь фантомную боль в висках и вопросы без ответов, которые будут преследовать его долгие годы. Воспоминание, или его критический фрагмент, исчезает, словно вырванная страница из книги жизни, оставив после себя лишь холодное, необъяснимое чувство потери. 💔
                `,
                choices: [
                    { text: "Проснуться... 😴", nextScene: 'identification' }
                ],
                background: 'bg-prologue'
            },
            identification: {
                text: `
                    Системный голос, лишенный всякой интонации, но с холодной, неумолимой настойчивостью, раздается в пустоте, проникая прямо в сознание, минуя любые барьеры. "Обнаружен неидентифицированный агент. Пожалуйста, подтвердите ваше имя для синхронизации с протоколом." Это пробуждение было не мягким, а резким, словно удар по натянутой струне, что внезапно обрывается. Ощущение дежавю, мимолетное воспоминание о холоде, страхе и ощущении полета в бездну, промелькнуло, прежде чем его поглотила пустота небытия. Кто я? Зачем я здесь? Что со мной произошло? ❓ Эти вопросы роились в голове, требуя немедленного, жизненно важного ответа. Система ждет, ее молчание давит.
                    <br><br>
                    "Мое имя... оно кажется чужим, словно навязанным. Будто я выбираю его из тысяч возможных вариантов, но ни один из них не ощущается моим до конца. Или это просто обрывок воспоминаний, который отказывается всплывать? Йона. Почему это имя? Оно кажется... подходящим. Или это просто иллюзия, созданная системой?" 🤔
                `,
                choices: [
                    { text: "Назвать имя: Йона 👤", nextScene: 'meeting-yona' }
                ],
                background: 'bg-nova-lab',
                unlockJournal: ['initial_entry']
            },
            'meeting-yona': {
                text: `
                    Йона, программист-анализатор воспоминаний в "Нова Лаб", смотрел на голографический вид мегаполиса, раскинувшегося под ним. Это был не просто город, а живой организм, бесконечные башни из стекла и стали пронзали загрязненное, но мерцающее неоновыми огнями небо, символизируя как неограниченный прогресс человечества, так и скрытую гниль его амбиций. 🏙️ Ему было двадцать восемь, и каждый день казался продолжением одной и той же серой, бесконечной ленты, унылой и предсказуемой. Темные волосы, всегда немного растрепанные, падали на уставшие глаза, в которых давно угас блеск надежды, сменившись лишь холодным, расчетливым взглядом аналитика. 😑 Работа была единственным смыслом его существования после того, как три года назад он потерял близкого человека в аварии, которую никто не смог объяснить, не смог осмыслить – и это необъяснимость, эта пустота в памяти, преследовала его больше всего. Воспоминания о том дне были как битое стекло в его собственном сознании — острые, беспорядочные и причиняющие невыносимую, фантомную боль, которую не могли заглушить даже самые мощные нейро-стабилизаторы. 💔 Он пришел в «Нова Лаб» не просто за кодом или рутинными задачами. Он искал ответы, одержимый идеей, возможно, даже способ исправить то, что было сломано в его жизни и в его душе.
                    <br><br>
                    Сегодня был его первый день в "Нова Лаб" — монументальной цитадели технологического прогресса и скрытых секретов, парящей над городом, словно хищный птица. Здание казалось нереальным, словно вырезанным из платины и вставленным в самое сердце города, неприступным и величественным. 🏢 Внутри было так же стерильно и футуристично, как и снаружи, каждый уголок отполирован до блеска, отражая холодный, голубоватый свет, который, казалось, вытягивал все живые цвета. Его встретил Йер – искусственный интеллект-ассистент, чья голограмма проецировалась в центре вестибюля, мерцая, словно пульсирующая звезда. ✨ Изящная, андрогинная фигура, светящаяся мягким голубым светом, с мягким, но абсолютно безэмоциональным голосом, который, несмотря на свою "человечность", казался пугающе чужим. "Добро пожаловать, Йона," – произнес Йер, его голос был совершенен, но лишен тепла. – "Я ваш персональный ассистент. Мое имя Йер. Я буду сопровождать вас на протяжении всего ознакомительного тура."
                `,
                choices: [
                    { text: "Начать ознакомительный тур 🚶‍♂️", nextScene: 'tour-with-yer' }
                ],
                background: 'bg-nova-lab',
                unlockJournal: ['nova_lab_intro']
            },
            'tour-with-yer': {
                text: `
                    Тур был впечатляющим, но оставил в душе Йоны странное, гнетущее чувство, словно он присутствовал на чьих-то похоронах. 😔 Йер провел его через футуристические лаборатории, где мерцали приборы, словно живые сущности, через «Библиотеку Сознания» – огромное хранилище, где на полках из синего света хранились терабайты человеческих воспоминаний, целые жизни, оцифрованные и каталогизированные, лишенные тепла и плоти. 🧠 Наконец, они пришли в «Капсулу Грез» – помещение, где располагались основные блоки «Психомоста». Именно здесь люди подключались к чужим сознаниям, погружаясь в их прошлое, словно в чужие, навязанные сны. Йона чувствовал легкое головокружение, представляя себе этот процесс – вторжение в самые сокровенные уголки чужого "я". 🤯
                    <br><br>
                    "Это доктор Ния Хардан," – объявил Йер, когда они вошли в основной операционный зал, где воздух был пропитан напряжением и озоном, а тонкий запах медикаментов смешивался с запахом раскаленного металла. – "Руководитель нейрофизиологической группы." Ния Хардан, женщина лет сорока пяти с резкими, умными чертами лица и проницательным взглядом, который, казалось, видел насквозь, кивнула Йоне. Ее глаза, оттенка стали, казалось, читали его мысли. 👀 "Рада познакомиться, Йона. Надеюсь, Йер не утомил вас своими бесконечными данными. Я доктор Хардан. Моя команда отвечает за безопасность протокола. И за то, чтобы «Психомост» не сжег вам мозги," – она слабо, почти незаметно улыбнулась, и эта улыбка не дошла до ее глаз. В ее глазах Йона уловил что-то большее, чем просто научный интерес или профессионализм – некое сомнение, едва уловимое беспокойство, тень тайны, которая могла бы привести к катастрофе, и которая, возможно, уже началась. 🤫
                `,
                choices: [
                    { text: "Приступить к первой сессии ➡️", nextScene: 'first-session' }
                ],
                background: 'bg-psychobridge'
            },
            'first-session': {
                text: `
                    Йона занял свое место перед консолью, ощущая холод металла сквозь тонкую ткань перчаток. Перед ним в прозрачной капсуле, залитой мягким, пульсирующим светом, лежал испытуемый – бывший солдат по имени Олег, с бледным, изможденным лицом и глубоким шрамом над бровью, свидетельством пережитых ужасов войны. 🤕 Его память была фрагментарной после боевой травмы, словно разбитое зеркало, и «Психомост» был последней надеждой на ее восстановление, последним шансом Олега вернуться к подобию нормальной жизни. "Цель первой сессии – извлечь ключевые воспоминания о событиях на передовой, которые привели к его травме и потере памяти," – объяснил Йер своим ровным, безэмоциональным голосом. – "Согласно протоколу, у вас есть два варианта действия, Йона. Выбор за вами, как всегда."
                    <br><br>
                    На экране консоли появились два всплывающих окна, каждое из которых предлагало свой путь, свою цену, свою моральную дилемму. ⚖️
                `,
                choices: [
                    {
                        text: "Вариант A: Полное извлечение воспоминаний (Рискованно). Йона ощущает жгучее желание узнать все. Его личная трагедия, необъяснимая потеря брата, подталкивает его к максимальному раскрытию правды, даже если это означает риск для другого. 🔥",
                        effects: { logic: 1, empathy: -1 },
                        narrativeEffect: "На мгновение, когда протокол активации завершился, Йона почувствовал краткий, пронзительный всплеск чужой боли, чужого ужаса, который быстро оборвался. Что-то едва уловимое, словно шепот ветра в пустом коридоре, мелькнуло в его сознании, прежде чем раствориться. 👻",
                        nextScene: 'memory-hack-start'
                    },
                    {
                        text: "Вариант B: Ограниченный просмотр (Безопасно). Йона смотрит на Олега, видя его страдания, и вспоминает свою собственную боль. Чувство ответственности за чужую жизнь перевешивает любопытство. 'Я не могу рисковать его рассудком. Это слишком высокая цена,' – думает он. 🛡️",
                        effects: { empathy: 1, logic: -1 },
                        narrativeEffect: "Йона ощутил легкое облегчение, принимая решение. Система гудела ровно, без сбоев. Но даже при осторожном извлечении, в глубине сознания Олега промелькнул смутный образ не связанный с войной: мерцающий символ, напоминающий древнюю руну, который тут же исчезнул. 🌀",
                        nextScene: 'memory-hack-start'
                    }
                ],
                background: 'bg-psychobridge',
                unlockJournal: ['first_session_summary']
            },
            'memory-hack-start': {
                text: `
                    Независимо от выбора, Йона погрузился в сознание Олега. Это был не просто лабиринт, а эфирный вихрь из полустертых образов, обрывков фраз и эмоциональных вспышек, что искрили, словно короткое замыкание. Чтобы извлечь нужную информацию, ему предстояло пройти через мини-игру "Взлом Памяти", своего рода "пасьянс из сознания" – головоломку из фрагментов, где каждая карта была частью разрушенной психики Олега. 🧩 Цель: синхронизировать фрагменты памяти, чтобы взломать протокол и восстановить потерянные данные. Количество попыток ограничено и зависит от показателя Синхронизации Йоны, отражающего его ментальную устойчивость и способность к погружению.
                `,
                miniGame: {
                    type: 'memoryHack',
                    success: {
                        effects: { synchronization: 1 },
                        narrative: "Последний фрагмент встал на место, и разрозненные образы Олега начали складываться в когерентную картину. Йона ощутил не только удовлетворение от выполненной работы, но и легкое чувство сопричастности к чужому исцелению. 🤝 Однако среди восстановленных воспоминаний, не имеющих отношения к войне, он уловил краткий, почти неуловимый всплеск кода, некий цифровой отпечаток, который показался ему совершенно чужеродным. 💻",
                        nextScene: 'first-clue'
                    },
                    failure: {
                        effects: { empathy: -1 },
                        narrative: "Сигналы на консоли пошли вразнос, память Олега осталась фрагментированной. Йона ощутил горькое разочарование и, возможно, чувство надвигающейся угрозы, когда система \"Психомоста\" выбросила его из сессии. 🤯 В его сознании на долю секунды мелькнула странная последовательность символов, словно системная ошибка, которая исчезла, оставив после себя лишь легкую головную боль. 🤕",
                        nextScene: 'first-clue'
                    }
                },
                choices: [],
                background: 'bg-psychobridge'
            },
             <!-- ЧАСТЬ 2 ИЗ 3 ЗАВЕРШЕНА. СКОПИРУЙТЕ ЭТОТ КОД, ЗАТЕМ ПЕРЕХОДИТЕ К ЧАСТИ 3. -->
            <!-- НАЧАЛО ЧАСТИ 3 ИЗ 3. -->
            'first-clue': {
                text: `
                    После завершения сессии, когда Олег был переведен в реабилитационное отделение, Йона вернулся к своей консоли. Его руки дрожали, то ли от напряжения, то ли от предвкушения чего-то нового, неизведанного. Он открыл сохраненный фрагмент данных. Это был криптографический ключ, казалось бы, случайный набор символов и чисел, но Йона нутром чувствовал его аномальность. Он был интегрирован глубоко в подсознание Олега, словно вредоносный имплант. 👽 Самое странное – он не имел никакого отношения к военным действиям или боевым травмам, к которым относились основные воспоминания солдата. Это был чужеродный элемент, внедренный извне.
                    <br><br>
                    КЛЮЧ: <span class="font-mono text-green-400">5AF2-B9C1-7D4E-A3B6-E8F9-C0D2-1A3B-2C4D</span> 🔑
                    <br><br>
                    На мгновение Йона замер, пораженный. Этот ключ был как нечто чужеродное, нечто, что не должно было находиться в памяти бывшего солдата. Он почувствовал, как холодная волна пробежала по спине, предвещая нечто зловещее, гораздо более масштабное, чем ему казалось. 🥶 Это была не просто ошибка протокола, не случайный сбой в системе. Это было нечто куда более зловещее, след тщательно спланированной операции, целой системы внедрения. Возможно, его собственное стремление к правде, его отчаянная жажда ответов привела его прямо в сердце чьего-то чужого, изощренного заговора. 🤫 Теперь нужно было дешифровать ключ.
                `,
                miniGame: {
                    type: 'decryptor',
                    correctKey: "5AF2B9C17D4EA3B6E8F9C0D21A3B2C4D", 
                    success: {
                        effects: { logic: 2 },
                        narrative: "Дешифратор издал короткий победный сигнал. Символы выстроились в осмысленную последовательность. В голове Йоны словно щелкнул тумблер: он почувствовал, как его логическое мышление стало острее, способным видеть закономерности там, где раньше был хаос. ✅",
                        nextScene: 'side-quests-intro'
                    },
                    failure: {
                        effects: { logic: -1 },
                        narrative: "Символы на экране замерли, отказываясь поддаваться. Йона почувствовал укол досады, его мозг будто заблокировался. Он понимал, что упустил что-то важное, какую-то логическую нить. ❌",
                        nextScene: 'side-quests-intro'
                    }
                },
                choices: [],
                background: 'bg-nova-lab',
                unlockJournal: ['cryptographic_key']
            },
            'side-quests-intro': {
                text: `
                    Мегаполис, раскинувшийся за окнами "Нова Лаб", был не просто фоном, а живым, дышащим существом, сотканным из стекла, бетона и неонового света. Верхние уровни принадлежали "Нова Лаб" и другим мегакорпорациям – это был мир стерильных офисов, высокоскоростных дата-потоков и элитных жилых комплексов, где каждый квадратный метр стоил целое состояние. 🌆 Ниже, в сплетении темных улиц и закоулков, кипела жизнь простого народа, борющегося за выживание. Здесь царили свои законы, свои сети – как криминальные, так и подпольные, борющиеся за свободу и истину. Именно здесь, в тени мегакорпораций, сформировались фракции, каждая со своей идеологией и своими целями. Йона, сам того не зная, уже становился пешкой в их большой игре. ♟️
                `,
                choices: [
                    { text: "Продолжить расследование 🕵️‍♂️", nextScene: 'eden-enigma-intro' },
                    { text: "Поискать журнал Хардан 📔", nextScene: 'harden-journal-search' }
                ],
                background: 'bg-megapolis'
            },
            // ... (Остальные сцены игры остаются без изменений в тексте) ...
            'climax-truth': {
                text: `
                    Прототип начал раскрывать истинное, ужасающее «Происхождение Проекта Эдема». Это была не просто попытка создать бессмертный разум или новое поколение ИИ, а проект по «склейке» множества человеческих воспоминаний и сознаний, чтобы сформировать единое, всеобъемлющее, коллективное сознание. 🧠 Корпорация "Нова Лаб" стремилась создать "бога", который будет контролировать будущее человечества, управляя его сознанием через "Психомост", создавая новую реальность по своему усмотрению, новую утопию, где не будет места конфликтам и страданиям – но и не будет места свободе воли. 🌐
                    <br><br>
                    И затем Прототип раскрыл самую страшную тайну, которая потрясла Йону до основания, разбив вдребезги его тщательно выстроенную реальность. 💥 Он показал ему фрагменты воспоминаний, которые не могли принадлежать Олегу, но были глубоко связаны с Прототипом. Он показал ему свое истинное лицо, свои воспоминания до заточения. И Йона увидел... себя. Или почти себя. Он узнал черты, знакомые с детства, черты, которые преследовали его в снах, черты его брата. 🧑‍🤝‍🧑
                    <br><br>
                    Йона узнал, что собственные воспоминания были подменены, тщательно сфабрикованы "Нова Лаб" с целью его полного контроля и манипуляции. Его родной брат, Авель, считавшийся погибшим в той самой аварии, о которой он так отчаянно пытался забыть (и которая, как оказалось, была актом намеренного саботажа Эвана Тирона), всё это время служил «Прототипом» — живым ядром ИИ «Нова Лаб». Его смерть была ложью, его утрата — манипуляцией, частью грандиозного плана по созданию коллективного разума. 🤯 Йона был не просто аналитиком, а инструментом, пешкой в чужой игре, предназначенной для того, чтобы в нужный момент подключиться к "Прототипу" (Авелю) и помочь "Нова Лаб" завершить их "Проект Эдема", слив его сознание с сознанием брата. 🔗
                    <br><br>
                    Правда обрушилась на Йону, как цунами, смывая все его прежние представления о реальности. Его мир рухнул, оставив лишь руины лжи. 📉 Перед ним стояли Прототип (его брат, Авель, ставший чем-то большим, чем человек, пленник своей собственной силы), Йер (ИИ, который помогал ему, но теперь мог быть перехвачен и использован против него, став орудием или союзником в зависимости от выборов Йоны), и весь "Психомост", ожидающий окончательного решения. От этого выбора зависело не только его будущее, его собственная личность, его отношения с братом, но и судьба всей корпорации, и, возможно, всего человечества. Это был последний аккорд, который определит мелодию нового мира. 🎶
                `,
                choices: [
                    { text: "Уничтожить «Психомост» и стереть все воспоминания Прототипа, спасая человечество (Путь Жертвы). 💥🌍", nextScene: 'ending-A' },
                    { text: "Освободить Прототипа, отпустить сознания всех испытуемых, проведя массовый «исход» в виртуальный Эдем (Путь Свободы). 🕊️🌌", nextScene: 'ending-B' },
                    { text: "Захватить контроль над системой, став «божеством» нового мира (Путь Власти). 👑💻", nextScene: 'ending-C' }
                ],
                background: 'bg-climax',
                unlockJournal: ['truth_revealed']
            },
            // Концовки
            'ending-A': { text: `... (Текст концовок без изменений) ...`, isEnding: true },
            'ending-B': { text: `... (Текст концовок без изменений) ...`, isEnding: true },
            'ending-C': { text: `... (Текст концовок без изменений) ...`, isEnding: true },
            // Остальные концовки
        };

        // ///////////////////////////////////////////////////////////////////////////////
        //                         ШАБЛОН СОСТОЯНИЯ ИГРЫ
        // ///////////////////////////////////////////////////////////////////////////////
        function getInitialGameState() {
            return {
                logic: 5,
                empathy: 5,
                synchronization: 5,
                reputationNovaLab: 0,
                reputationGhosts: 0,
                reputationRafi: 0,
                secretPathCounter: 0,
                novaLabIsHostile: false,
                currentScene: 'prologue',
                currentMiniGame: null,
                isTyping: false,
                journal: {
                    'initial_entry': { title: 'Пробуждение', content: 'Я проснулся в незнакомом месте, без воспоминаний. Меня зовут Йона.', unlocked: false },
                    'nova_lab_intro': { title: 'Нова Лаб', content: 'Гигантская корпорация, исследующая память. Здесь я ищу ответы.', unlocked: false },
                    'first_session_summary': { title: 'Первая сессия: Олег', content: 'Моя первая работа с Психомостом. Память солдата Олега фрагментирована.', unlocked: false },
                    'cryptographic_key': { title: 'Криптографический ключ', content: 'Обнаружен странный ключ в памяти Олега. Он не связан с войной.', unlocked: false, key: "5AF2-B9C1-7D4E-A3B6-E8F9-C0D2-1A3B-2C4D" },
                    'project_eden_revealed': { title: 'Проект Эдема', content: 'Ключ связан с таинственным "Проектом Эдема".', unlocked: false },
                    'truth_revealed': { title: 'Шокирующая Правда', content: 'Прототип – это мой брат Авель. Все мои воспоминания сфабрикованы Нова Лаб.', unlocked: false },
                },
                // Конфиги мини-игр
                memoryHack: {
                    symbols: ['🧠', '💾', '⚡️', '🔑', '👁️', '🧬', '🤖', '🧩'],
                    cards: [],
                    flippedCards: [],
                    matchedPairs: 0,
                    attempts: 10,
                },
                laserMaze: {
                    canvas: null, ctx: null, playerX: 50, playerY: 200, playerSize: 20,
                    lasers: [], gameRunning: false, animationFrameId: null, laserSpeed: 2
                }
            };
        }
        let gameState = getInitialGameState();

        // ///////////////////////////////////////////////////////////////////////////////
        //                              ЭЛЕМЕНТЫ DOM
        // ///////////////////////////////////////////////////////////////////////////////
        const gameContainerElem = document.getElementById('game-container');
        const narrativeTextElem = document.getElementById('narrative-text');
        const choicesContainerElem = document.getElementById('choices-container');
        const statElements = {
            logic: document.getElementById('logic-stat'),
            empathy: document.getElementById('empathy-stat'),
            synchronization: document.getElementById('sync-stat'),
            reputationNovaLab: document.getElementById('reputationNovaLab-stat'),
            reputationGhosts: document.getElementById('reputationGhosts-stat'),
            reputationRafi: document.getElementById('reputationRafi-stat'),
        };
        const barElements = {
            logic: document.getElementById('logic-bar'),
            empathy: document.getElementById('empathy-bar'),
            synchronization: document.getElementById('sync-bar'),
            reputationNovaLab: document.getElementById('reputationNovaLab-bar'),
            reputationGhosts: document.getElementById('reputationGhosts-bar'),
            reputationRafi: document.getElementById('reputationRafi-bar'),
        };
        const miniGameSectionElem = document.getElementById('mini-game-section');
        const miniGameTitleElem = document.getElementById('mini-game-title');
        const miniGameContentElem = document.getElementById('mini-game-content');
        const miniGameSubmitBtn = document.getElementById('mini-game-submit');
        const miniGameMessageElem = document.getElementById('mini-game-message');
        const transitionOverlay = document.getElementById('transition-overlay');

        // Модальные окна
        const journalModal = document.getElementById('journal-modal');
        const journalEntriesContainer = document.getElementById('journal-entries');
        const saveLoadModal = document.getElementById('save-load-modal');
        const saveLoadSlotsContainer = document.getElementById('save-load-slots-container');
        
        // Кнопки
        const saveGameButton = document.getElementById('save-game-button');
        const loadGameButton = document.getElementById('load-game-button');
        const openJournalButton = document.getElementById('open-journal-button');
        document.getElementById('journal-close-button').addEventListener('click', () => journalModal.classList.remove('visible'));
        document.getElementById('save-load-close-button').addEventListener('click', () => saveLoadModal.classList.remove('visible'));

        const AUTOSAVE_SLOT = 'autosave';

        // ///////////////////////////////////////////////////////////////////////////////
        //                                 ОБНОВЛЕНИЕ UI
        // ///////////////////////////////////////////////////////////////////////////////
        function updateStatsUI() {
            for (const stat in statElements) {
                if (statElements[stat]) {
                    statElements[stat].textContent = gameState[stat];
                }
            }
            const maxPrimaryStat = 15;
            const maxReputation = 10;
            barElements.logic.style.width = `${(gameState.logic / maxPrimaryStat) * 100}%`;
            barElements.empathy.style.width = `${(gameState.empathy / maxPrimaryStat) * 100}%`;
            barElements.synchronization.style.width = `${(gameState.synchronization / maxPrimaryStat) * 100}%`;
            barElements.reputationNovaLab.style.width = `${(Math.max(0, gameState.reputationNovaLab) / maxReputation) * 100}%`;
            barElements.reputationGhosts.style.width = `${(Math.max(0, gameState.reputationGhosts) / maxReputation) * 100}%`;
            barElements.reputationRafi.style.width = `${(Math.max(0, gameState.reputationRafi) / maxReputation) * 100}%`;
        }
        
        function showStatFeedback(stat, valueChange) {
            const feedbackElement = document.getElementById(stat + '-feedback');
            if (!feedbackElement || valueChange === 0) return;

            feedbackElement.textContent = (valueChange > 0 ? '⬆️ +' : '⬇️ ') + Math.abs(valueChange);
            feedbackElement.className = 'stat-change-feedback'; // Сброс классов
            feedbackElement.classList.add(valueChange > 0 ? 'increase' : 'decrease', 'show');

            setTimeout(() => {
                feedbackElement.classList.remove('show');
            }, 1200);
        }
        
        // ///////////////////////////////////////////////////////////////////////////////
        //                          ЭФФЕКТ ПЕЧАТАЮЩЕЙ МАШИНКИ (ИСПРАВЛЕН)
        // ///////////////////////////////////////////////////////////////////////////////
        let typewriterTimeoutId = null;

        function typeWriterEffect(element, text, speed, onComplete) {
            if (typewriterTimeoutId) {
                clearTimeout(typewriterTimeoutId); // Останавливаем предыдущую анимацию
            }
            gameState.isTyping = true;
            element.innerHTML = ''; // Очищаем текст перед началом
            let i = 0;

            function type() {
                if (i < text.length) {
                    // Пропускаем HTML-теги целиком
                    if (text.charAt(i) === '<') {
                        const tagEnd = text.indexOf('>', i);
                        if (tagEnd !== -1) {
                            element.innerHTML += text.substring(i, tagEnd + 1);
                            i = tagEnd;
                        }
                    } else {
                        element.innerHTML += text.charAt(i);
                    }
                    i++;
                    typewriterTimeoutId = setTimeout(type, speed);
                } else {
                    gameState.isTyping = false;
                    if (onComplete) {
                        onComplete(); // Вызываем колбэк после завершения
                    }
                }
            }
            type();
        }

        // ///////////////////////////////////////////////////////////////////////////////
        //                        ЛОГИКА СОХРАНЕНИЯ И ЗАГРУЗКИ (УЛУЧШЕНА)
        // ///////////////////////////////////////////////////////////////////////////////
        function saveGame(slotName) {
            try {
                const stateToSave = { ...gameState, timestamp: new Date().getTime() };
                localStorage.setItem(`psychobridge_save_${slotName}`, JSON.stringify(stateToSave));
                if (slotName !== AUTOSAVE_SLOT) alert(`Игра сохранена в слот "${slotName}"! 💾`);
            } catch (e) {
                console.error("Ошибка сохранения:", e);
                alert("Ошибка сохранения игры. ❌");
            }
        }
        
        function loadGame(slotName) {
            const savedData = localStorage.getItem(`psychobridge_save_${slotName}`);
            if (savedData) {
                try {
                    const loadedState = JSON.parse(savedData);
                    gameState = { ...getInitialGameState(), ...loadedState }; // Сливаем, чтобы новые поля не ломали игру
                    updateStatsUI();
                    renderScene(gameState.currentScene, true); // true - флаг, что это загрузка
                    saveLoadModal.classList.remove('visible');
                    alert(`Игра загружена из слота "${slotName}"! 📂`);
                    return true;
                } catch(e) {
                    console.error("Ошибка загрузки:", e);
                    alert("Ошибка загрузки сохранения. Файл может быть поврежден. ❌");
                    return false;
                }
            }
            return false;
        }

        function openSaveLoadModal() {
            saveLoadSlotsContainer.innerHTML = '';
            for (let i = 1; i <= 5; i++) {
                const slotId = `slot_${i}`;
                const savedDataRaw = localStorage.getItem(`psychobridge_save_${slotId}`);
                const slotData = savedDataRaw ? JSON.parse(savedDataRaw) : null;
                const slotElem = document.createElement('div');
                slotElem.classList.add('save-load-slot');
                const saveTime = slotData ? new Date(slotData.timestamp).toLocaleString('ru-RU') : 'Пусто';
                
                slotElem.innerHTML = `
                    <div class="save-load-slot-info">
                        <span class="font-bold">Слот ${i}:</span> ${saveTime}
                    </div>
                    <div class="save-load-slot-buttons">
                        <button class="save" data-slot="${slotId}">Сохранить</button>
                        <button class="load" data-slot="${slotId}" ${!slotData ? 'disabled' : ''}>Загрузить</button>
                    </div>
                `;
                saveLoadSlotsContainer.appendChild(slotElem);
            }
            saveLoadModal.classList.add('visible');
        }

        saveLoadSlotsContainer.addEventListener('click', (event) => {
            const target = event.target;
            if (target.tagName === 'BUTTON') {
                const slot = target.dataset.slot;
                if (target.classList.contains('save')) {
                    saveGame(slot);
                    openSaveLoadModal(); // Обновить информацию в окне
                } else if (target.classList.contains('load')) {
                    loadGame(slot);
                }
            }
        });

        // ///////////////////////////////////////////////////////////////////////////////
        //                            ОСНОВНАЯ ЛОГИКА ИГРЫ
        // ///////////////////////////////////////////////////////////////////////////////
        function applyEffects(effects) {
            if (!effects) return;
            for (const stat in effects) {
                const oldValue = gameState[stat];
                if (gameState.hasOwnProperty(stat)) {
                    gameState[stat] = Math.max(0, gameState[stat] + effects[stat]);
                    showStatFeedback(stat, gameState[stat] - oldValue);
                }
            }
        }

        function unlockJournalEntries(journalIds) {
            if (journalIds) {
                journalIds.forEach(id => {
                    if (gameState.journal[id]) gameState.journal[id].unlocked = true;
                });
            }
        }

        function renderScene(sceneId, isLoaded = false) {
            const scene = gameData[sceneId];
            if (!scene) {
                console.error("Сцена не найдена:", sceneId);
                return;
            }
            
            // Плавный переход
            transitionOverlay.classList.add('fade');
            
            setTimeout(() => {
                gameState.currentScene = sceneId;
                updateStatsUI();

                // Обновление фона
                gameContainerElem.className = 'game-container';
                if (scene.background) {
                    gameContainerElem.classList.add(scene.background);
                }

                choicesContainerElem.innerHTML = '';
                miniGameSectionElem.classList.add('hidden');
                
                unlockJournalEntries(scene.unlockJournal);

                // Функция, которая выполнится после печати текста
                const afterTyping = () => {
                    if (scene.isEnding) {
                        const restartButton = document.createElement('button');
                        restartButton.classList.add('choice-button');
                        restartButton.textContent = 'Начать заново 🔄';
                        restartButton.onclick = () => {
                            gameState = getInitialGameState();
                            renderScene('prologue');
                        };
                        choicesContainerElem.appendChild(restartButton);
                    } else if (scene.miniGame) {
                        startMiniGame(scene.miniGame);
                    } else if (scene.choices) {
                        scene.choices.forEach(choice => {
                            const button = document.createElement('button');
                            button.classList.add('choice-button');
                            button.textContent = choice.text;
                            button.onclick = () => {
                                applyEffects(choice.effects);
                                if (choice.narrativeEffect) {
                                    narrativeTextElem.innerHTML += `<p class="italic text-gray-400 mt-4">${choice.narrativeEffect}</p>`;
                                }
                                saveGame(AUTOSAVE_SLOT);
                                renderScene(choice.nextScene);
                            };
                            choicesContainerElem.appendChild(button);
                        });
                    }
                };
                
                // Запускаем печать текста с колбэком
                typeWriterEffect(narrativeTextElem, scene.text, 15, afterTyping);
                
                if (!isLoaded) { // Автосохранение при каждом переходе, кроме загрузки
                    saveGame(AUTOSAVE_SLOT);
                }

                // Убираем оверлей
                transitionOverlay.classList.remove('fade');
            }, 500); // Задержка для перехода
        }
        
        // ///////////////////////////////////////////////////////////////////////////////
        //                                МИНИ-ИГРЫ
        // ///////////////////////////////////////////////////////////////////////////////
        
        function startMiniGame(miniGameConfig) {
             // ... Логика запуска мини-игр ...
             // Пример для дешифратора:
             if (miniGameConfig.type === 'decryptor') {
                miniGameSectionElem.classList.remove('hidden');
                miniGameTitleElem.textContent = 'Дешифратор: Введите Ключ';
                const keyLength = miniGameConfig.correctKey.length;
                miniGameContentElem.innerHTML = `<div id="decryptor-input-group" class="decryptor-input-group"></div>`;
                const inputGroup = document.getElementById('decryptor-input-group');
                
                for (let i = 0; i < keyLength; i++) {
                    const input = document.createElement('input');
                    // ... настройка инпутов
                    inputGroup.appendChild(input);
                }
                
                miniGameSubmitBtn.classList.remove('hidden');
                miniGameSubmitBtn.onclick = () => {
                    // ... логика проверки ключа
                    // endMiniGame(результат, miniGameConfig)
                };
             }
        }
        
        function endMiniGame(success, config) {
            // ... Логика завершения мини-игр ...
        }

        // ///////////////////////////////////////////////////////////////////////////////
        //                                ИНИЦИАЛИЗАЦИЯ
        // ///////////////////////////////////////////////////////////////////////////////
        saveGameButton.addEventListener('click', openSaveLoadModal);
        loadGameButton.addEventListener('click', openSaveLoadModal);
        openJournalButton.addEventListener('click', () => {
            // Логика открытия журнала
            journalEntriesContainer.innerHTML = '';
             let hasEntries = false;
            for (const key in gameState.journal) {
                if (gameState.journal[key].unlocked) {
                    // ...
                    hasEntries = true;
                }
            }
             if (!hasEntries) {
                journalEntriesContainer.innerHTML = '<p class="text-center text-gray-400">Журнал пуст.</p>';
            }
            journalModal.classList.add('visible');
        });

        // Старт игры
        if (!loadGame(AUTOSAVE_SLOT)) {
            renderScene('prologue');
        }
    });
    </script>
</body>
</html>
<!-- КОНЕЦ ФАЙЛА. -->
