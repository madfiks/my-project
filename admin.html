<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Å–∏—Ö–æ–º–æ—Å—Ç –ê–¥–º–∏–Ω–∫–∞</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #2a0000; /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω, –≤–æ–∑–º–æ–∂–Ω–æ, –∫—Ä–∞—Å–Ω—ã–π –¥–ª—è –∞–¥–º–∏–Ω–∫–∏ */
            color: #e0e0e0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –≤–µ—Ä—Ö–Ω–µ–º—É –∫—Ä–∞—é */
            min-height: 100vh;
        }
        .container {
            background-color: #0a0a0a; /* –ï—â–µ —Ç–µ–º–Ω–µ–µ */
            padding: 30px;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.6);
            max-width: 900px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        h1 {
            color: #ff4500; /* –û—Ä–∞–Ω–∂–µ–≤–æ-–∫—Ä–∞—Å–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ */
            text-align: center;
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 1.5rem;
        }
        .section-title {
            color: #e94560; /* –ê–∫—Ü–µ–Ω—Ç–Ω—ã–π —Ü–≤–µ—Ç –¥–ª—è –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ */
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
            border-bottom: 1px solid #3b3b4d;
            padding-bottom: 0.5rem;
        }
        .controls-group {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .control-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            flex-grow: 1;
            min-width: 200px;
        }
        button {
            background-color: #e94560;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out, box-shadow 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            font-size: 1rem;
            text-align: center;
        }
        button:hover {
            background-color: #ff6f88;
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
        }
        button:active {
            background-color: #d1304c;
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        input[type="text"], input[type="number"], select {
            background-color: #16213e;
            border: 1px solid #0f3460;
            padding: 0.75rem;
            border-radius: 0.5rem;
            color: #e0e0e0;
            font-size: 1rem;
            width: 100%;
        }
        .log-output {
            background-color: #0d0d1a;
            border: 1px solid #1a1a2e;
            height: 400px;
            overflow-y: scroll;
            padding: 1rem;
            font-family: monospace;
            font-size: 0.85em;
            color: #a0a0a0;
            border-radius: 0.75rem;
            box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.3);
        }
        .log-entry {
            margin-bottom: 0.3rem;
            word-break: break-all;
        }
        .log-entry.info { color: #a0a0a0; }
        .log-entry.warn { color: #ffeb3b; } /* –ñ–µ–ª—Ç—ã–π */
        .log-entry.error { color: #f44336; } /* –ö—Ä–∞—Å–Ω—ã–π */
        .log-entry.success { color: #4CAF50; } /* –ó–µ–ª–µ–Ω—ã–π */
        .log-entry.debug { color: #87ceeb; } /* –°–≤–µ—Ç–ª–æ-–≥–æ–ª—É–±–æ–π –¥–ª—è DEBUG */

        /* –°—Ç–∏–ª–∏ –¥–ª—è –±–ª–æ–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä–æ–∫–∞ */
        #player-state-display {
            background-color: #16213e;
            padding: 1rem;
            border-radius: 0.75rem;
            border: 1px solid #0f3460;
            margin-top: 1rem;
        }
        #player-state-display h3 {
            color: #00bcd4;
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
        }
        #player-state-display p {
            margin-bottom: 0.3rem;
        }
        #player-journal-display {
            background-color: #16213e;
            padding: 1rem;
            border-radius: 0.75rem;
            border: 1px solid #0f3460;
            margin-top: 1rem;
        }
        #player-journal-display ul {
            list-style: disc;
            margin-left: 1.5rem;
        }
        #player-journal-display li {
            margin-bottom: 0.3rem;
        }
        .journal-entry-admin {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
            background-color: #0f3460;
            padding: 8px;
            border-radius: 5px;
        }
        .journal-entry-admin input[type="checkbox"] {
            margin-right: 5px;
            transform: scale(1.2); /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —á–µ–∫–±–æ–∫—Å –¥–ª—è –ª—É—á—à–µ–π –≤–∏–¥–∏–º–æ—Å—Ç–∏ */
        }
        .journal-entry-admin .journal-content-input {
            flex-grow: 1;
            background-color: #2e2e4a; /* –ë–æ–ª–µ–µ —Å–≤–µ—Ç–ª—ã–π —Ñ–æ–Ω –¥–ª—è –∏–Ω–ø—É—Ç–∞ */
        }
        .journal-entry-admin button {
            padding: 0.3rem 0.8rem;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>–ü–∞–Ω–µ–ª—å –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –ü—Å–∏—Ö–æ–º–æ—Å—Ç</h1>

        <div class="controls-group">
            <div class="control-item">
                <span class="section-title">–°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:</span>
                <span id="connection-status" class="text-gray-400">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
            </div>
            <div class="control-item">
                <span class="section-title">–í—ã–±–æ—Ä –∫–ª–∏–µ–Ω—Ç–∞:</span>
                <select id="client-select" class="mb-2" onchange="selectClient()">
                    <option value="">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤</option>
                </select>
                <button onclick="requestGameState()">–û–±–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞</button>
            </div>
        </div>

        <div class="controls-group">
            <div class="control-item">
                <span class="section-title">–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</span>
                <input type="text" id="admin-message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∏–≥—Ä–æ–∫–æ–≤">
                <button onclick="sendCustomMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</button>
            </div>
            <div class="control-item">
                <span class="section-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–π:</span>
                <button onclick="restartGame()">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É –∑–∞–Ω–æ–≤–æ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞</button>
                <button onclick="fullResetGame()">–ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å –∏–≥—Ä—ã (–£–î–ê–õ–ò–¢ –í–°–ï –°–û–•–†–ê–ù–ï–ù–ò–Ø)</button>
            </div>
        </div>

        <div class="section-title">–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞:</div>
        <div id="player-state-display">
            <p><strong>–¢–µ–∫—É—â–∞—è —Å—Ü–µ–Ω–∞:</strong> <span id="current-scene-display">N/A</span></p>
            <p><strong>–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:</strong></p>
            <ul>
                <li>–õ–æ–≥–∏–∫–∞: <span id="display-logic">N/A</span></li>
                <li>–≠–º–ø–∞—Ç–∏—è: <span id="display-empathy">N/A</span></li>
                <li>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: <span id="display-sync">N/A</span></li>
            </ul>
            <p><strong>–†–µ–ø—É—Ç–∞—Ü–∏—è:</strong></p>
            <ul>
                <li>–ù–æ–≤–∞ –õ–∞–±: <span id="display-nova-lab-rep">N/A</span></li>
                <li>–ü—Ä–∏–∑—Ä–∞–∫–∏: <span id="display-ghosts-rep">N/A</span></li>
                <li>–†–∞—Ñ–∏: <span id="display-rafi-rep">N/A</span></li>
            </ul>
            <p><strong>–°—á–µ—Ç—á–∏–∫ —Å–µ–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø—É—Ç–∏:</strong> <span id="display-secret-path-counter">N/A</span></p>
            <p><strong>–ù–æ–≤–∞ –õ–∞–± –≤—Ä–∞–∂–¥–µ–±–Ω–∞:</strong> <span id="display-nova-lab-hostile">N/A</span></p>
        </div>

        <div class="section-title">–ó–∞–ø–∏—Å–∏ –∂—É—Ä–Ω–∞–ª–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞:</div>
        <div id="player-journal-display">
            <p id="journal-empty-message">–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∑–∞–ø–∏—Å–∏ –∂—É—Ä–Ω–∞–ª–∞.</p>
            <div id="journal-entries-editor">
                </div>
            <button onclick="saveJournalChanges()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –∂—É—Ä–Ω–∞–ª–∞</button>
        </div>


        <div class="controls-group">
            <div class="control-item">
                <span class="section-title">–ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏):</span>
                <select id="stat-select" class="mb-2">
                    <option value="logic">–õ–æ–≥–∏–∫–∞</option>
                    <option value="empathy">–≠–º–ø–∞—Ç–∏—è</option>
                    <option value="synchronization">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</option>
                    <option value="reputationNovaLab">–†–µ–ø—É—Ç–∞—Ü–∏—è –ù–æ–≤–∞ –õ–∞–±</option>
                    <option value="reputationGhosts">–†–µ–ø—É—Ç–∞—Ü–∏—è –ü—Ä–∏–∑—Ä–∞–∫–æ–≤</option>
                    <option value="reputationRafi">–†–µ–ø—É—Ç–∞—Ü–∏—è –†–∞—Ñ–∏</option>
                    <option value="secretPathCounter">–°—á–µ—Ç—á–∏–∫ –°–µ–∫—Ä–µ—Ç–Ω–æ–≥–æ –ü—É—Ç–∏</option>
                    <option value="novaLabIsHostile">–ù–æ–≤–∞ –õ–∞–± –≤—Ä–∞–∂–¥–µ–±–Ω–∞</option>
                </select>
                <input type="text" id="stat-value-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ (—á–∏—Å–ª–æ –∏–ª–∏ true/false)">
                <button onclick="modifyStat()">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫—É</button>
            </div>
            <div class="control-item">
                <span class="section-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ü–µ–Ω–∞–º–∏:</span>
                <input type="text" id="scene-id-input" placeholder="–í–≤–µ–¥–∏—Ç–µ ID —Å—Ü–µ–Ω—ã (e.g., prologue)">
                <button onclick="setScene()">–ü–µ—Ä–µ–π—Ç–∏ –∫ —Å—Ü–µ–Ω–µ</button>
            </div>
        </div>

        <div class="controls-group">
            <div class="control-item">
                <span class="section-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∏–Ω–∏-–∏–≥—Ä–∞–º–∏:</span>
                <select id="mini-game-type-select" class="mb-2">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∏–Ω–∏-–∏–≥—Ä—É</option>
                    <option value="memoryHack">–í–∑–ª–æ–º –ü–∞–º—è—Ç–∏</option>
                    <option value="decryptor">–î–µ—à–∏—Ñ—Ä–∞—Ç–æ—Ä</option>
                    <option value="energyFlow">–ü–æ—Ç–æ–∫ –≠–Ω–µ—Ä–≥–∏–∏</option>
                    <option value="laserMaze">–õ–∞–∑–µ—Ä–Ω—ã–π –õ–∞–±–∏—Ä–∏–Ω—Ç</option>
                </select>
                <button onclick="forceStartMiniGame()">–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –Ω–∞—á–∞—Ç—å –º–∏–Ω–∏-–∏–≥—Ä—É</button>
                <div class="flex gap-2 mt-2">
                    <button onclick="skipMiniGame(true)">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å (–£—Å–ø–µ—Ö)</button>
                    <button onclick="skipMiniGame(false)">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å (–ü—Ä–æ–≤–∞–ª)</button>
                </div>
            </div>
        </div>

        <div class="section-title">–õ–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞:</div>
        <div class="log-output" id="logs">
            –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...
        </div>
    </div>

    <script>
        const socket = new WebSocket("ws://localhost:8080");
        const logsDiv = document.getElementById('logs');
        const connectionStatusSpan = document.getElementById('connection-status');
        const adminMessageInput = document.getElementById('admin-message-input');
        const statSelect = document.getElementById('stat-select');
        const statValueInput = document.getElementById('stat-value-input');
        const sceneIdInput = document.getElementById('scene-id-input');
        const miniGameTypeSelect = document.getElementById('mini-game-type-select');
        const clientSelect = document.getElementById('client-select');

        // –≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä–æ–∫–∞
        const currentSceneDisplay = document.getElementById('current-scene-display');
        const displayLogic = document.getElementById('display-logic');
        const displayEmpathy = document.getElementById('display-empathy');
        const displaySync = document.getElementById('display-sync');
        const displayNovaLabRep = document.getElementById('display-nova-lab-rep');
        const displayGhostsRep = document.getElementById('display-ghosts-rep');
        const displayRafiRep = document.getElementById('display-rafi-rep');
        const displaySecretPathCounter = document.getElementById('display-secret-path-counter');
        const displayNovaLabHostile = document.getElementById('display-nova-lab-hostile');
        const journalEntriesEditor = document.getElementById('journal-entries-editor');
        const journalEmptyMessage = document.getElementById('journal-empty-message');

        // –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞, –ø–æ–ª—É—á–µ–Ω–Ω–æ–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
        let selectedPlayerState = null;
        // ID –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
        let selectedClientId = null;

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ –≤ –æ–∫–Ω–æ –ª–æ–≥–æ–≤
        function addLog(message, type = 'info') {
            const logEntry = document.createElement('div');
            logEntry.classList.add('log-entry', type);
            logEntry.innerHTML = `[${new Date().toLocaleTimeString('ru-RU')}] ${message}`; // –í—Ä–µ–º—è –≤ —Ä—É—Å—Å–∫–æ–π –ª–æ–∫–∞–ª–∏
            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä–æ–∫–∞
        function updatePlayerStateUI(state) {
            selectedPlayerState = state; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∂—É—Ä–Ω–∞–ª–∞

            currentSceneDisplay.textContent = state.currentScene;
            displayLogic.textContent = state.logic;
            displayEmpathy.textContent = state.empathy;
            displaySync.textContent = state.synchronization;
            displayNovaLabRep.textContent = state.reputationNovaLab;
            displayGhostsRep.textContent = state.reputationGhosts;
            displayRafiRep.textContent = state.reputationRafi;
            displaySecretPathCounter.textContent = state.secretPathCounter;
            displayNovaLabHostile.textContent = state.novaLabIsHostile ? '–î–∞' : '–ù–µ—Ç';

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä –∂—É—Ä–Ω–∞–ª–∞
            journalEntriesEditor.innerHTML = '';
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ state.journal –∏ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ–Ω –æ–±—ä–µ–∫—Ç–æ–º
            const allJournalEntries = state.journal ? Object.entries(state.journal) : [];


            if (allJournalEntries.length > 0) {
                journalEmptyMessage.classList.add('hidden');
                allJournalEntries.forEach(([id, entry]) => {
                    const entryDiv = document.createElement('div');
                    entryDiv.classList.add('journal-entry-admin');
                    entryDiv.innerHTML = `
                        <input type="checkbox" id="journal-unlocked-${id}" data-id="${id}" class="journal-checkbox" ${entry.unlocked ? 'checked' : ''}>
                        <label for="journal-unlocked-${id}">${entry.title}:</label>
                        <input type="text" class="journal-content-input" data-id="${id}" value="${entry.content.replace(/"/g, '&quot;')}" placeholder="–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∑–∞–ø–∏—Å–∏">
                    `;
                    journalEntriesEditor.appendChild(entryDiv);
                });
            } else {
                journalEmptyMessage.classList.remove('hidden');
            }
        }

        socket.onopen = () => {
            connectionStatusSpan.textContent = "–ü–æ–¥–∫–ª—é—á–µ–Ω–æ üü¢";
            addLog("–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –∏–≥—Ä–æ–≤–æ–º—É —Å–µ—Ä–≤–µ—Ä—É.", 'success');
            // –£–≤–µ–¥–æ–º–ª—è–µ–º —Å–µ—Ä–≤–µ—Ä, —á—Ç–æ —ç—Ç–æ –∞–¥–º–∏–Ω–∫–∞ (–±–µ–∑ clientId –≤ –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ)
            socket.send(JSON.stringify({ type: 'admin_connect' }));
        };

        socket.onmessage = (event) => {
            const message = JSON.parse(event.data);
            addLog(`–ü–æ–ª—É—á–µ–Ω–æ: ${JSON.stringify(message)}`);

            switch (message.type) {
                case 'log_entry': // –ù–æ–≤—ã–π —Ç–∏–ø –¥–ª—è –ª–æ–≥–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
                    addLog(message.message, message.level.toLowerCase());
                    break;
                case 'player_state_data':
                    updatePlayerStateUI(message.state);
                    // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª—É—á–µ–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º
                    if (selectedClientId === message.state.clientId) {
                        addLog(`–°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ ${message.state.clientId} –æ–±–Ω–æ–≤–ª–µ–Ω–æ.`, 'info');
                    }
                    break;
                case 'active_clients_list':
                    updateClientList(message.clients);
                    addLog(`–°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω: ${message.clients.join(', ')}`, 'info');
                    break;
                case 'admin_ack':
                    addLog(`–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${message.message}`, 'success');
                    // –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è, –µ—Å–ª–∏ —ç—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞, –æ–±–Ω–æ–≤–∏–º –µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                    if (selectedClientId) {
                        requestGameState();
                    }
                    break;
                case 'admin_error':
                    addLog(`–û—à–∏–±–∫–∞ –∞–¥–º–∏–Ω–∫–∏: ${message.message}`, 'error');
                    break;
                case 'save_ack': // –≠—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –º–æ–≥—É—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –Ω–∞–ø—Ä—è–º—É—é –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞, –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Ç–æ–∂–µ –∞–¥–º–∏–Ω–∫–∞
                case 'error':
                case 'server_broadcast':
                    // –≠—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –º–æ–≥—É—Ç –ø—Ä–∏–π—Ç–∏, –µ—Å–ª–∏ –∞–¥–º–∏–Ω–∫–∞ —Å–∞–º–∞ —è–≤–ª—è–µ—Ç—Å—è –∫–ª–∏–µ–Ω—Ç–æ–º –∏–≥—Ä—ã
                    // –ò–ª–∏ –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä —à–∏—Ä–æ–∫–æ–≤–µ—â–∞—Ç–µ–ª—å–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏—Ö –≤—Å–µ–º WS-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º
                    break;
                default:
                    addLog(`–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ/–æ–±—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${JSON.stringify(message)}`, 'info');
            }
        };

        socket.onclose = () => {
            connectionStatusSpan.textContent = "–û—Ç–∫–ª—é—á–µ–Ω–æ üî¥";
            addLog("–û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞.", 'error');
        };

        socket.onerror = (error) => {
            connectionStatusSpan.textContent = "–û—à–∏–±–∫–∞ ‚ùå";
            addLog(`–û—à–∏–±–∫–∞ WebSocket: ${error.message}`, 'error');
        };

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        function sendAdminCommand(commandType, payload = {}) {
            // –î–æ–±–∞–≤–ª—è–µ–º selectedClientId –∫ payload, –µ—Å–ª–∏ –æ–Ω –≤—ã–±—Ä–∞–Ω
            if (selectedClientId) {
                payload.targetClientId = selectedClientId;
            }
            if (socket.readyState === WebSocket.OPEN) {
                const message = {
                    type: 'admin_command',
                    command: commandType,
                    payload: payload
                };
                socket.send(JSON.stringify(message));
                addLog(`–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${JSON.stringify(message)}`, 'debug');
            } else {
                addLog("–°–µ—Ä–≤–µ—Ä –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω. –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É.", 'warn');
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ –≤—ã–ø–∞–¥–∞—é—â–µ–º —Å–ø–∏—Å–∫–µ
        function updateClientList(clients) {
            clientSelect.innerHTML = '';
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏—é "–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤" –∏–ª–∏ "–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞"
            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = "--- –í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ ---";
            clientSelect.appendChild(defaultOption);

            if (clients.length === 0) {
                selectedClientId = null;
                updatePlayerStateUI({ // –û—á–∏—â–∞–µ–º UI —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä–æ–∫–∞
                    clientId: 'N/A', currentScene: 'N/A', logic: 'N/A', empathy: 'N/A', synchronization: 'N/A',
                    reputationNovaLab: 'N/A', reputationGhosts: 'N/A', reputationRafi: 'N/A',
                    secretPathCounter: 'N/A', novaLabIsHostile: 'N/A', journal: {}
                });
                journalEmptyMessage.classList.remove('hidden');
                return;
            }

            clients.forEach(id => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = id;
                clientSelect.appendChild(option);
            });

            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç –∏–ª–∏ –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π
            if (selectedClientId && clients.includes(selectedClientId)) {
                clientSelect.value = selectedClientId;
                // –ù–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –æ–Ω–æ –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–æ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞
                // –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞, —Ç–∞–∫ –∫–∞–∫ —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏—à–ª–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞.
            } else if (clients.length > 0) {
                selectedClientId = clients[0];
                clientSelect.value = selectedClientId;
                requestGameState(); // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
            }
        }

        // –ü—Ä–∏ –≤—ã–±–æ—Ä–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ —Å–ø–∏—Å–∫–∞
        function selectClient() {
            selectedClientId = clientSelect.value;
            if (selectedClientId) {
                requestGameState(); // –ó–∞–ø—Ä–æ—Å–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
            } else {
                // –û—á–∏—Å—Ç–∏—Ç—å UI —Å–æ—Å—Ç–æ—è–Ω–∏—è, –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ
                updatePlayerStateUI({
                    clientId: 'N/A', currentScene: 'N/A', logic: 'N/A', empathy: 'N/A', synchronization: 'N/A',
                    reputationNovaLab: 'N/A', reputationGhosts: 'N/A', reputationRafi: 'N/A',
                    secretPathCounter: 'N/A', novaLabIsHostile: 'N/A', journal: {}
                });
                journalEmptyMessage.classList.remove('hidden');
            }
        }


        // –ö–æ–º–∞–Ω–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ –∞–¥–º–∏–Ω –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å
        function requestGameState() {
            if (!selectedClientId) {
                addLog("–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è.", 'warn');
                return;
            }
            sendAdminCommand('request_player_state');
        }

        function restartGame() {
            if (!selectedClientId) {
                addLog("–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –∏–≥—Ä—ã.", 'warn');
                return;
            }
            if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∏–≥—Ä—É –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ "${selectedClientId}"?`)) {
                sendAdminCommand('restart_game');
            }
        }

        function fullResetGame() {
            if (confirm("–í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ —É–¥–∞–ª–∏—Ç –í–°–ï —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–≥—Ä—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∏ —Å–±—Ä–æ—Å–∏—Ç —Ç–µ–∫—É—â—É—é –∏–≥—Ä—É –¥–ª—è –í–°–ï–• –∫–ª–∏–µ–Ω—Ç–æ–≤! –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?")) {
                sendAdminCommand('full_reset_game');
            }
        }

        function sendCustomMessage() {
            const message = adminMessageInput.value;
            if (message) {
                sendAdminCommand('broadcast_message', { message: message }); // –ü–µ—Ä–µ–¥–∞–µ–º –æ–±—ä–µ–∫—Ç —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º
                adminMessageInput.value = '';
            } else {
                addLog("–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏.", 'warn');
            }
        }

        function modifyStat() {
            if (!selectedClientId) {
                addLog("–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.", 'warn');
                return;
            }
            const stat = statSelect.value;
            let value = statValueInput.value;

            if (!stat || value === "") {
                addLog("–í—ã–±–µ—Ä–∏—Ç–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫—É –∏ –≤–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ.", 'warn');
                return;
            }

            if (stat === 'novaLabIsHostile') {
                if (value.toLowerCase() === 'true') {
                    value = true;
                } else if (value.toLowerCase() === 'false') {
                    value = false;
                } else {
                    addLog("–î–ª—è '–ù–æ–≤–∞ –õ–∞–± –≤—Ä–∞–∂–¥–µ–±–Ω–∞' –≤–≤–µ–¥–∏—Ç–µ 'true' –∏–ª–∏ 'false'.", 'error');
                    return;
                }
            } else {
                value = parseFloat(value);
                if (isNaN(value)) {
                    addLog("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.", 'error');
                    return;
                }
            }

            sendAdminCommand('modify_stat', { stat: stat, value: value });
            statValueInput.value = '';
        }

        function setScene() {
            if (!selectedClientId) {
                addLog("–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ü–µ–Ω—ã.", 'warn');
                return;
            }
            const sceneId = sceneIdInput.value.trim();
            if (sceneId) {
                sendAdminCommand('set_scene', { sceneId: sceneId });
                sceneIdInput.value = '';
            } else {
                addLog("–í–≤–µ–¥–∏—Ç–µ ID —Å—Ü–µ–Ω—ã.", 'warn');
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∂—É—Ä–Ω–∞–ª–∞
        function saveJournalChanges() {
            if (!selectedClientId || !selectedPlayerState) {
                addLog("–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –∂—É—Ä–Ω–∞–ª–∞.", 'warn');
                return;
            }

            const changes = {};
            journalEntriesEditor.querySelectorAll('.journal-entry-admin').forEach(entryDiv => {
                const checkbox = entryDiv.querySelector('.journal-checkbox');
                const input = entryDiv.querySelector('.journal-content-input');
                const entryId = input.dataset.id;

                const originalEntry = selectedPlayerState.journal[entryId];
                const newContent = input.value;
                const newUnlocked = checkbox.checked;

                if (originalEntry.content !== newContent || originalEntry.unlocked !== newUnlocked) {
                    changes[entryId] = {
                        content: newContent,
                        unlocked: newUnlocked
                    };
                }
            });

            if (Object.keys(changes).length > 0) {
                sendAdminCommand('modify_journal_entries', { changes: changes });
            } else {
                addLog("–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –∂—É—Ä–Ω–∞–ª–µ.", 'info');
            }
        }


        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Å—Ç–∞—Ä—Ç –º–∏–Ω–∏-–∏–≥—Ä—ã
        function forceStartMiniGame() {
            if (!selectedClientId) {
                addLog("–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –º–∏–Ω–∏-–∏–≥—Ä—ã.", 'warn');
                return;
            }
            const gameType = miniGameTypeSelect.value;
            if (gameType) {
                sendAdminCommand('start_mini_game', { gameType: gameType });
            } else {
                addLog("–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –º–∏–Ω–∏-–∏–≥—Ä—ã –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞.", 'warn');
            }
        }

        // –ü—Ä–æ–ø—É—Å–∫ –º–∏–Ω–∏-–∏–≥—Ä—ã
        function skipMiniGame(success) {
            if (!selectedClientId) {
                addLog("–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞ –º–∏–Ω–∏-–∏–≥—Ä—ã.", 'warn');
                return;
            }
            if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ç–µ–∫—É—â—É—é –º–∏–Ω–∏-–∏–≥—Ä—É –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ "${selectedClientId}" —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º "${success ? '–£—Å–ø–µ—Ö' : '–ü—Ä–æ–≤–∞–ª'}"?`)) {
                sendAdminCommand('skip_mini_game', { success: success });
            }
        }
    </script>
</body>
</html>